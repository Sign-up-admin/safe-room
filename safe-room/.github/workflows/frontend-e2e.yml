name: Frontend E2E Tests

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - front
          - admin
      browser:
        description: 'Browser to use'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - user-journey
          - admin-journey
          - integration
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œå®Œæ•´E2Eæµ‹è¯•
    - cron: '0 8 * * 1'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'springboot1ngh61a2/src/main/resources/front/tests/e2e/**'
      - 'springboot1ngh61a2/src/main/resources/admin/tests/e2e/**'
      - 'springboot1ngh61a2/src/main/resources/front/tests/utils/**'
      - 'springboot1ngh61a2/src/main/resources/admin/tests/utils/**'

jobs:
  e2e-tests:
    name: E2E Tests - ${{ matrix.project.name }} (${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          # Fronté¡¹ç›®æµ‹è¯•çŸ©é˜µ
          - project: { name: front, path: springboot1ngh61a2/src/main/resources/front/front }
            browser: chromium
          - project: { name: front, path: springboot1ngh61a2/src/main/resources/front/front }
            browser: firefox
          - project: { name: front, path: springboot1ngh61a2/src/main/resources/front/front }
            browser: webkit
          # Adminé¡¹ç›®æµ‹è¯•çŸ©é˜µ
          - project: { name: admin, path: springboot1ngh61a2/src/main/resources/admin/admin }
            browser: chromium
          - project: { name: admin, path: springboot1ngh61a2/src/main/resources/admin/admin }
            browser: firefox

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project.path }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.project.path }}
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ${{ matrix.project.path }}
        run: npx playwright install --with-deps

      - name: Create test environment file
        working-directory: ${{ matrix.project.path }}
        run: |
          echo "E2E_PORT=808${{ matrix.project.name == 'front' && '2' || '1' }}" > .env.e2e
          echo "E2E_BASE_URL=http://127.0.0.1:808${{ matrix.project.name == 'front' && '2' || '1' }}" >> .env.e2e
          echo "E2E_BROWSER=${{ matrix.browser }}" >> .env.e2e

      - name: Run E2E tests
        working-directory: ${{ matrix.project.path }}
        run: |
          if [ "${{ inputs.test_suite }}" = "user-journey" ]; then
            npx playwright test tests/e2e/user-journey/ --project=${{ matrix.browser }}
          elif [ "${{ inputs.test_suite }}" = "admin-journey" ]; then
            npx playwright test tests/e2e/admin-journey/ --project=${{ matrix.browser }}
          elif [ "${{ inputs.test_suite }}" = "integration" ]; then
            npx playwright test tests/e2e/integration/ --project=${{ matrix.browser }}
          else
            npx playwright test --project=${{ matrix.browser }}
          fi
        continue-on-error: false
        env:
          E2E_BROWSER: ${{ matrix.browser }}
          NODE_ENV: test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.project.name }}-${{ matrix.browser }}-${{ github.run_id }}
          path: ${{ matrix.project.path }}/playwright-report
          retention-days: 14

      - name: Upload test videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-videos-${{ matrix.project.name }}-${{ matrix.browser }}-${{ github.run_id }}
          path: ${{ matrix.project.path }}/test-results/videos
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots-${{ matrix.project.name }}-${{ matrix.browser }}-${{ github.run_id }}
          path: ${{ matrix.project.path }}/test-results/screenshots
          retention-days: 14

  e2e-smoke-tests:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install front dependencies
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: npm ci

      - name: Install admin dependencies
        working-directory: springboot1ngh61a2/src/main/resources/admin/admin
        run: npm ci

      - name: Install Playwright browsers (front)
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: npx playwright install --with-deps

      - name: Install Playwright browsers (admin)
        working-directory: springboot1ngh61a2/src/main/resources/admin/admin
        run: npx playwright install --with-deps

      - name: Run front smoke tests
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: npx playwright test tests/e2e/auth.spec.ts tests/e2e/pages.spec.ts --project=chromium --timeout=60000
        continue-on-error: true

      - name: Run admin smoke tests
        working-directory: springboot1ngh61a2/src/main/resources/admin/admin
        run: npx playwright test tests/e2e/admin-journey/login-and-permissions.spec.ts --project=chromium --timeout=60000
        continue-on-error: true

  performance-tests:
    name: E2E Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.schedule != null || contains(github.event.inputs.test_suite, 'performance')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install front dependencies
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: npm ci

      - name: Install Playwright browsers
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: npx playwright install chromium

      - name: Run performance tests
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: |
          echo "Running performance tests..."
          npx playwright test tests/e2e/user-journey/registration-to-login.spec.ts --project=chromium --reporter=json > performance-results.json
          npx playwright test tests/e2e/user-journey/membership-purchase.spec.ts --project=chromium --reporter=json >> performance-results.json

      - name: Generate performance report
        working-directory: springboot1ngh61a2/src/main/resources/front/front
        run: |
          echo "# ðŸš€ E2E Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat performance-results.json | jq '.suites[0].specs[0].tests[0]' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Performance data parsing failed" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  test-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, e2e-smoke-tests, performance-tests]
    if: always()

    steps:
      - name: Generate E2E test summary
        run: |
          echo "# ðŸ§ª Frontend E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Test Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Full E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || needs.e2e-tests.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Partial' }} | Multi-browser matrix tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.e2e-smoke-tests.result == 'success' && 'âœ… Passed' || needs.e2e-smoke-tests.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} | Critical path validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || needs.performance-tests.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} | Load time and responsiveness |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Trigger information
          echo "## ðŸš€ Test Trigger" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **Project**: ${{ inputs.project }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Browser**: ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Test Suite**: ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "- **Schedule**: Weekly Monday 8:00 AM UTC" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“Š Browser Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Chromium (Chrome/Edge)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… WebKit (Safari)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“ Test Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Reports**: \`e2e-results-*-${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Videos**: \`e2e-videos-*-${{ github.run_id }}\` (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "- **Screenshots**: \`e2e-screenshots-*-${{ github.run_id }}\` (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸŽ¯ Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "### Front Project" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… User registration and login" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Membership card purchase" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Course booking" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Private coaching booking (pending)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Personal center operations (pending)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Admin Project" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Admin login and permissions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… User management (CRUD)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Course management (CRUD)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Coach management (pending)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Booking management (pending)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Membership management (pending)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ”„ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Complete remaining test suites" >> $GITHUB_STEP_SUMMARY
          echo "- Add cross-system integration tests" >> $GITHUB_STEP_SUMMARY
          echo "- Implement visual regression testing" >> $GITHUB_STEP_SUMMARY
          echo "- Set up test performance monitoring" >> $GITHUB_STEP_SUMMARY
