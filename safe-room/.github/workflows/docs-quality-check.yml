name: Documentation Quality Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-quality-check.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-quality-check.yml'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - quality
          - links
          - format

env:
  NODE_VERSION: '18'

jobs:
  docs-quality-check:
    name: Documentation Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Get changed documentation files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # è·å–PRä¸­å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^docs/' || true)
        else
          # è·å–æ¨é€ä¸­å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only HEAD~1 | grep '^docs/' || true)
        fi

        # å¦‚æœæ²¡æœ‰å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶ï¼Œä½¿ç”¨æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶
        if [ -z "$CHANGED_FILES" ]; then
          CHANGED_FILES=$(find docs -name "*.md" -type f | head -10)
          echo "No changed docs found, checking recent files"
        fi

        echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "ğŸ“„ å°†æ£€æŸ¥ä»¥ä¸‹æ–‡æ¡£æ–‡ä»¶:"
        echo "$CHANGED_FILES"

    - name: Documentation quality check
      id: quality-check
      run: |
        echo "ğŸ” å¼€å§‹æ–‡æ¡£è´¨é‡æ£€æŸ¥..."

        # åˆ›å»ºæ£€æŸ¥ç»“æœç›®å½•
        mkdir -p docs/reports/quality/checks

        # è¿è¡Œæ–‡æ¡£è´¨é‡æ£€æŸ¥
        if [ "${{ inputs.check_type }}" = "quality" ] || [ "${{ inputs.check_type }}" = "all" ]; then
          echo "ğŸ“‹ æ£€æŸ¥æ–‡æ¡£è´¨é‡..."
          npm run docs:check > docs/reports/quality/checks/quality-check.log 2>&1 || true
        fi

        # æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§
        if [ "${{ inputs.check_type }}" = "links" ] || [ "${{ inputs.check_type }}" = "all" ]; then
          echo "ğŸ”— æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§..."
          node docs/scripts/frontend-doc-checker.js --links-only > docs/reports/quality/checks/link-check.log 2>&1 || true
        fi

        # æ£€æŸ¥æ ¼å¼è§„èŒƒ
        if [ "${{ inputs.check_type }}" = "format" ] || [ "${{ inputs.check_type }}" = "all" ]; then
          echo "ğŸ“ æ£€æŸ¥æ ¼å¼è§„èŒƒ..."
          node docs/scripts/frontend-doc-checker.js --format-only > docs/reports/quality/checks/format-check.log 2>&1 || true
        fi

        echo "âœ… è´¨é‡æ£€æŸ¥å®Œæˆ"

    - name: Analyze check results
      id: analyze-results
      run: |
        echo "ğŸ“Š åˆ†ææ£€æŸ¥ç»“æœ..."

        # ç»Ÿè®¡é”™è¯¯å’Œè­¦å‘Šæ•°é‡
        ERROR_COUNT=$(grep -r "âŒ\|é”™è¯¯\|Error" docs/reports/quality/checks/ | wc -l)
        WARNING_COUNT=$(grep -r "âš ï¸\|è­¦å‘Š\|Warning" docs/reports/quality/checks/ | wc -l)

        echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
        echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT

        echo "ğŸ“ˆ æ£€æŸ¥ç»“æœç»Ÿè®¡:"
        echo "  é”™è¯¯æ•°é‡: $ERROR_COUNT"
        echo "  è­¦å‘Šæ•°é‡: $WARNING_COUNT"

        # åˆ¤æ–­æ˜¯å¦é€šè¿‡
        if [ "$ERROR_COUNT" -gt 0 ]; then
          echo "âŒ å‘ç°ä¸¥é‡é”™è¯¯ï¼Œæ£€æŸ¥å¤±è´¥"
          echo "passed=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ£€æŸ¥é€šè¿‡"
          echo "passed=true" >> $GITHUB_OUTPUT
        fi

    - name: Generate quality report
      if: always()
      run: |
        echo "ğŸ“‹ ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."

        # ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        cat > docs/reports/quality/checks/summary-report.md << EOF
        # æ–‡æ¡£è´¨é‡æ£€æŸ¥æŠ¥å‘Š

        **æ£€æŸ¥æ—¶é—´**: $(date)
        **æäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref }}
        **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}

        ## æ£€æŸ¥ç»“æœ

        - é”™è¯¯æ•°é‡: ${{ steps.analyze-results.outputs.error_count }}
        - è­¦å‘Šæ•°é‡: ${{ steps.analyze-results.outputs.warning_count }}
        - æ£€æŸ¥çŠ¶æ€: ${{ steps.analyze-results.outputs.passed == 'true' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}

        ## è¯¦ç»†ç»“æœ

        ### è´¨é‡æ£€æŸ¥
        \`\`\`
        $(cat docs/reports/quality/checks/quality-check.log 2>/dev/null || echo "æ— è´¨é‡æ£€æŸ¥æ—¥å¿—")
        \`\`\`

        ### é“¾æ¥æ£€æŸ¥
        \`\`\`
        $(cat docs/reports/quality/checks/link-check.log 2>/dev/null || echo "æ— é“¾æ¥æ£€æŸ¥æ—¥å¿—")
        \`\`\`

        ### æ ¼å¼æ£€æŸ¥
        \`\`\`
        $(cat docs/reports/quality/checks/format-check.log 2>/dev/null || echo "æ— æ ¼å¼æ£€æŸ¥æ—¥å¿—")
        \`\`\`

        ---
        *æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
        EOF

    - name: Upload check results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docs-quality-check-results-${{ github.run_number }}
        path: docs/reports/quality/checks/
        retention-days: 30

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // è¯»å–æ£€æŸ¥ç»“æœ
          let summaryContent = '';
          try {
            summaryContent = fs.readFileSync('docs/reports/quality/checks/summary-report.md', 'utf8');
          } catch (error) {
            summaryContent = 'æ— æ³•è¯»å–æ£€æŸ¥æŠ¥å‘Š';
          }

          // åˆ›å»ºPRè¯„è®º
          const comment = `## ğŸ“‹ æ–‡æ¡£è´¨é‡æ£€æŸ¥ç»“æœ

          ${summaryContent}

          ---
          è¯¦ç»†ç»“æœè¯·æŸ¥çœ‹ [æ£€æŸ¥äº§ç‰©](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Fail on quality issues
      if: steps.analyze-results.outputs.passed == 'false'
      run: |
        echo "âŒ æ–‡æ¡£è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œå‘ç°ä¸¥é‡é—®é¢˜"
        echo "è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜åé‡æ–°æäº¤:"
        echo ""
        cat docs/reports/quality/checks/quality-check.log 2>/dev/null || echo "æ— è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        exit 1

    - name: Success notification
      if: steps.analyze-results.outputs.passed == 'true'
      run: |
        echo "ğŸ‰ æ–‡æ¡£è´¨é‡æ£€æŸ¥é€šè¿‡ï¼"
        if [ "${{ steps.analyze-results.outputs.warning_count }}" -gt 0 ]; then
          echo "âš ï¸ å‘ç° ${{ steps.analyze-results.outputs.warning_count }} ä¸ªè­¦å‘Šï¼Œå»ºè®®å…³æ³¨ä½†ä¸å½±å“åˆå¹¶"
        fi

  docs-lifecycle-check:
    name: Documentation Lifecycle Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check documentation lifecycle
      run: |
        echo "ğŸ”„ æ£€æŸ¥æ–‡æ¡£ç”Ÿå‘½å‘¨æœŸçŠ¶æ€..."

        # è·å–å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶
        CHANGED_DOCS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^docs/.*\.md$' || true)

        if [ -n "$CHANGED_DOCS" ]; then
          echo "ğŸ“„ å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶:"
          echo "$CHANGED_DOCS"

          # æ£€æŸ¥æ–‡æ¡£çŠ¶æ€
          echo "$CHANGED_DOCS" | while read -r file; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              # æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…éœ€çš„å¤´éƒ¨ä¿¡æ¯
              if ! head -20 "$file" | grep -q "^status:"; then
                echo "âš ï¸ è­¦å‘Š: $file ç¼ºå°‘çŠ¶æ€ä¿¡æ¯"
              fi

              # æ£€æŸ¥æœ€åæ›´æ–°æ—¥æœŸ
              if ! head -20 "$file" | grep -q "^last_updated:"; then
                echo "âš ï¸ è­¦å‘Š: $file ç¼ºå°‘æœ€åæ›´æ–°æ—¥æœŸ"
              fi
            fi
          done
        else
          echo "â„¹ï¸ æ²¡æœ‰å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶"
        fi

  docs-index-update:
    name: Update Documentation Index
    runs-on: ubuntu-latest
    needs: [docs-quality-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Update documentation indexes
      run: |
        echo "ğŸ“Š æ›´æ–°æ–‡æ¡£ç´¢å¼•..."

        # æ›´æ–°æ‰€æœ‰æ–‡æ¡£ç´¢å¼•
        npm run docs:index -- --all

        echo "âœ… æ–‡æ¡£ç´¢å¼•æ›´æ–°å®Œæˆ"

    - name: Check for index changes
      id: check-changes
      run: |
        if git diff --quiet docs/; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ–‡æ¡£ç´¢å¼•æ— å˜æ›´"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ–‡æ¡£ç´¢å¼•æœ‰å˜æ›´"
        fi

    - name: Commit index updates
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        echo "ğŸ’¾ æäº¤ç´¢å¼•æ›´æ–°..."

        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add docs/
        git commit -m "docs: update documentation indexes [automated]" || echo "æ— å˜æ›´éœ€è¦æäº¤"

        # æ¨é€åˆ°mainåˆ†æ”¯
        git push origin main

        echo "âœ… ç´¢å¼•æ›´æ–°å·²æäº¤"
