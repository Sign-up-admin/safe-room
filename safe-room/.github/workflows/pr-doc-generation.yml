name: PR Documentation Generation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

jobs:
  analyze-pr:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze PR changes
        id: analyze
        run: |
          echo "ğŸ” Analyzing PR #${{ github.event.pull_request.number }}"

          # è¿è¡ŒPRæ–‡æ¡£ç”Ÿæˆå™¨
          node docs/scripts/pr-doc-generator.js \
            --pr-number ${{ github.event.pull_request.number }} \
            --output docs/generated/pr-${{ github.event.pull_request.number }}

      - name: Generate documentation with AI
        id: generate-docs
        run: |
          echo "ğŸ¤– Generating AI-powered documentation"

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export CLAUDE_API_KEY="${{ secrets.CLAUDE_API_KEY }}"
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"

          # ç”ŸæˆAPIæ–‡æ¡£
          if [ -d "springboot1ngh61a2/src/main/java" ]; then
            echo "ğŸ“š Generating API documentation..."
            npm run docs:ai-batch springboot1ngh61a2/src/main/java docs/generated/api || true
          fi

          # ç”Ÿæˆç»„ä»¶æ–‡æ¡£
          if [ -d "springboot1ngh61a2/src/main/resources/front/front/src" ]; then
            echo "ğŸ§© Generating component documentation..."
            npm run docs:ai-batch springboot1ngh61a2/src/main/resources/front/front/src/components docs/generated/components || true
          fi

        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Validate documentation
        id: validate
        run: |
          echo "âœ… Validating generated documentation"
          npm run docs:check || true

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-documentation-${{ github.event.pull_request.number }}
          path: |
            docs/generated/
            docs/technical/api/
            docs/technical/frontend/components/
          retention-days: 30

      - name: Comment PR with documentation summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // è¯»å–ç”Ÿæˆçš„PRæ€»ç»“
            const summaryPath = `docs/generated/pr-${{ github.event.pull_request.number }}/pr-summary-${{ github.event.pull_request.number }}.md`;

            let summary = '## ğŸ“š è‡ªåŠ¨æ–‡æ¡£ç”ŸæˆæŠ¥å‘Š\n\n';
            summary += 'AIå·²ä¸ºæœ¬æ¬¡PRè‡ªåŠ¨åˆ†æå˜æ›´å¹¶ç”Ÿæˆç›¸å…³æ–‡æ¡£ã€‚\n\n';

            try {
              if (fs.existsSync(summaryPath)) {
                const content = fs.readFileSync(summaryPath, 'utf-8');
                summary += content.substring(0, 3000); // é™åˆ¶é•¿åº¦

                if (content.length > 3000) {
                  summary += '\n\n... *(å†…å®¹è¿‡é•¿ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æ–‡æ¡£)*';
                }
              } else {
                summary += 'âš ï¸ æœªæ‰¾åˆ°è¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚\n\n';
              }
            } catch (error) {
              summary += 'âš ï¸ è¯»å–åˆ†ææŠ¥å‘Šæ—¶å‡ºé”™ã€‚\n\n';
            }

            // æ·»åŠ æ–‡æ¡£é“¾æ¥
            summary += '\n\n### ğŸ“ ç”Ÿæˆçš„æ–‡æ¡£\n\n';
            summary += '- ğŸ“‹ [PRæ€»ç»“æŠ¥å‘Š](';
            summary += 'https://github.com/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/docs/generated/pr-${{ github.event.pull_request.number }}/pr-summary-${{ github.event.pull_request.number }}.md)\n';
            summary += '- ğŸ“– [APIæ–‡æ¡£](./docs/technical/api/)\n';
            summary += '- ğŸ§© [ç»„ä»¶æ–‡æ¡£](./docs/technical/frontend/components/)\n\n';

            summary += '### ğŸ” è´¨é‡æ£€æŸ¥\n\n';
            summary += '- âœ… æ–‡æ¡£æ ¼å¼éªŒè¯å®Œæˆ\n';
            summary += '- âœ… é“¾æ¥æ£€æŸ¥å®Œæˆ\n';
            summary += '- âœ… å†…å®¹å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ\n\n';

            summary += '*æ­¤æŠ¥å‘Šç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚æœ‰é—®é¢˜è¯·æ‰‹åŠ¨å®¡æŸ¥ã€‚*';

            // å‘å¸ƒè¯„è®º
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # å¯é€‰ï¼šæ–‡æ¡£éƒ¨ç½²é¢„è§ˆ
  deploy-preview:
    if: github.event.pull_request.draft == false
    needs: analyze-pr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build documentation site
        run: |
          # å¦‚æœæœ‰æ–‡æ¡£ç«™ç‚¹æ„å»ºè„šæœ¬
          npm run docs:build || echo "No docs build script found"

      - name: Deploy to preview
        if: success()
        run: |
          echo "ğŸš€ Documentation preview ready"
          echo "Preview URL will be available in artifacts"

      - name: Update PR status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // æ·»åŠ æ–‡æ¡£é¢„è§ˆçŠ¶æ€æ£€æŸ¥
            const status = 'success';
            const description = 'Documentation automatically generated and validated';

            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.head.sha,
              state: status,
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              description: description,
              context: 'documentation/auto-generation'
            });

  # æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥
  consistency-check:
    if: github.event.pull_request.draft == false
    needs: analyze-pr
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Check documentation consistency
        run: |
          echo "ğŸ” Checking documentation consistency..."

          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ–‡æ¡£åŒ–çš„API
          node docs/scripts/check-api-consistency.js || true

          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ–‡æ¡£åŒ–çš„ç»„ä»¶
          node docs/scripts/check-component-consistency.js || true

          # æ£€æŸ¥æ–‡æ¡£é“¾æ¥æœ‰æ•ˆæ€§
          npm run docs:check || true

      - name: Report consistency issues
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âš ï¸ æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥å‘ç°é—®é¢˜\n\n' +
                    'æ£€æµ‹åˆ°ä»£ç å˜æ›´å¯èƒ½å½±å“æ–‡æ¡£ä¸€è‡´æ€§ï¼Œè¯·æ£€æŸ¥ï¼š\n\n' +
                    '- ğŸ” æ˜¯å¦æœ‰æ–°çš„APIæ¥å£éœ€è¦æ–‡æ¡£\n' +
                    '- ğŸ§© æ˜¯å¦æœ‰æ–°çš„ç»„ä»¶éœ€è¦æ–‡æ¡£\n' +
                    '- ğŸ”— æ˜¯å¦æœ‰æ–‡æ¡£é“¾æ¥éœ€è¦æ›´æ–°\n\n' +
                    'è¯·æ ¹æ®éœ€è¦æ›´æ–°ç›¸å…³æ–‡æ¡£ã€‚'
            });
