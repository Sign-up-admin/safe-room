name: Documentation Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-check.yml'
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'Run in strict mode (warnings as errors)'
        required: false
        default: 'false'
        type: boolean
      check_expiry:
        description: 'Check for expired documentation'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  docs-format-check:
    name: Documentation Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install documentation script dependencies
        run: |
          cd docs/scripts
          npm init -y >/dev/null 2>&1
          npm install glob

      - name: Check documentation format
        run: |
          echo "ðŸ” Checking documentation format..."
          if [ "${{ github.event.inputs.strict_mode }}" = "true" ] || [ "${{ github.event_name }}" = "push" ]; then
            echo "Running in strict mode..."
            node docs/scripts/validate-docs.js --strict docs/
          else
            echo "Running in normal mode..."
            node docs/scripts/validate-docs.js docs/
          fi

      - name: Check documentation relationships
        run: |
          echo "ðŸ”— Checking documentation relationships..."
          node docs/scripts/validate-doc-relationships.js

      - name: Check expired documentation
        if: github.event.inputs.check_expiry != 'false'
        run: |
          echo "â° Checking for expired documentation..."
          node docs/scripts/validate-docs.js --check-expiry docs/

      - name: Validate documentation metadata
        run: |
          echo "ðŸ“‹ Validating documentation metadata..."
          # æ£€æŸ¥æ‰€æœ‰æ–‡æ¡£æ˜¯å¦åŒ…å«å¿…éœ€çš„å¤´éƒ¨ä¿¡æ¯
          node docs/scripts/fix-doc-metadata.js --scan-only

      - name: Generate format validation report
        run: |
          echo "ðŸ“Š Generating format validation report..."
          mkdir -p docs/reports

          cat > docs/reports/DOCS_FORMAT_CHECK_REPORT.md << 'EOF'
          # ðŸ“‹ æ–‡æ¡£æ ¼å¼æ£€æŸ¥æŠ¥å‘Š

          > **æ£€æŸ¥æ—¶é—´**ï¼š$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          > **æ£€æŸ¥åˆ†æ”¯**ï¼š${{ github.ref }}
          > **è§¦å‘äº‹ä»¶**ï¼š${{ github.event_name }}
          > **æäº¤SHA**ï¼š${{ github.sha }}

          ---

          ## ðŸ“‹ æ£€æŸ¥ç»“æžœ

          ### æ ¼å¼è§„èŒƒæ€§
          - âœ… æ–‡æ¡£å¤´éƒ¨ä¿¡æ¯æ£€æŸ¥ï¼šé€šè¿‡
          - âœ… Markdownè¯­æ³•éªŒè¯ï¼šé€šè¿‡
          - âœ… æ–‡æ¡£ç»“æž„å®Œæ•´æ€§ï¼šé€šè¿‡

          ### å…³è”å…³ç³»æ£€æŸ¥
          - âœ… å†…éƒ¨é“¾æŽ¥æœ‰æ•ˆæ€§ï¼šé€šè¿‡
          - âœ… æ–‡æ¡£ä¾èµ–å…³ç³»ï¼šé€šè¿‡
          - âœ… äº¤å‰å¼•ç”¨å®Œæ•´æ€§ï¼šé€šè¿‡

          ### è¿‡æœŸæ–‡æ¡£æ£€æŸ¥
          $(if [ "${{ github.event.inputs.check_expiry }}" != "false" ]; then
            echo "- âœ… è¿‡æœŸæ–‡æ¡£æ£€æµ‹ï¼šå·²æ‰§è¡Œ"
          else
            echo "- â­ï¸ è¿‡æœŸæ–‡æ¡£æ£€æµ‹ï¼šå·²è·³è¿‡"
          fi)

          ---

          ## ðŸ” æ£€æŸ¥è¯¦æƒ…

          ### æ£€æŸ¥çš„æ–‡æ¡£ç±»åž‹
          - éœ€æ±‚æ–‡æ¡£ (requirements/)
          - æŠ€æœ¯æ–‡æ¡£ (technical/)
          - å¼€å‘æ–‡æ¡£ (development/)
          - æŠ¥å‘Šæ–‡æ¡£ (reports/)
          - æ¨¡æ¿æ–‡æ¡£ (templates/)

          ### éªŒè¯è§„åˆ™
          - æ–‡æ¡£å¿…é¡»åŒ…å«æ ‡å‡†å¤´éƒ¨ä¿¡æ¯ (title, version, last_updated, status, category)
          - Markdownè¯­æ³•å¿…é¡»ç¬¦åˆè§„èŒƒ
          - å†…éƒ¨é“¾æŽ¥å¿…é¡»æœ‰æ•ˆ
          - æ–‡æ¡£ç»“æž„å¿…é¡»å®Œæ•´
          - æ–‡ä»¶å‘½åå¿…é¡»ç¬¦åˆè§„èŒƒ

          ---

          ## âœ… ç»“è®º

          **æ–‡æ¡£æ ¼å¼æ£€æŸ¥é€šè¿‡** ðŸŽ‰

          æ‰€æœ‰æ–‡æ¡£å‡ç¬¦åˆæ ¼å¼è§„èŒƒè¦æ±‚ï¼Œå¯ä»¥æ­£å¸¸å‘å¸ƒå’Œä½¿ç”¨ã€‚

          ---
          *è‡ªåŠ¨ç”ŸæˆäºŽ $(date)*
          EOF

      - name: Upload format check report
        uses: actions/upload-artifact@v4
        with:
          name: docs-format-check-report
          path: docs/reports/DOCS_FORMAT_CHECK_REPORT.md
          retention-days: 30

  docs-quality-assessment:
    name: Documentation Quality Assessment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: docs-format-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install documentation script dependencies
        run: |
          cd docs/scripts
          npm init -y >/dev/null 2>&1
          npm install glob

      - name: Generate API documentation
        run: |
          echo "ðŸ”Œ Generating API documentation..."
          node docs/scripts/generate-api-docs.js

      - name: Generate database documentation
        run: |
          echo "ðŸ—„ï¸ Generating database documentation..."
          node docs/scripts/generate-database-docs.js

      - name: Generate quality report
        run: |
          echo "ðŸ“Š Generating documentation quality report..."
          node docs/scripts/generate-quality-report.js

      - name: Generate lifecycle report
        run: |
          echo "ðŸ”„ Generating documentation lifecycle report..."
          node docs/scripts/manage-doc-lifecycle.js report

      - name: Check quality thresholds
        run: |
          echo "ðŸ” Checking quality thresholds..."
          if [ -f "docs/reports/DOC_QUALITY_REPORT.md" ]; then
            # è¯»å–è´¨é‡æŠ¥å‘Šä¸­çš„å¾—åˆ†
            quality_score=$(grep "è´¨é‡å¾—åˆ†" docs/reports/DOC_QUALITY_REPORT.md | head -1 | sed 's/.*è´¨é‡å¾—åˆ†[^0-9]*\([0-9]*\).*/\1/')

            if [ -z "$quality_score" ] || [ "$quality_score" = "NaN" ]; then
              echo "âš ï¸ æ— æ³•èŽ·å–è´¨é‡å¾—åˆ†ï¼Œè·³è¿‡é˜ˆå€¼æ£€æŸ¥"
              exit 0
            fi

            echo "å½“å‰è´¨é‡å¾—åˆ†: $quality_score/100"

            # è®¾ç½®è´¨é‡é˜ˆå€¼
            min_quality=60

            if [ "$quality_score" -lt $min_quality ]; then
              echo "âŒ æ–‡æ¡£è´¨é‡å¾—åˆ† ($quality_score/100) ä½ŽäºŽæœ€ä½Žé˜ˆå€¼ ($min_quality/100)"
              echo "è¯·æ”¹è¿›æ–‡æ¡£è´¨é‡åŽé‡æ–°æäº¤"
              exit 1
            else
              echo "âœ… æ–‡æ¡£è´¨é‡å¾—åˆ† ($quality_score/100) ç¬¦åˆè¦æ±‚"
            fi
          else
            echo "âš ï¸ è´¨é‡æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè·³è¿‡é˜ˆå€¼æ£€æŸ¥"
          fi

      - name: Update documentation index
        run: |
          echo "ðŸ“š Updating documentation index..."
          node docs/scripts/update-doc-index.js --update-versions --check-quality

      - name: Upload quality assessment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs-quality-assessment
          path: |
            docs/reports/DOC_QUALITY_REPORT.md
            docs/INDEX.md
          retention-days: 30

  docs-pr-feedback:
    name: Documentation PR Feedback
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [docs-format-check, docs-quality-assessment]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download format check report
        uses: actions/download-artifact@v4
        with:
          name: docs-format-check-report
          path: reports/

      - name: Download quality assessment
        uses: actions/download-artifact@v4
        with:
          name: docs-quality-assessment
          path: reports/

      - name: Generate PR comment
        run: |
          echo "ðŸ’¬ Generating PR feedback comment..."

          cat > pr_comment.md << 'EOF'
          ## ðŸ“š æ–‡æ¡£æ£€æŸ¥ç»“æžœ

          ä½ çš„æ–‡æ¡£å˜æ›´å·²é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼ðŸŽ‰

          ### âœ… æ£€æŸ¥é€šè¿‡
          - **æ ¼å¼è§„èŒƒæ€§**ï¼šæ–‡æ¡£æ ¼å¼ç¬¦åˆæ ‡å‡†è¦æ±‚
          - **å…³è”å…³ç³»**ï¼šå†…éƒ¨é“¾æŽ¥å’Œå¼•ç”¨å…³ç³»æ­£ç¡®
          - **è´¨é‡è¯„ä¼°**ï¼šæ–‡æ¡£è´¨é‡å¾—åˆ†ç¬¦åˆé˜ˆå€¼è¦æ±‚

          ### ðŸ“Š è´¨é‡æŒ‡æ ‡
          $(if [ -f "reports/docs/reports/DOC_QUALITY_REPORT.md" ]; then
            quality_score=$(grep "è´¨é‡å¾—åˆ†" reports/docs/reports/DOC_QUALITY_REPORT.md | head -1)
            echo "- $quality_score"
            quality_level=$(grep "ç­‰çº§" reports/docs/reports/DOC_QUALITY_REPORT.md | head -1)
            echo "- $quality_level"
          else
            echo "- è´¨é‡æŠ¥å‘Šï¼šæš‚æœªç”Ÿæˆ"
          fi)

          ### ðŸ“‹ æ–‡æ¡£ç»Ÿè®¡
          - æ€»æ–‡æ¡£æ•°ï¼š$(find docs -name "*.md" | wc -l)
          - æ–°å¢ž/ä¿®æ”¹æ–‡æ¡£ï¼š$(git diff --name-only ${{ github.event.pull_request.base.sha }} | grep "docs/" | wc -l)

          ### ðŸ”— ç›¸å…³é“¾æŽ¥
          - [ðŸ“‹ æ ¼å¼æ£€æŸ¥æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ðŸ“Š è´¨é‡è¯„ä¼°æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ðŸ“š æ–‡æ¡£ç´¢å¼•](docs/INDEX.md)

          ---
          *æ­¤è¯„è®ºç”±æ–‡æ¡£æ£€æŸ¥å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*
          EOF

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  docs-check-summary:
    name: Documentation Check Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [docs-format-check, docs-quality-assessment]
    if: always()

    steps:
      - name: Generate check summary
        run: |
          echo "ðŸ“‹ ç”Ÿæˆæ–‡æ¡£æ£€æŸ¥æ‘˜è¦..."

          # æ£€æŸ¥å„ä¸ªä»»åŠ¡çš„çŠ¶æ€
          format_check="${{ needs.docs-format-check.result }}"
          quality_check="${{ needs.docs-quality-assessment.result }}"

          cat > check_summary.md << EOF
          # ðŸ“š æ–‡æ¡£æ£€æŸ¥æ‘˜è¦

          ## æ£€æŸ¥æ—¶é—´
          - æ—¶é—´ï¼š$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - åˆ†æ”¯ï¼š${{ github.ref }}
          - äº‹ä»¶ï¼š${{ github.event_name }}

          ## æ£€æŸ¥ç»“æžœ

          ### æ ¼å¼æ£€æŸ¥
          $(if [ "$format_check" = "success" ]; then
            echo "- âœ… **é€šè¿‡**ï¼šæ–‡æ¡£æ ¼å¼è§„èŒƒ"
          elif [ "$format_check" = "failure" ]; then
            echo "- âŒ **å¤±è´¥**ï¼šæ–‡æ¡£æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
          else
            echo "- â³ **è¿›è¡Œä¸­**ï¼šæ ¼å¼æ£€æŸ¥å°šæœªå®Œæˆ"
          fi)

          ### è´¨é‡è¯„ä¼°
          $(if [ "$quality_check" = "success" ]; then
            echo "- âœ… **é€šè¿‡**ï¼šæ–‡æ¡£è´¨é‡è¾¾æ ‡"
          elif [ "$quality_check" = "failure" ]; then
            echo "- âŒ **å¤±è´¥**ï¼šæ–‡æ¡£è´¨é‡æœªè¾¾æ ‡"
          else
            echo "- â³ **è¿›è¡Œä¸­**ï¼šè´¨é‡è¯„ä¼°å°šæœªå®Œæˆ"
          fi)

          ## æ€»ä½“çŠ¶æ€
          $(if [ "$format_check" = "success" ] && [ "$quality_check" = "success" ]; then
            echo "ðŸŽ‰ **å…¨éƒ¨é€šè¿‡**ï¼šæ–‡æ¡£å¯ä»¥æ­£å¸¸å‘å¸ƒ"
          else
            echo "âš ï¸ **éœ€è¦æ”¹è¿›**ï¼šè¯·æ£€æŸ¥å¤±è´¥çš„é¡¹ç›®å¹¶ä¿®å¤é—®é¢˜"
          fi)

          ---
          *è‡ªåŠ¨ç”ŸæˆäºŽ $(date)*
          EOF

      - name: Upload check summary
        uses: actions/upload-artifact@v4
        with:
          name: docs-check-summary
          path: check_summary.md
          retention-days: 30

      - name: Notify check completion
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "Documentation checks failed - please review and fix issues"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
