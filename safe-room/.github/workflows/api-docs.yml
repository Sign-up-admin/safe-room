name: API Documentation

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'springboot1ngh61a2/src/main/java/com/controller/**'
      - 'docs/scripts/generate-api-docs.js'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'springboot1ngh61a2/src/main/java/com/controller/**'
      - 'docs/scripts/generate-api-docs.js'

jobs:
  generate-api-docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥è¿›è¡Œæ¯”è¾ƒ

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Check for Controller changes
      id: check_changes
      run: |
        # æ£€æŸ¥Controlleræ–‡ä»¶æ˜¯å¦æœ‰å˜æ›´
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi

        CONTROLLER_CHANGED=$(echo "$CHANGED_FILES" | grep "springboot1ngh61a2/src/main/java/com/controller/.*\.java" | wc -l)

        echo "controller_changed=$CONTROLLER_CHANGED" >> $GITHUB_OUTPUT
        echo "Controlleræ–‡ä»¶å˜æ›´æ•°é‡: $CONTROLLER_CHANGED"

    - name: Generate API Documentation
      if: steps.check_changes.outputs.controller_changed != '0'
      run: |
        echo "ğŸ”„ ç”ŸæˆAPIæ–‡æ¡£..."
        node docs/scripts/generate-api-docs.js --output docs/technical/api/GENERATED_API.md --verbose

    - name: Commit API documentation
      if: steps.check_changes.outputs.controller_changed != '0'
      run: |
        # æ£€æŸ¥æ–‡æ¡£æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet docs/technical/api/GENERATED_API.md; then
          echo "ğŸ“‹ APIæ–‡æ¡£æ— å˜æ›´"
        else
          echo "ğŸ“ æäº¤APIæ–‡æ¡£æ›´æ–°"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/technical/api/GENERATED_API.md
          git commit -m "docs: è‡ªåŠ¨æ›´æ–°APIæ–‡æ¡£ [skip ci]" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
        fi

    - name: Upload API documentation
      if: steps.check_changes.outputs.controller_changed != '0'
      uses: actions/upload-artifact@v4
      with:
        name: api-documentation
        path: docs/technical/api/GENERATED_API.md
        retention-days: 30

  validate-api-docs:
    runs-on: ubuntu-latest
    needs: generate-api-docs

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Validate API documentation
      run: |
        echo "ğŸ” éªŒè¯APIæ–‡æ¡£..."

        # æ£€æŸ¥æ–‡æ¡£æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "docs/technical/api/GENERATED_API.md" ]; then
          echo "âŒ APIæ–‡æ¡£æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

        # æ£€æŸ¥æ–‡æ¡£æ˜¯å¦åŒ…å«åŸºæœ¬ä¿¡æ¯
        if ! grep -q "è‡ªåŠ¨ç”Ÿæˆçš„APIæ–‡æ¡£" docs/technical/api/GENERATED_API.md; then
          echo "âŒ APIæ–‡æ¡£æ ¼å¼ä¸æ­£ç¡®"
          exit 1
        fi

        # æ£€æŸ¥æ˜¯å¦åŒ…å«æ§åˆ¶å™¨ä¿¡æ¯
        if ! grep -q "æ§åˆ¶å™¨æ•°é‡" docs/technical/api/GENERATED_API.md; then
          echo "âŒ APIæ–‡æ¡£ç¼ºå°‘æ§åˆ¶å™¨ä¿¡æ¯"
          exit 1
        fi

        echo "âœ… APIæ–‡æ¡£éªŒè¯é€šè¿‡"

  notify:
    runs-on: ubuntu-latest
    needs: [generate-api-docs, validate-api-docs]
    if: always() && needs.generate-api-docs.result == 'success' && needs.validate-api-docs.result == 'success'

    steps:
    - name: Notify success
      run: |
        echo "ğŸ‰ APIæ–‡æ¡£ç”Ÿæˆå’ŒéªŒè¯æˆåŠŸå®Œæˆ"
        echo "ğŸ“„ ç”Ÿæˆçš„æ–‡æ¡£å·²ä¿å­˜åˆ° docs/technical/api/GENERATED_API.md"

