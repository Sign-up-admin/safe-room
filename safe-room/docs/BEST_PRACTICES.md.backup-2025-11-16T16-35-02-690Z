# 软件工程与最佳实践 / Software Engineering Best Practices

> 本文聚焦 `safe-room` 健身房综合管理系统，整理前端、后端、接口与数据库四大领域的工程基线、质量控制与安全策略。内容来源于 `docs/ARCHITECTURE.md`、`docs/API.md`、`docs/DATABASE.md`、`CODE_CHECK_CONFIG.md`、`docs/SECURITY.md` 及测试、部署等配套文档，旨在提供统一的落地标准。

---

## 文档使用方式
- **参考顺序**：按领域查阅，或结合交付阶段（开发 → 测试 → 部署）跨节查找。
- **关联文档**：遇到“详见”或相对路径时，优先阅读对应文档以了解实现细节。
- **落地要求**：新增/调整功能时，需在 PR 描述中说明遵循了哪些实践，并在必要时更新本文件。

---

## 1. 前端最佳实践

### 1.1 技术栈与工程基线
- 采用 `Vite + Vue 3 + TypeScript + Element Plus`，前台与后台分别位于 `springboot1ngh61a2/src/main/resources/front/front` 与 `.../admin/admin`。
- 使用 Pinia 管理共享状态，Router 配置路由守卫（登录、角色、进度条），`http.ts` 统一 axios 实例与拦截器。
- 动效与可视化依赖 GSAP、D3.js、Three.js、ECharts；在移动端需降级或延迟加载。
- 前端资源可独立部署 Nginx/CDN，也可打包后由 Spring Boot 提供静态资源，需与 `docs/DEPLOYMENT.md` 同步。

### 1.2 代码规范与质量门禁
- `.eslintrc.cjs` 与 `.stylelintrc.cjs` 约束 Vue/TS/CSS 规则；`.prettierrc` 控制统一格式。提交前必须运行：
  - `npm run check:all:fix`（前台）
  - `npm run check:all:fix`（后台）
- TypeScript 开启 `strict`、`noUncheckedIndexedAccess` 等选项，禁止滥用 `any`；Pinia store 与组件 props 必须声明类型。
- Husky + lint-staged 拦截未通过 lint/format 的提交；VS Code 推荐启用保存自动修复。

### 1.3 组件、状态与可复用性
- 组件命名遵循 `PascalCase`；公共组件放在 `src/components`，业务模块使用 `src/pages`/`src/views`。
- Props/emit 使用 `defineProps`/`defineEmits` 并结合 `withDefaults`；复杂结构通过 `zod`/TS interface 定义。
- Pinia store 避免直接暴露可变 state，推荐 `computed` getter + action；跨页数据需持久化至 localStorage 并加版本。
- 模块化配置（如 `src/config/modules.ts`）统一表格字段、筛选项与权限，减少重复 CRUD 配置。

### 1.4 性能与体验
- 使用 Vite 代码分割、路由懒加载与按需引入 Element Plus 组件；对 Three.js/GSAP 场景启用 `requestIdleCallback` 或 Intersection Observer。
- 静态资源开启 `vite build --report` 监控 bundle；图片采用 WebP/AVIF，视频懒加载。
- 动效遵循首页基线：Hover 上浮 4px、发光增强 8%，滚动触发淡入/上升动画；移动端禁止过度动效。
- 使用 `@amap/amap-jsapi-loader`、`echarts` 等大库时封装懒加载 Hook，避免在 SSR/测试环境报错。

### 1.5 可访问性与国际化
- 所有交互组件使用语义化标签（`button`, `nav`, `header`）并补充 `aria-*`；表单项关联 `label`。
- 键盘导航：自定义组件需处理 `Enter/Space` 触发；模态、抽屉在打开时应聚焦首个可操作元素。
- 富文本渲染使用 `v-html` 时需通过 DOMPurify/自定义过滤器；上传图片提供 `alt` 文案。
- 若后续引入国际化（i18n），需将文案抽离为 `src/locales/*`，保持响应式布局不依赖固定宽度。

### 1.6 测试与观测
- 单元测试：`npm run test:unit` (Vitest) 覆盖组件逻辑、store、工具函数，默认跑在 happy-dom。
- E2E：`npm run test:e2e` (Playwright) 覆盖关键用户路径（登录、预约、支付、后台审核）；使用 `--ui` 审核录制。
- 覆盖率：`npm run test:coverage` 输出到 `coverage/`，重点指标 ≥ 70% statements/lines；CI 可上传到 Codecov。
- 监控：前端捕获 `window.onerror`、`unhandledrejection`，调用后端 `/errorReport`；对核心交互埋点（曝光、点击、转化）。

### 1.7 安全
- Axios 请求拦截器自动附带 `Token`，响应 `401` 时清理缓存并跳转登录。
- 表单输入默认使用 `v-model.trim`，对富文本/上传内容做白名单校验，避免 XSS。
- 开启 HTTPS + HSTS，限制第三方脚本来源；对文件上传添加扩展/MIME 校验并走隔离的下载域名。
- 路由守卫对后台模块强制检查角色；敏感页面（如系统配置）需二次确认或操作日志。

---

## 2. 后端最佳实践

### 2.1 架构与分层
- 保持 `Controller → Service → DAO/Mapper` 分层，禁止在 Controller 直接访问数据库或跨服务事务。
- Service 层负责事务边界（`@Transactional`）、业务编排与幂等，DAO 专注数据访问与 MyBatis-Plus 条件构造。
- 公共能力（拦截器、配置、工具）集中在 `com.config`, `com.interceptor`, `com.utils`；新增能力需纳入 `docs/ARCHITECTURE.md`。

### 2.2 代码规范
- 使用 Java 21 语法（record、switch pattern 等）需评估团队兼容性；默认保持向后兼容。
- 命名遵循驼峰 + 语义化，禁止缩写；实体带 `Entity`，DTO/VO 明确后缀。
- 统一异常处理：业务异常抛 `RRException` → `GlobalExceptionHandler`，记录日志并返回 `{code,msg}`。
- 输入校验使用 `jakarta.validation` 注解并在 Controller 调用 `ValidatorUtils`; 对复杂校验可在 Service 写自定义逻辑。

### 2.3 安全
- `AuthorizationInterceptor` 校验 `Token` 并写入 `HttpSession`，所有非 `@IgnoreAuth` 接口必须验证。
- Token 表需记录 `userid/username/tableName/expiretime`，支持多角色；登录/重置密码需审计日志。
- `SQLFilter`、MyBatis-Plus 预编译防 SQL 注入；对 `MPUtil` 动态字段提供白名单。
- 文件上传保存至 `static/upload` 前做重命名、大小限制与内容检测；下载接口校验路径、防止遍历。

### 2.4 性能与伸缩
- 数据库连接池使用 HikariCP，`application.yml` 默认 `minIdle=5` / `maxPool=20`，生产可调到 `10/50`。
- 复杂查询优先通过 MyBatis-Plus `Wrapper` + 索引优化；避免 N+1（使用 `in` 查询或 Mapper 自定义 SQL）。
- 对高频查询（课程列表、热门教练）引入本地缓存（Caffeine）或分布式缓存；缓存需带 TTL 与失效策略。
- 异步任务（通知、日志）通过 `@Async` 或消息队列（如 RabbitMQ）处理，避免阻塞 HTTP 线程。

### 2.5 测试与覆盖率
- 单元测试：`mvn test -Dtest=ClassNameTest`；集成测试继承 `AbstractControllerIntegrationTest`，自动装载 `MockMvc` 与 SQL Fixture。
- 覆盖率：JaCoCo 配置在 `pom.xml`，要求类级别行覆盖率 ≥ 40%，未达标构建失败。
- 测试数据：`test-schema.sql` + `test-data.sql` 覆盖 18 张核心业务表，确保与生产结构同步。
- CI 建议步骤：`mvn --batch-mode test` → 上传 `target/site/jacoco/index.html`；若涉及接口/配置变更，附带测试报告链接。

### 2.6 观测与运维
- 使用 `logs/` 目录集中输出，日志格式包含 traceId/用户信息；敏感字段（手机号、证件）需脱敏。
- 关键模块增加性能指标（耗时、QPS）并推送到监控平台；错误日志结合告警（邮件/IM）。
- 定期检视 `BACKEND_AUTOMATION.md` 与 `TESTING.md`，确保调试脚本、常见问题解法保持最新。

---

## 3. 接口（API）最佳实践

### 3.1 RESTful 设计
- 路径资源化：`/jianshenkecheng/{id}`、`/kechengyuyue`，批量操作使用 `POST /delete` + `Long[] ids`。
- HTTP 方法语义化：GET 查询、POST 创建、PUT/PATCH 更新、DELETE 删除；如受前端限制需在 Query 中声明 `_method`。
- 统一响应 `{code,msg,data}`，错误码参考 `docs/API.md` (`0/401/403/404/500`)；分页使用 `PageUtils`。

### 3.2 版本与兼容
- 采用 Header 版本（`X-Api-Version`）或 URL 前缀（`/api/v1/...`）保持向后兼容；废弃接口提供过渡期与文档说明。
- 公共接口（`/common`, `/file`) 需记录版本策略，避免前端静态资源与后端升级脱节。

### 3.3 请求与响应规范
- 入参通过 DTO/VO 定义，禁止直接使用 Entity 以免暴露数据库字段；分页参数默认 `page=1`, `limit=10`。
- 统一错误处理：`GlobalExceptionHandler` 区分业务/系统异常，必要时返回 `traceId` 用于排查。
- 上传接口返回文件名、访问 URL；下载接口验证权限并设置 `Content-Disposition`。

### 3.4 文档与协作
- 所有接口变更需同步 `docs/API.md`，并在 PR checklist 勾选“相关文档已更新”。
- 推荐引入 OpenAPI/Swagger 生成机读文档，与前端共享 DTO 定义；mock 数据可用 `axios-mock-adapter`。
- 对外 API 应提供示例请求（curl/Postman）与错误示例，便于自动化测试（参考 `TESTING.md`）。

### 3.5 安全与稳健性
- Token 必填接口通过 `AuthorizationInterceptor` 校验；`@IgnoreAuth` 仅用于只读公开数据。
- 启用 CORS 白名单并限制 `Access-Control-Allow-Credentials`; CSRF 敏感操作使用双重 token 或验证码。
- 对登录、发短信等高危接口加入限流与验证码；对 `Long[] ids` 操作做长度限制与操作日志。
- 统一开启 gzip/deflate 压缩，避免大 payload；对 streaming/下载设置限速或断点续传。

---

## 4. 数据库最佳实践

### 4.1 建模与命名
- 表使用蛇形命名（`fitness_course`），与实体映射在 `com.entity`；若存在拼音表名需参考 `REFACTORING_PROGRESS.md` 对照表。
- 字段保持语义化，主键统一 bigint，自增或雪花 ID；时间字段使用 `timestamp` 并记录 `addtime`, `updatetime`。
- 对查询频繁列建立 B-Tree 索引，组合索引遵循左前缀原则；避免过多索引用于写入密集表。

### 4.2 查询与性能
- 复杂统计/报表优先编写视图或物化视图脚本；分页查询使用 `PageUtils` + `order by`，禁止 `select *`。
- 通过 `EXPLAIN (ANALYZE, BUFFERS)` 分析慢 SQL，必要时调整索引或拆分表。
- 避免 N+1：使用 `IN` 批量查询或在 Service 聚合；必要时引入缓存。

### 4.3 事务与一致性
- 事务边界由 Service 控制（`@Transactional`），避免在 DAO 嵌套事务；默认隔离级别 `READ COMMITTED`，如需串行化需评估性能。
- 批处理（批量审核、导入）使用批量 SQL 或存储过程，减少事务持锁时间。
- 对需幂等的操作（支付、退课）引入业务唯一键（如预约编号），防重放。

### 4.4 数据迁移与脚本
- 所有结构变更先更新 `schema-postgresql.sql`，同步 `test-schema.sql`；若需保留历史数据引入 `Vxxx__desc.sql`（Flyway/Liquibase）。
- 生产迁移遵循“建表 → 灰度 → 切流量 → 清理旧结构”流程，并在 `CHANGELOG.md` 记录。
- 数据补丁通过独立 SQL 或工具脚本（`fix_*.py|ps1`）执行，执行后附验证结果。

### 4.5 备份、恢复与安全
- Docker 部署默认数据卷，定期使用 `pg_dump` 全量备份并保存在加密存储；关键表可使用逻辑复制。
- 恢复流程：停服务 → 恢复数据库 → 校验数据 → 重启应用；需在 `DEPLOYMENT.md` 记录。
- 数据库凭据通过 `.env`/环境变量注入，严禁硬编码；生产库限制 IP/角色权限。
- 文件上传与数据库解耦：仅存路径/元数据，文件存对象存储或隔离磁盘。

### 4.6 监控与运维
- 启用 PostgreSQL 慢查询日志、连接数监控；对连接池（HikariCP）设置告警阈值。
- 定期运行 `VACUUM (ANALYZE)`，大型表使用 `PARTITION` 或归档策略。
- `TESTING.md` 中的数据库验证脚本应纳入巡检流程，确保结构/数据一致。

---

## 附录：执行清单
1. **开发前**：确认所负责模块在本文件中的适用章节；必要时补充设计文档。
2. **实现中**：保持 lint/test 全绿，按照安全 & 性能要求设计接口与 SQL。
3. **代码评审**：Reviewer 以本文件为对照清单；对不符合项给出整改建议。
4. **发布前**：更新 `docs/API.md`、`docs/ARCHITECTURE.md`、`docs/DATABASE.md` 等引用文档，并在 PR 中链接变更。
5. **运维期**：当架构、栈或流程发生变化时，优先更新本文件，确保其为最新事实来源。

