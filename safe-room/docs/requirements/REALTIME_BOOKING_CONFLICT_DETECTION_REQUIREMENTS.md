---
title: REALTIME BOOKING CONFLICT DETECTION REQUIREMENTS
version: v1.0.0
last_updated: 2025-11-17
status: active
category: requirements
---

# 实时预约冲突检测增强需求文档（Realtime Booking Conflict Detection Enhancement）

> 版本：v1.0 ⭐ 新增功能需求
> 更新日期：2025-11-17
> 适用路由：`/index/kechengyuyue`、`/index/sijiaoyue`
> 关联模块：`kechengyuyue`、`sijiaoyue`、`useBookingConflict`

---

## 📈 需求背景

当前预约系统存在基础冲突检测功能，但缺乏实时性，导致用户在并发场景下仍可能遇到预约冲突问题。本需求旨在通过WebSocket实时推送和跨页面状态同步，实现毫秒级冲突检测响应，提升预约成功率和用户体验。

---

## 0. 设计关键词

实时冲突检测 · WebSocket推送 · 跨页面同步 · 智能推荐 · 并发处理

---

## 1. 页面逻辑结构

### 1.1 课程预约页面 (`/index/kechengyuyue`)

| 顺序 | 区块 | 目的 | 实时增强 |
| --- | --- | --- | --- |
| ① | 预约步骤条 | 明确当前步骤 | 新增冲突状态指示 |
| ② | 课程选择 | 展示课程列表 | 实时库存同步 |
| ③ | 日历 & 时间段 | 展示余位，支持冲突检测 | WebSocket实时更新 |
| ④ | 预约信息确认 | 收集预约信息 | 实时冲突验证 |
| ⑤ | 成功反馈 | 预约成功提示 | 即时状态推送 |

### 1.2 私教预约页面 (`/index/sijiaoyue`)

| 顺序 | 区块 | 目的 | 实时增强 |
| --- | --- | --- | --- |
| ① | 预约步骤条 | 明确当前步骤 | 新增冲突状态指示 |
| ② | 教练选择 | 选择教练 | 实时可用性同步 |
| ③ | 目标 & 套餐设定 | 设定训练目标 | 智能推荐优化 |
| ④ | 时间安排 | 选择时间段 | WebSocket实时冲突检测 |
| ⑤ | 预约确认 | 确认预约信息 | 实时验证和锁定 |

---

## 2. 视觉与交互

### 2.1 冲突状态视觉设计

- **实时冲突指示器**：时间段卡片右上角显示实时状态
  - 🔴 红色脉冲：严重冲突（已满员）
  - 🟡 黄色闪烁：轻微冲突（即将满员）
  - 🟢 绿色常亮：可用
  - 🔵 蓝色呼吸：当前用户锁定

- **冲突详情浮层**：hover/点击显示详细冲突信息
  - 冲突原因分类（课程冲突、私教冲突、场地冲突）
  - 冲突对象列表（显示具体预约信息）
  - 智能建议时间段

### 2.2 动效与过渡

- **状态变化动效**：冲突状态变更时平滑过渡（300ms）
- **锁定反馈**：用户选择时间段后的锁定动画
- **解锁提醒**：锁定超时自动解锁的警告提示
- **实时更新提示**：新冲突产生时的微妙视觉反馈

---

## 3. 功能模块

### 3.1 WebSocket实时连接管理

| 功能 | 说明 | 数据来源 | 接口 |
| --- | --- | --- | --- |
| 连接建立 | 页面加载时自动建立WebSocket连接 | `ws://host/ws/booking-conflicts` | WebSocket |
| 心跳检测 | 每30秒发送心跳包维持连接 | 客户端定时器 | - |
| 重连机制 | 连接断开后自动重连（最多5次） | 指数退避算法 | - |
| 断开处理 | 网络异常时的降级处理 | 本地缓存数据 | - |

### 3.2 实时冲突状态同步

| 功能 | 说明 | 数据来源 | 接口 |
| --- | --- | --- | --- |
| 状态推送 | 服务器主动推送冲突状态变更 | WebSocket消息 | `/ws/booking-conflicts` |
| 跨页面同步 | 用户在不同标签页的冲突状态同步 | SharedWorker/LocalStorage | - |
| 缓存策略 | 网络异常时的本地状态缓存 | IndexedDB | - |
| 状态恢复 | 页面刷新后的状态恢复机制 | LocalStorage + API | `/api/conflict/status` |

### 3.3 智能时间推荐算法

| 功能 | 说明 | 数据来源 | 接口 |
| --- | --- | --- | --- |
| 可用时段推荐 | 基于用户偏好推荐最优时间 | 用户历史预约数据 | `/api/recommend/slots` |
| 冲突回避算法 | 自动避开高冲突时间段 | 实时冲突数据 | - |
| 个性化排序 | 按用户习惯排序推荐时段 | 用户行为分析 | `/api/user/preferences` |
| 动态调整 | 根据实时冲突更新推荐结果 | WebSocket数据流 | - |

### 3.4 并发处理机制

| 功能 | 说明 | 数据来源 | 接口 |
| --- | --- | --- | --- |
| 预约锁定 | 用户选择时段后的临时锁定（30秒） | Redis分布式锁 | `/api/booking/lock` |
| 锁定续期 | 用户操作时的锁定时间延长 | 前端定时器 | - |
| 自动解锁 | 超时自动释放锁定状态 | 后端定时任务 | - |
| 冲突解决 | 并发冲突时的公平处理机制 | 时间戳优先级 | - |

---

## 4. 交互与动效规范

| 维度 | 规范 | 实时增强 |
| --- | --- | --- |
| 动画时长 | 0.3s ~ 0.55s | 新增状态变化动效 |
| 缓动 | `cubic-bezier(0.4, 0, 0.2, 1)` | 保持一致性 |
| 实时反馈 | 状态变更即时视觉反馈 | WebSocket驱动的实时更新 |
| 冲突提示 | 非阻塞式toast提示 | 新增冲突详情浮层 |
| 锁定状态 | 选择后的时间段高亮锁定 | 新增30秒倒计时指示器 |

---

## 5. 响应式策略

| 终端 | 处理 | 实时优化 |
| --- | --- | --- |
| PC（>1200px） | 完整实时功能，冲突详情侧边栏 | WebSocket全功能支持 |
| Pad（768-1200px） | 简化动效，触摸友好的时间选择 | 优化触摸交互的实时反馈 |
| Mobile（<768px） | 卡片栈式布局，垂直滑动 | 轻量化WebSocket连接，优化电池使用 |

---

## 6. 技术栈与依赖

| 领域 | 库/实现 | 版本要求 |
| --- | --- | --- |
| 框架 | Vue 3 + TypeScript | >=3.3.0 |
| WebSocket | 原生WebSocket API + SockJS | - |
| 状态管理 | Pinia | >=2.1.0 |
| 缓存 | IndexedDB + LocalStorage | - |
| 并发控制 | Redis分布式锁 | 后端实现 |
| 算法 | 自定义推荐算法 | 前端实现 |

---

## 7. 开发交付件

1. **核心组合式API**
   - `useRealtimeBookingConflict.ts` - 实时冲突检测主逻辑
   - `useWebSocketConnection.ts` - WebSocket连接管理
   - `useConflictRecommendation.ts` - 智能推荐算法

2. **组件扩展**
   - `RealtimeConflictIndicator.vue` - 实时冲突状态指示器
   - `ConflictDetailPopover.vue` - 冲突详情浮层组件
   - `TimeSlotLock.vue` - 时间段锁定组件

3. **服务层扩展**
   - `realtimeBookingService.ts` - 实时预约服务
   - `conflictCacheService.ts` - 冲突状态缓存服务
   - `recommendationEngine.ts` - 推荐算法引擎

4. **类型定义**
   - `realtime-conflict.types.ts` - 实时冲突相关类型
   - `websocket-message.types.ts` - WebSocket消息类型

5. **测试覆盖**
   - 单元测试：冲突检测算法测试
   - 集成测试：WebSocket连接测试
   - E2E测试：并发预约场景测试

---

## 8. 验收标准

### 8.1 功能验收

| 维度 | 标准 | 量化指标 |
| --- | --- | --- |
| 实时性 | WebSocket消息延迟 < 100ms | 平均延迟 < 50ms |
| 准确性 | 冲突检测准确率 100% | 误检率 < 0.1% |
| 并发处理 | 支持1000并发预约操作 | 成功率 > 99.5% |
| 跨页面同步 | 多标签页状态同步延迟 < 200ms | 同步成功率 > 99% |

### 8.2 性能验收

| 维度 | 标准 | 量化指标 |
| --- | --- | --- |
| 首屏加载 | WebSocket连接建立时间 < 500ms | 平均 < 300ms |
| 内存占用 | 新增功能内存占用 < 2MB | 实际 < 1.5MB |
| 电池消耗 | 移动端待机功耗增加 < 5% | 实际 < 3% |
| 网络流量 | WebSocket消息压缩后 < 1KB/min | 平均 < 0.5KB/min |

### 8.3 视觉验收

| 维度 | 标准 | 验收方式 |
| --- | --- | --- |
| 状态指示 | 冲突状态视觉反馈清晰直观 | 设计师验收 |
| 动效流畅 | 状态变化过渡自然无卡顿 | FPS ≥ 55 |
| 响应式适配 | 三端布局合理，交互一致 | 跨设备测试 |
| 无障碍支持 | 键盘导航和屏幕阅读器支持 | 可访问性测试 |

---

## 9. 备注

### 9.1 依赖关系

- **后端依赖**：WebSocket服务端实现、Redis分布式锁
- **前端依赖**：现有`useBookingConflict.ts`组合式API
- **数据依赖**：用户预约历史数据、实时库存数据

### 9.2 风险提示

- **网络稳定性**：WebSocket连接在弱网络环境下可能不稳定
- **并发压力**：高并发场景下需确保后端服务稳定性
- **浏览器兼容**：部分老版本浏览器对WebSocket支持有限
- **电池消耗**：移动端持续WebSocket连接会增加电池消耗

### 9.3 实施建议

1. **分阶段实施**：先实现基础WebSocket连接，再逐步添加实时功能
2. **降级策略**：网络异常时自动降级到轮询模式
3. **监控告警**：建立实时监控，及时发现连接异常
4. **用户教育**：通过UI提示告知用户实时功能的优势

### 9.4 后续规划

- **高级推荐算法**：基于机器学习的个性化推荐
- **预测性冲突检测**：提前预测可能发生的冲突
- **群组预约支持**：多人同时预约的冲突协调
- **智能调度优化**：系统主动优化时间安排
