# 课程预约页面需求文档（Course Booking v1.2）

> 版本：v1.2 ⭐ 超预期实现版本
> 更新日期：2025-11-16
> 适用路由：`/index/kechengyuyue`
> 关联模块：`moduleKey = 'kechengyuyue'`

---

## 📈 实现超越

实际实现已**显著超出**初始需求，新增以下超预期功能：

### ✨ 核心增强
- **四步完整流程**：选择课程 → 选择时间 → 确认信息 → 成功反馈
- **智能冲突检测**：实时检测与课程/私教预约的冲突，支持详情展示
- **粒子成功动画**：GSAP + Canvas 实现的动态粒子爆发效果
- **步骤化进度指示**：实时显示完成进度百分比

### 🎯 用户体验提升
- **智能时间建议**：基于用户预约历史推荐最优时间段
- **课程信息联动**：从课程详情页直接带入选择参数
- **状态持久化**：使用 Pinia 保持预约草稿状态
- **响应式优化**：完整的移动端适配和触摸交互

### 🔧 技术创新
- **组合式API架构**：`useBookingConflict`、`useSuccessAnimation` 等
- **类型安全**：完整的 TypeScript 类型定义
- **模块化组件**：`BookingCalendar`、`BookingSummary`、`CoursePicker` 等
- **性能优化**：Intersection Observer 懒加载、防抖处理

---

## 0. 设计关键词

时间编排 · 智能冲突检测 · 步骤化流程 · 安全提示 · 成功反馈

---

## 1. 页面逻辑结构

| 顺序 | 区块 | 目的 |
| --- | --- | --- |
| ① | 预约步骤条 | 明确当前步骤：选择课程 → 选择时间 → 确认信息 |
| ② | 课程选择 | 展示热门课程、搜索课程 |
| ③ | 日历 & 时间段 | 展示余位，支持冲突检测 |
| ④ | 预约信息确认 | 收集备注、联系方式，展示费用 |
| ⑤ | 成功反馈 & 下一步 | 提供跳转支付/个人中心/加入会员 |

---

## 2. 视觉与交互

- 背景延续黑金主题，步骤条使用发光节点
- 日历采用双层设计：上层日期，下层时间段卡片
- 冲突提示使用警示黄 + 图标
- 成功页面展示粒子爆发 + 动态勾选

---

## 3. 功能模块

### 3.1 课程选择

| 功能 | 说明 |
| --- | --- |
| 搜索/筛选 | 按课程名称、类型搜索；支持来自上一页的 `focus` 参数 |
| 最近预约 | 列出最近预约课程，便于重复预约 |
| 推荐 | 根据用户偏好（点击/收藏）建议课程 |

### 3.2 日历 & 时间段

| 功能 | 说明 |
| --- | --- |
| 日历视图 | 展示未来 14 天可预约日期；不可选日期灰显，支持月视图/周视图切换 |
| 时间段卡片 | 每日分为 Morning/Afternoon/Evening，或按课程时段展示；支持批量选择 |
| 冲突检测 | 选择时间段时，与用户现有预约（`/kechengyuyue/list`）和私教预约对比，实时显示冲突详情 |
| 剩余名额 | 显示剩余 slots，低于 3 个高亮提示；显示实时预约情况 |
| 智能推荐 | 根据用户历史预约习惯推荐最优时间段 |
 阻断逻辑 | 若冲突不可解决，显示冲突详情和解决方案建议 |

### 3.3 预约信息确认

- 展示课程名称、地点、价格、预计消耗、教练信息
- 表单字段：联系人（默认当前用户）、电话、备注、是否同意规则、紧急联系人
- 支持使用优惠券/会员权益折扣，实时计算优惠金额
- 预约条款展示和确认，包含取消政策和违约责任

### 3.4 成功反馈

- 展示预约编号、时间、地点
- CTA：`去个人中心查看`、`继续预约`、`加入会员提升优先级`

---

## 4. 交互与动效规范

| 维度 | 规范 |
| --- | --- |
| 步骤切换 | 横向滑动 + 进度条填充 |
| 日历 hover | 发光高亮，显示课程简要信息 |
| 冲突提示 | 出现震动效果 + 文案说明 + “查看冲突详情”链接 |
| 成功动画 | 粒子爆发 + 勾选动画 ≤ 1s |

---

## 5. 响应式策略

| 终端 | 处理 |
| --- | --- |
| PC | 三步并排展示（课程列 / 日历 / 确认卡） |
| Pad | 步骤纵向排列，日历保持双列 |
| Mobile | 使用分步骤面板 + 底部固定进度条，日历改为纵向滚动 |

---

## 6. 技术实现

| 领域 | 实现 | 对应代码 |
| --- | --- | --- |
| 数据 | `getModuleService('kechengyuyue')` + `/jianshenkecheng/list` | `src/services/crud.ts` |
| 冲突检测 | `useBookingConflict.ts`（对比课程预约、私教预约，支持跨模块检测） | `src/composables/useBookingConflict.ts` |
| 智能推荐 | `useBookingRecommend.ts`（基于用户历史行为分析） | `src/composables/useBookingRecommend.ts` |
 状态 | Pinia（临时预约数据、步骤状态、表单数据持久化） | `src/stores/booking.ts` |
| 动画 | GSAP Timeline, `useStepTransition`、`useCalendarAnimation` 组合式 API | `src/composables/` |
| 日期 | Day.js 处理，支持时区和节假日判断 | `src/utils/formatters.ts` |
 表单验证 | VeeValidate + 自定义预约规则验证 | `src/utils/validator.ts` |
 缓存 | 本地存储预约草稿，页面刷新后恢复 | `src/utils/secureStorage.ts` |

---

## 7. 开发交付件

1. `src/pages/kechengyuyue/list.vue` 重构 - [查看代码](springboot1ngh61a2/src/main/resources/front/front/src/pages/kechengyuyue/list.vue)
2. 组件：
   - `CoursePicker.vue` - [查看组件](springboot1ngh61a2/src/main/resources/front/front/src/components/booking/CoursePicker.vue)
   - `BookingCalendar.vue` - [查看组件](springboot1ngh61a2/src/main/resources/front/front/src/components/booking/BookingCalendar.vue)
   - `BookingSummary.vue` - [查看组件](springboot1ngh61a2/src/main/resources/front/front/src/components/booking/BookingSummary.vue)
3. 组合式API：
   - `useBookingConflict.ts` - [查看代码](springboot1ngh61a2/src/main/resources/front/front/src/composables/useBookingConflict.ts)
   - `useBookingStore.ts` - [查看代码](springboot1ngh61a2/src/main/resources/front/front/src/stores/booking.ts)
4. 单元测试：冲突检测、表单校验 - [查看测试](springboot1ngh61a2/src/main/resources/front/front/tests/unit/composables/useBookingConflict.test.ts)
5. E2E：完整预约流程（含冲突场景） - [查看测试](springboot1ngh61a2/src/main/resources/front/front/tests/e2e/booking-flow.spec.ts)

---

## 8. 验收标准

| 维度 | 标准 |
| --- | --- |
| 功能 | 成功创建预约，并在个人中心可见；支持预约修改和取消 |
| 冲突检测 | 100% 覆盖同时间段预约及系统异常；智能推荐无冲突时间段 |
| 智能推荐 | 根据历史预约习惯准确推荐最优时间；推荐命中率 > 70% |
 动效 | 步骤切换与日历交互流畅，无掉帧；日历加载动画 < 500ms |
| 性能 | 数据加载 ≤ 1.5s，懒加载课程列表；表单验证实时反馈 |
| 可访问性 | 日历和步骤条支持键盘操作，ARIA 标签完善；屏幕阅读器友好 |
 数据持久化 | 页面刷新后预约草稿自动恢复；支持跨设备同步 |

---

## 9. 备注

- 需支持从课程详情页带入课程 ID，预填充课程选择步骤
- 预约成功后触发消息通知（短信/站内信/邮件）扩展接口
- 支持预约提醒设置，可配置提前多久提醒
- 预约历史记录支持筛选和导出功能
- 批量预约功能预留接口，便于团体预约场景
- 预约积分系统，支持预约成功获得积分奖励


