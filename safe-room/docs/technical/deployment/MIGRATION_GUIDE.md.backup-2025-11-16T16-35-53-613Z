# è¿ç§»æŒ‡å—

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-16
> **ç»´æŠ¤è€…**: DevOpså›¢é˜Ÿ

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¥èº«æˆ¿ç»¼åˆç®¡ç†ç³»ç»Ÿä»ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼å‘ç°ä»£åŒ–äº‘åŸç”Ÿæ¶æ„çš„è¿ç§»ç­–ç•¥ï¼ŒåŒ…æ‹¬Docker Composeåˆ°Kubernetesçš„è¿ç§»ã€æ•°æ®è¿ç§»ã€åº”ç”¨é‡æ„ç­‰å®Œæ•´çš„è¿ç§»æ–¹æ¡ˆï¼Œç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

## ç›®å½•

- [1. è¿ç§»è§„åˆ’](#1-è¿ç§»è§„åˆ’)
- [2. Docker Compose åˆ° Kubernetes è¿ç§»](#2-docker-compose-åˆ°-kubernetes-è¿ç§»)
- [3. æ•°æ®è¿ç§»ç­–ç•¥](#3-æ•°æ®è¿ç§»ç­–ç•¥)
- [4. åº”ç”¨ç°ä»£åŒ–æ”¹é€ ](#4-åº”ç”¨ç°ä»£åŒ–æ”¹é€ )
- [5. é›¶åœæœºè¿ç§»æ–¹æ¡ˆ](#5-é›¶åœæœºè¿ç§»æ–¹æ¡ˆ)
- [6. æ··åˆè¿è¡ŒæœŸç®¡ç†](#6-æ··åˆè¿è¡ŒæœŸç®¡ç†)
- [7. å›æ»šç­–ç•¥](#7-å›æ»šç­–ç•¥)
- [8. æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)
- [9. ç›‘æ§å’ŒéªŒè¯](#9-ç›‘æ§å’ŒéªŒè¯)
- [10. è¿ç§»åçš„è¿ç»´](#10-è¿ç§»åçš„è¿ç»´)

---

## 1. è¿ç§»è§„åˆ’

### 1.1 è¿ç§»è¯„ä¼°

#### å½“å‰æ¶æ„åˆ†æ

```bash
# åˆ†æå½“å‰Docker Composeç¯å¢ƒ
cd /path/to/current/docker-compose
docker-compose ps
docker stats
docker system df

# æ”¶é›†åº”ç”¨ä¾èµ–å…³ç³»
docker-compose config > docker-compose-resolved.yaml

# åˆ†æç½‘ç»œæµé‡
docker network ls
docker network inspect fitness-network

# åˆ†ææ•°æ®å·ä½¿ç”¨æƒ…å†µ
docker volume ls
docker volume inspect fitness_db_data
```

#### è¿ç§»å¤æ‚åº¦è¯„ä¼°

```yaml
# è¿ç§»è¯„ä¼°æ¸…å•
migration_assessment:
  applications:
    - name: fitness-api
      complexity: medium
      dependencies: [postgresql, redis]
      stateful: false
      external_services: [payment-gateway]
    
    - name: fitness-frontend
      complexity: low
      dependencies: [fitness-api]
      stateful: false
      static_assets: true
    
    - name: fitness-db
      complexity: high
      dependencies: []
      stateful: true
      data_size: 50GB
    
    - name: fitness-cache
      complexity: low
      dependencies: []
      stateful: false
      persistence: false

  infrastructure:
    networking: docker-networks
    storage: docker-volumes
    secrets: environment-variables
    config: docker-compose.yml
    
  risks:
    - data_loss: medium
    - downtime: high
    - performance_degradation: low
    - compatibility_issues: medium

  timeline: 4-6 weeks
  team_resources: 3-4 engineers
```

### 1.2 è¿ç§»ç­–ç•¥é€‰æ‹©

#### è¿ç§»ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **å¤§çˆ†ç‚¸è¿ç§»** | å¿«é€Ÿã€ä¸€è‡´æ€§å¥½ | é«˜é£é™©ã€é•¿åœæœºæ—¶é—´ | å°å‹åº”ç”¨ã€æµ‹è¯•ç¯å¢ƒ |
| **è“ç»¿éƒ¨ç½²** | é›¶åœæœºã€å¯å¿«é€Ÿå›æ»š | éœ€è¦åŒå€èµ„æº | å…³é”®ä¸šåŠ¡ç³»ç»Ÿ |
| **é‡‘ä¸é›€å‘å¸ƒ** | æ¸è¿›å¼ã€ä½é£é™© | å¤æ‚ã€éœ€è¦ç›‘æ§ | å¤§å‹å¤æ‚ç³»ç»Ÿ |
| **æ··åˆè¿è¡Œ** | å¹³æ»‘è¿‡æ¸¡ã€æœ€å°é£é™© | ç»´æŠ¤æˆæœ¬é«˜ | é•¿æœŸè¿ç§»ç­–ç•¥ |

#### æ¨èè¿ç§»è·¯å¾„

```mermaid
graph TD
    A[è¯„ä¼°å½“å‰ç¯å¢ƒ] --> B[é€‰æ‹©è¿ç§»ç­–ç•¥]
    B --> C{ç­–ç•¥ç±»å‹}
    
    C --> D[è“ç»¿éƒ¨ç½²]
    C --> E[é‡‘ä¸é›€å‘å¸ƒ]
    C --> F[æ··åˆè¿è¡Œ]
    
    D --> G[å‡†å¤‡æ–°ç¯å¢ƒ]
    E --> G
    F --> H[é…ç½®æœåŠ¡ç½‘æ ¼]
    
    G --> I[æ•°æ®åŒæ­¥]
    H --> I
    
    I --> J[æµé‡åˆ‡æ¢]
    J --> K[éªŒè¯è¿ç§»]
    K --> L{éªŒè¯é€šè¿‡?}
    
    L --> M[æ¸…ç†æ—§ç¯å¢ƒ]
    L --> N[å›æ»š]
    
    N --> O[é—®é¢˜ä¿®å¤]
    O --> J
    
    M --> P[è¿ç§»å®Œæˆ]
```

### 1.3 è¿ç§»å›¢é˜Ÿç»„å»º

#### å›¢é˜Ÿè§’è‰²å®šä¹‰

```yaml
migration_team:
  project_manager:
    responsibilities:
      - åˆ¶å®šè¿ç§»è®¡åˆ’
      - åè°ƒå„æ–¹èµ„æº
      - é£é™©ç®¡ç†
      - è¿›åº¦è·Ÿè¸ª
    
  platform_engineer:
    responsibilities:
      - Kubernetesé›†ç¾¤æ­å»º
      - åŸºç¡€è®¾æ–½å³ä»£ç 
      - CI/CDæµæ°´çº¿
      - ç›‘æ§å‘Šè­¦é…ç½®
    
  application_developer:
    responsibilities:
      - åº”ç”¨å®¹å™¨åŒ–æ”¹é€ 
      - é…ç½®å¤–éƒ¨åŒ–
      - å¥åº·æ£€æŸ¥å®ç°
      - æ€§èƒ½è°ƒä¼˜
    
  database_administrator:
    responsibilities:
      - æ•°æ®è¿ç§»è®¾è®¡
      - æ•°æ®åº“é«˜å¯ç”¨é…ç½®
      - å¤‡ä»½æ¢å¤ç­–ç•¥
      - æ€§èƒ½ç›‘æ§
    
  qa_engineer:
    responsibilities:
      - è‡ªåŠ¨åŒ–æµ‹è¯•
      - æ€§èƒ½æµ‹è¯•
      - å…¼å®¹æ€§æµ‹è¯•
      - å›å½’æµ‹è¯•
    
  security_engineer:
    responsibilities:
      - å®‰å…¨è¯„ä¼°
      - åˆè§„æ£€æŸ¥
      - è®¿é—®æ§åˆ¶
      - åŠ å¯†é…ç½®
```

---

## 2. Docker Compose åˆ° Kubernetes è¿ç§»

### 2.1 åˆ†æç°æœ‰é…ç½®

#### Docker Compose é…ç½®è§£æ

```yaml
# docker-compose.yml åˆ†æ
version: '3.8'
services:
  fitness-api:
    image: fitness-gym/backend:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=fitness-db
      - DB_PASSWORD=${DB_PASSWORD}
    depends_on:
      - fitness-db
      - fitness-redis
    volumes:
      - ./logs:/app/logs
    networks:
      - fitness-network

  fitness-db:
    image: postgres:14
    environment:
      - POSTGRES_DB=fitness_gym
      - POSTGRES_USER=fitness_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - fitness_db_data:/var/lib/postgresql/data
    networks:
      - fitness-network

  fitness-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - fitness_redis_data:/data
    networks:
      - fitness-network

volumes:
  fitness_db_data:
  fitness_redis_data:

networks:
  fitness-network:
    driver: bridge
```

#### æœåŠ¡ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    A[fitness-api] --> B[fitness-db]
    A --> C[fitness-redis]
    A --> D[fitness-frontend]
    
    D --> A
    
    B --> E[(PostgreSQL Data)]
    C --> F[(Redis Data)]
    
    A --> G[External Services]
    G --> H[Payment Gateway]
    G --> I[Email Service]
```

### 2.2 åˆ›å»º Kubernetes èµ„æº

#### Namespace åˆ›å»º

```yaml
# fitness-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: fitness-prod
  labels:
    name: fitness-prod
    environment: production
    team: fitness-gym
spec: {}
---
# èµ„æºé…é¢
apiVersion: v1
kind: ResourceQuota
metadata:
  name: fitness-prod-quota
  namespace: fitness-prod
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    persistentvolumeclaims: "10"
    pods: "50"
    services: "20"
```

#### ConfigMap è¿ç§»

```yaml
# fitness-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fitness-config
  namespace: fitness-prod
data:
  # ä» environment å˜é‡è¿ç§»
  SPRING_PROFILES_ACTIVE: "prod"
  DB_HOST: "fitness-db-service"  # æœåŠ¡åç§°å˜åŒ–
  DB_PORT: "5432"
  DB_NAME: "fitness_gym"
  REDIS_HOST: "fitness-redis-service"
  REDIS_PORT: "6379"
  
  # æ–°å¢é…ç½®
  JAVA_OPTS: "-Xmx1g -Xms512m"
  LOG_LEVEL: "INFO"
  HEALTH_CHECK_PATH: "/actuator/health"
```

#### Secret è¿ç§»

```yaml
# fitness-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: fitness-secrets
  namespace: fitness-prod
type: Opaque
data:
  # ä»ç¯å¢ƒå˜é‡è¿ç§»ï¼Œbase64ç¼–ç 
  db-password: cG9zdGdyZXNfcGFzc3dvcmQ=  # postgres_password
  redis-password: cmVkaXNfcGFzc3dvcmQ=    # redis_password
  jwt-secret: eW91cl9qd3Rfc2VjcmV0X2tleQ==  # your_jwt_secret_key
```

#### Deployment è½¬æ¢

```yaml
# fitness-api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api
  namespace: fitness-prod
  labels:
    app: fitness-api
    version: v1.0.0
spec:
  replicas: 3  # ä»å•ä¸ªå®¹å™¨æ‰©å±•ä¸º3ä¸ªå‰¯æœ¬
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: fitness-api
  template:
    metadata:
      labels:
        app: fitness-api
        version: v1.0.0
    spec:
      containers:
      - name: fitness-api
        image: fitness-gym/backend:latest
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        env:
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: fitness-config
              key: SPRING_PROFILES_ACTIVE
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fitness-secrets
              key: db-password
        envFrom:
        - configMapRef:
            name: fitness-config
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        volumeMounts:
        - name: logs
          mountPath: /app/logs
      volumes:
      - name: logs
        emptyDir: {}
```

#### Service åˆ›å»º

```yaml
# fitness-api-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: fitness-api-service
  namespace: fitness-prod
  labels:
    app: fitness-api
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: fitness-api
---
# fitness-db-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: fitness-db-service
  namespace: fitness-prod
  labels:
    app: fitness-db
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
    name: postgresql
  selector:
    app: fitness-db
```

#### PersistentVolumeClaim è½¬æ¢

```yaml
# fitness-db-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fitness-db-pvc
  namespace: fitness-prod
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard  # æŒ‡å®šå­˜å‚¨ç±»
  resources:
    requests:
      storage: 50Gi  # ä» docker volume å¤§å°æ˜ å°„

---
# fitness-redis-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fitness-redis-pvc
  namespace: fitness-prod
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard
  resources:
    requests:
      storage: 8Gi
```

### 2.3 æ•°æ®åº“è¿ç§»

#### PostgreSQL StatefulSet

```yaml
# fitness-db-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: fitness-db
  namespace: fitness-prod
spec:
  serviceName: fitness-db-service
  replicas: 1
  selector:
    matchLabels:
      app: fitness-db
  template:
    metadata:
      labels:
        app: fitness-db
    spec:
      containers:
      - name: postgresql
        image: postgres:14
        ports:
        - containerPort: 5432
          name: postgresql
        env:
        - name: POSTGRES_DB
          valueFrom:
            configMapKeyRef:
              name: fitness-config
              key: DB_NAME
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              name: fitness-config
              key: DB_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fitness-secrets
              key: db-password
        volumeMounts:
        - name: fitness-db-data
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - fitness_user
            - -d
            - fitness_gym
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - fitness_user
            - -d
            - fitness_gym
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: fitness-db-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: standard
      resources:
        requests:
          storage: 50Gi
```

#### Redis Deployment

```yaml
# fitness-redis-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-redis
  namespace: fitness-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fitness-redis
  template:
    metadata:
      labels:
        app: fitness-redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
          name: redis
        command: ["redis-server", "--appendonly", "yes"]
        volumeMounts:
        - name: fitness-redis-data
          mountPath: /data
        livenessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: fitness-redis-data
        persistentVolumeClaim:
          claimName: fitness-redis-pvc
```

### 2.4 Ingress é…ç½®

```yaml
# fitness-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fitness-ingress
  namespace: fitness-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.fitness-gym.com
    - www.fitness-gym.com
    secretName: fitness-gym-tls
  rules:
  - host: api.fitness-gym.com
    http:
      paths:
      - path: /springboot1ngh61a2
        pathType: Prefix
        backend:
          service:
            name: fitness-api-service
            port:
              number: 8080
  - host: www.fitness-gym.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: fitness-frontend-service
            port:
              number: 80
```

### 2.5 è¿ç§»æ‰§è¡Œè„šæœ¬

```bash
#!/bin/bash
# Docker Compose åˆ° Kubernetes è¿ç§»è„šæœ¬

set -e

echo "å¼€å§‹è¿ç§»å¥èº«æˆ¿ç®¡ç†ç³»ç»Ÿ..."

# 1. éªŒè¯å½“å‰ç¯å¢ƒ
echo "æ­¥éª¤1: éªŒè¯å½“å‰Docker Composeç¯å¢ƒ"
docker-compose ps
if [ $? -ne 0 ]; then
    echo "é”™è¯¯: Docker Composeç¯å¢ƒå¼‚å¸¸"
    exit 1
fi

# 2. åˆ›å»ºKubernetesèµ„æº
echo "æ­¥éª¤2: åˆ›å»ºKuberneteså‘½åç©ºé—´å’Œé…ç½®"
kubectl apply -f fitness-namespace.yaml
kubectl apply -f fitness-configmap.yaml
kubectl apply -f fitness-secrets.yaml

# 3. éƒ¨ç½²æ•°æ®åº“ï¼ˆå…ˆéƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡ï¼‰
echo "æ­¥éª¤3: éƒ¨ç½²PostgreSQLæ•°æ®åº“"
kubectl apply -f fitness-db-pvc.yaml
kubectl apply -f fitness-db-service.yaml
kubectl apply -f fitness-db-statefulset.yaml

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
kubectl wait --for=condition=ready pod -l app=fitness-db --timeout=300s -n fitness-prod

# 4. è¿ç§»æ•°æ®
echo "æ­¥éª¤4: æ‰§è¡Œæ•°æ®è¿ç§»"
./migrate-database.sh

# 5. éƒ¨ç½²Redisç¼“å­˜
echo "æ­¥éª¤5: éƒ¨ç½²Redisç¼“å­˜"
kubectl apply -f fitness-redis-pvc.yaml
kubectl apply -f fitness-redis-deployment.yaml
kubectl apply -f fitness-redis-service.yaml

# ç­‰å¾…Rediså°±ç»ª
kubectl wait --for=condition=ready pod -l app=fitness-redis --timeout=180s -n fitness-prod

# 6. éƒ¨ç½²åº”ç”¨æœåŠ¡
echo "æ­¥éª¤6: éƒ¨ç½²åº”ç”¨æœåŠ¡"
kubectl apply -f fitness-api-deployment.yaml
kubectl apply -f fitness-api-service.yaml

# ç­‰å¾…åº”ç”¨å°±ç»ª
kubectl wait --for=condition=ready pod -l app=fitness-api --timeout=300s -n fitness-prod

# 7. éƒ¨ç½²Ingress
echo "æ­¥éª¤7: é…ç½®Ingress"
kubectl apply -f fitness-ingress.yaml

# 8. éªŒè¯è¿ç§»
echo "æ­¥éª¤8: éªŒè¯è¿ç§»ç»“æœ"
./validate-migration.sh

echo "è¿ç§»å®Œæˆï¼"
echo "æ—§ç¯å¢ƒä»åœ¨è¿è¡Œï¼Œå¯ä»¥è¿›è¡Œæµé‡åˆ‡æ¢æµ‹è¯•"
```

---

## 3. æ•°æ®è¿ç§»ç­–ç•¥

### 3.1 æ•°æ®åº“è¿ç§»

#### é€»è¾‘å¤‡ä»½å’Œæ¢å¤

```bash
#!/bin/bash
# PostgreSQL æ•°æ®è¿ç§»è„šæœ¬

# æºæ•°æ®åº“ä¿¡æ¯
SOURCE_HOST="localhost"
SOURCE_DB="fitness_gym"
SOURCE_USER="fitness_user"

# ç›®æ ‡æ•°æ®åº“ä¿¡æ¯
TARGET_HOST="fitness-db-service"
TARGET_DB="fitness_gym"
TARGET_USER="fitness_user"

# 1. åˆ›å»ºæºæ•°æ®åº“å¤‡ä»½
echo "åˆ›å»ºæºæ•°æ®åº“å¤‡ä»½..."
docker exec fitness-db pg_dump -h $SOURCE_HOST -U $SOURCE_USER -d $SOURCE_DB --no-owner --no-acl > fitness_backup.sql

# 2. è¿ç§»æ•°æ®åˆ°ç›®æ ‡æ•°æ®åº“
echo "è¿ç§»æ•°æ®åˆ°ç›®æ ‡æ•°æ®åº“..."
kubectl exec -n fitness-prod deployment/fitness-db -- bash -c "
psql -U $TARGET_USER -d $TARGET_DB -f - < /dev/stdin
" < fitness_backup.sql

# 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
echo "éªŒè¯æ•°æ®è¿ç§»..."
SOURCE_COUNT=$(docker exec fitness-db psql -h $SOURCE_HOST -U $SOURCE_USER -d $SOURCE_DB -t -c "SELECT COUNT(*) FROM users;")
TARGET_COUNT=$(kubectl exec -n fitness-prod deployment/fitness-db -- psql -U $TARGET_USER -d $TARGET_DB -t -c "SELECT COUNT(*) FROM users;")

if [ "$SOURCE_COUNT" -eq "$TARGET_COUNT" ]; then
    echo "æ•°æ®è¿ç§»éªŒè¯é€šè¿‡"
else
    echo "æ•°æ®è¿ç§»éªŒè¯å¤±è´¥"
    exit 1
fi
```

#### æŒç»­æ•°æ®åŒæ­¥

```bash
#!/bin/bash
# ä½¿ç”¨pglogicalè¿›è¡ŒæŒç»­åŒæ­¥

# åœ¨æºæ•°æ®åº“ä¸Šå®‰è£…pglogical
docker exec fitness-db psql -U postgres -d fitness_gym -c "
CREATE EXTENSION pglogical;
SELECT pglogical.create_node(node_name := 'source_node', dsn := 'host=localhost port=5432 user=postgres dbname=fitness_gym');
SELECT pglogical.replication_set_add_table(set_name := 'default', relation := 'users', synchronize_data := true);
SELECT pglogical.replication_set_add_table(set_name := 'default', relation := 'courses', synchronize_data := true);
SELECT pglogical.replication_set_add_table(set_name := 'default', relation := 'bookings', synchronize_data := true);
"

# åœ¨ç›®æ ‡æ•°æ®åº“ä¸Šé…ç½®è®¢é˜…
kubectl exec -n fitness-prod deployment/fitness-db -- psql -U postgres -d fitness_gym -c "
CREATE EXTENSION pglogical;
SELECT pglogical.create_node(node_name := 'target_node', dsn := 'host=localhost port=5432 user=postgres dbname=fitness_gym');
SELECT pglogical.create_subscription(subscription_name := 'fitness_sync', provider_dsn := 'host=docker-host port=5432 user=postgres dbname=fitness_gym');
"

# ç›‘æ§åŒæ­¥çŠ¶æ€
kubectl exec -n fitness-prod deployment/fitness-db -- psql -U postgres -d fitness_gym -c "
SELECT * FROM pglogical.show_subscription_status();
"
```

### 3.2 æ–‡ä»¶å’Œé…ç½®è¿ç§»

#### é™æ€æ–‡ä»¶è¿ç§»

```bash
#!/bin/bash
# é™æ€æ–‡ä»¶è¿ç§»è„šæœ¬

# 1. æ‰“åŒ…é™æ€æ–‡ä»¶
docker exec fitness-app tar czf /tmp/static-files.tar.gz -C /app static/

# 2. å¤åˆ¶åˆ°æœ¬åœ°
docker cp fitness-app:/tmp/static-files.tar.gz .

# 3. ä¸Šä¼ åˆ°KubernetesæŒä¹…å·æˆ–å¯¹è±¡å­˜å‚¨
# é€‰é¡¹1: å¤åˆ¶åˆ°PV
kubectl cp static-files.tar.gz fitness-prod/fitness-api-pod:/tmp/
kubectl exec -n fitness-prod fitness-api-pod -- tar xzf /tmp/static-files.tar.gz -C /app/static/

# é€‰é¡¹2: ä¸Šä¼ åˆ°MinIOå¯¹è±¡å­˜å‚¨
mc cp static-files.tar.gz myminio/fitness-files/

# 4. éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
SOURCE_MD5=$(docker exec fitness-app find /app/static -type f -exec md5sum {} \; | sort | md5sum)
TARGET_MD5=$(kubectl exec -n fitness-prod fitness-api-pod -- find /app/static -type f -exec md5sum {} \; | sort | md5sum)

if [ "$SOURCE_MD5" == "$TARGET_MD5" ]; then
    echo "é™æ€æ–‡ä»¶è¿ç§»éªŒè¯é€šè¿‡"
else
    echo "é™æ€æ–‡ä»¶è¿ç§»éªŒè¯å¤±è´¥"
    exit 1
fi
```

#### é…ç½®è¿ç§»

```bash
#!/bin/bash
# é…ç½®è¿ç§»è„šæœ¬

# 1. æå–Docker Composeé…ç½®
docker-compose config > docker-compose-resolved.yml

# 2. è½¬æ¢ç¯å¢ƒå˜é‡
# æå–ç¯å¢ƒå˜é‡
grep -o '\${[^}]*}' docker-compose-resolved.yml | sort | uniq > env_vars.txt

# 3. åˆ›å»ºKubernetes ConfigMapå’ŒSecret
# ä»ç¯å¢ƒå˜é‡æ–‡ä»¶ç”Ÿæˆ
kubectl create configmap fitness-config --from-env-file=env.list -n fitness-prod
kubectl create secret generic fitness-secrets --from-env-file=secrets.list -n fitness-prod

# 4. éªŒè¯é…ç½®
kubectl get configmap fitness-config -o yaml -n fitness-prod
kubectl get secret fitness-secrets -o yaml -n fitness-prod
```

### 3.3 å¤§æ•°æ®é‡è¿ç§»

#### åˆ†æ‰¹è¿ç§»ç­–ç•¥

```bash
#!/bin/bash
# å¤§æ•°æ®é‡åˆ†æ‰¹è¿ç§»è„šæœ¬

BATCH_SIZE=10000
TABLES=("users" "courses" "bookings" "payments")

for table in "${TABLES[@]}"; do
    echo "è¿ç§»è¡¨: $table"
    
    # è·å–æ€»è®°å½•æ•°
    TOTAL_COUNT=$(docker exec fitness-db psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM $table;")
    
    # è®¡ç®—æ‰¹æ¬¡æ•°
    BATCH_COUNT=$(( (TOTAL_COUNT + BATCH_SIZE - 1) / BATCH_SIZE ))
    
    for ((batch=0; batch<BATCH_COUNT; batch++)); do
        OFFSET=$((batch * BATCH_SIZE))
        
        echo "è¿ç§»æ‰¹æ¬¡ $((batch+1))/$BATCH_COUNT (åç§»: $OFFSET)"
        
        # å¯¼å‡ºæ‰¹æ¬¡æ•°æ®
        docker exec fitness-db psql -U fitness_user -d fitness_gym -c "
        \COPY (SELECT * FROM $table ORDER BY id LIMIT $BATCH_SIZE OFFSET $OFFSET) TO '/tmp/${table}_batch_${batch}.csv' WITH CSV HEADER;
        "
        
        # å¯¼å…¥åˆ°ç›®æ ‡æ•°æ®åº“
        docker cp fitness-db:/tmp/${table}_batch_${batch}.csv .
        kubectl cp ${table}_batch_${batch}.csv fitness-prod/fitness-db-pod:/tmp/
        
        kubectl exec -n fitness-prod fitness-db-pod -- psql -U fitness_user -d fitness_gym -c "
        \COPY $table FROM '/tmp/${table}_batch_${batch}.csv' WITH CSV HEADER;
        "
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm ${table}_batch_${batch}.csv
        
        # éªŒè¯æ‰¹æ¬¡å®Œæ•´æ€§
        BATCH_TARGET_COUNT=$(kubectl exec -n fitness-prod fitness-db-pod -- psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM $table;")
        echo "ç›®æ ‡æ•°æ®åº“è®°å½•æ•°: $BATCH_TARGET_COUNT"
    done
done

echo "åˆ†æ‰¹è¿ç§»å®Œæˆ"
```

---

## 4. åº”ç”¨ç°ä»£åŒ–æ”¹é€ 

### 4.1 å®¹å™¨åŒ–æ”¹é€ 

#### Dockerfile ä¼˜åŒ–

```dockerfile
# ä¼˜åŒ–åçš„ç”Ÿäº§çº§Dockerfile
FROM eclipse-temurin:21-jre-jammy AS runtime

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r fitness && useradd -r -g fitness fitness

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs && chown -R fitness:fitness /app

# å¤åˆ¶åº”ç”¨JARåŒ…
COPY --chown=fitness:fitness target/fitness-gym-*.jar app.jar

# é…ç½®JVMå‚æ•°
ENV JAVA_OPTS="-Xmx1g -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGCDetails -XX:+PrintGCTimeStamps"

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER fitness

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

```dockerfile
# å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
FROM maven:3.9.4-eclipse-temurin-21-alpine AS builder

WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline -B

COPY src ./src
RUN mvn clean package -DskipTests -Dmaven.test.skip=true

# ç”Ÿäº§é•œåƒ
FROM eclipse-temurin:21-jre-alpine AS production

RUN addgroup -g 1001 -S fitness && \
    adduser -u 1001 -S fitness -G fitness

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶JAR
COPY --from=builder --chown=fitness:fitness /app/target/*.jar app.jar

# å®‰å…¨é…ç½®
RUN apk add --no-cache curl && \
    rm -rf /var/cache/apk/*

USER fitness

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 4.2 é…ç½®å¤–éƒ¨åŒ–

#### Spring Boot é…ç½®ç°ä»£åŒ–

```yaml
# application.yml - å¤–éƒ¨åŒ–é…ç½®
server:
  port: 8080
  shutdown: graceful

spring:
  application:
    name: fitness-gym-api
  
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:prod}
  
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:fitness_gym}
    username: ${DB_USER:fitness_user}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: ${DB_MAX_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:20000}
  
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD}
    timeout: 2000ms
    database: ${REDIS_DB:0}

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: ${SHOW_SQL:false}
  
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI:http://localhost:8080}

logging:
  level:
    com.fitness.gym: ${LOG_LEVEL:INFO}
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /app/logs/fitness-gym.log
    max-size: 100MB
    max-history: 30

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true

# åº”ç”¨ç‰¹å®šé…ç½®
fitness:
  gym:
    name: ${GYM_NAME:"Fitness Gym"}
    max-members: ${MAX_MEMBERS:1000}
    features:
      online-booking: ${ENABLE_ONLINE_BOOKING:true}
      payment-integration: ${ENABLE_PAYMENT:true}
```

### 4.3 å¥åº·æ£€æŸ¥å’Œç›‘æ§

#### Spring Boot Actuator é…ç½®

```java
@Configuration
public class MonitoringConfig {

    @Bean
    public MeterRegistry meterRegistry() {
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }

    @Bean
    public HealthIndicator dbHealthIndicator(DataSource dataSource) {
        return new DataSourceHealthIndicator(dataSource);
    }

    @Bean
    public HealthIndicator redisHealthIndicator(RedisConnectionFactory redisConnectionFactory) {
        return new RedisHealthIndicator(redisConnectionFactory);
    }
}
```

#### è‡ªå®šä¹‰å¥åº·æ£€æŸ¥

```java
@Component
public class BusinessHealthIndicator implements HealthIndicator {

    @Autowired
    private BookingRepository bookingRepository;

    @Override
    public Health health() {
        try {
            // æ£€æŸ¥ä¸šåŠ¡é€»è¾‘å¥åº·çŠ¶æ€
            long recentBookings = bookingRepository.countBookingsLastHour();
            
            if (recentBookings >= 0) {
                return Health.up()
                    .withDetail("recentBookings", recentBookings)
                    .build();
            } else {
                return Health.down()
                    .withDetail("error", "Unable to query recent bookings")
                    .build();
            }
        } catch (Exception e) {
            return Health.down(e)
                .withDetail("error", "Database connection failed")
                .build();
        }
    }
}
```

### 4.4 åº”ç”¨æ€§èƒ½ä¼˜åŒ–

#### JVMè°ƒä¼˜

```yaml
# Kubernetesä¸­çš„JVMé…ç½®
env:
- name: JAVA_OPTS
  value: |
    -Xmx1024m
    -Xms512m
    -XX:+UseG1GC
    -XX:MaxGCPauseMillis=200
    -XX:+PrintGCDetails
    -XX:+PrintGCTimeStamps
    -XX:+PrintGCApplicationStoppedTime
    -Xloggc:/app/logs/gc.log
    -XX:+UseGCLogFileRotation
    -XX:NumberOfGCLogFiles=5
    -XX:GCLogFileSize=10m
    -Djava.security.egd=file:/dev/./urandom
```

#### è¿æ¥æ± ä¼˜åŒ–

```yaml
# HikariCPè¿æ¥æ± é…ç½®
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000
      leak-detection-threshold: 60000
      validation-timeout: 5000
      keepalive-time: 0
```

---

## 5. é›¶åœæœºè¿ç§»æ–¹æ¡ˆ

### 5.1 è“ç»¿éƒ¨ç½²è¿ç§»

#### è“ç»¿ç¯å¢ƒå‡†å¤‡

```yaml
# è“è‰²ç¯å¢ƒï¼ˆå½“å‰ç”Ÿäº§ç¯å¢ƒï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api-blue
  namespace: fitness-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fitness-api
      color: blue
  template:
    metadata:
      labels:
        app: fitness-api
        color: blue
        version: v1.0.0
    spec:
      containers:
      - name: fitness-api
        image: fitness-gym/api:v1.0.0
        # ... å…¶ä»–é…ç½®

---
# ç»¿è‰²ç¯å¢ƒï¼ˆæ–°Kubernetesç¯å¢ƒï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api-green
  namespace: fitness-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fitness-api
      color: green
  template:
    metadata:
      labels:
        app: fitness-api
        color: green
        version: v2.0.0
    spec:
      containers:
      - name: fitness-api
        image: fitness-gym/api:v2.0.0
        # ... å…¶ä»–é…ç½®
```

#### æœåŠ¡åˆ‡æ¢é…ç½®

```yaml
# è“è‰²æœåŠ¡
apiVersion: v1
kind: Service
metadata:
  name: fitness-api-blue
  namespace: fitness-prod
spec:
  selector:
    app: fitness-api
    color: blue
  ports:
  - port: 8080
    targetPort: 8080

---
# ç»¿è‰²æœåŠ¡
apiVersion: v1
kind: Service
metadata:
  name: fitness-api-green
  namespace: fitness-prod
spec:
  selector:
    app: fitness-api
    color: green
  ports:
  - port: 8080
    targetPort: 8080

---
# ä¸»æœåŠ¡ï¼ˆå¯åˆ‡æ¢é€‰æ‹©å™¨ï¼‰
apiVersion: v1
kind: Service
metadata:
  name: fitness-api-service
  namespace: fitness-prod
spec:
  selector:
    app: fitness-api
    color: blue  # åˆå§‹æŒ‡å‘è“è‰²ç¯å¢ƒ
  ports:
  - port: 8080
    targetPort: 8080
```

#### æµé‡åˆ‡æ¢è„šæœ¬

```bash
#!/bin/bash
# è“ç»¿éƒ¨ç½²æµé‡åˆ‡æ¢è„šæœ¬

ENVIRONMENT=$1  # "blue" æˆ– "green"

if [ "$ENVIRONMENT" != "blue" ] && [ "$ENVIRONMENT" != "green" ]; then
    echo "æ— æ•ˆçš„ç¯å¢ƒå‚æ•°ã€‚ä½¿ç”¨: blue æˆ– green"
    exit 1
fi

echo "åˆ‡æ¢åˆ° $ENVIRONMENT ç¯å¢ƒ..."

# æ›´æ–°æœåŠ¡é€‰æ‹©å™¨
kubectl patch service fitness-api-service -n fitness-prod --type='json' -p="[
  {
    'op': 'replace',
    'path': '/spec/selector/color',
    'value': '$ENVIRONMENT'
  }
]"

# éªŒè¯åˆ‡æ¢
echo "éªŒè¯æœåŠ¡åˆ‡æ¢..."
kubectl get service fitness-api-service -n fitness-prod -o jsonpath='{.spec.selector}'

# æ£€æŸ¥PodçŠ¶æ€
echo "æ£€æŸ¥ $ENVIRONMENT ç¯å¢ƒPodçŠ¶æ€..."
kubectl get pods -l app=fitness-api,color=$ENVIRONMENT -n fitness-prod

# æ‰§è¡Œå†’çƒŸæµ‹è¯•
echo "æ‰§è¡Œå†’çƒŸæµ‹è¯•..."
if smoke_test $ENVIRONMENT; then
    echo "âœ… åˆ‡æ¢æˆåŠŸï¼Œ$ENVIRONMENT ç¯å¢ƒè¿è¡Œæ­£å¸¸"
else
    echo "âŒ å†’çƒŸæµ‹è¯•å¤±è´¥ï¼Œæ­£åœ¨å›æ»š..."
    
    # è‡ªåŠ¨å›æ»š
    if [ "$ENVIRONMENT" = "green" ]; then
        kubectl patch service fitness-api-service -n fitness-prod --type='json' -p="[
          {
            'op': 'replace',
            'path': '/spec/selector/color',
            'value': 'blue'
          }
        ]"
        echo "å·²å›æ»šåˆ°è“è‰²ç¯å¢ƒ"
    fi
fi
```

### 5.2 é‡‘ä¸é›€å‘å¸ƒè¿ç§»

#### é‡‘ä¸é›€éƒ¨ç½²é…ç½®

```yaml
# ä¸»éƒ¨ç½²ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api-primary
  namespace: fitness-prod
spec:
  replicas: 9  # 90% æµé‡
  selector:
    matchLabels:
      app: fitness-api
  template:
    metadata:
      labels:
        app: fitness-api
        version: v1.0.0
    spec:
      containers:
      - name: fitness-api
        image: fitness-gym/api:v1.0.0

---
# é‡‘ä¸é›€éƒ¨ç½²ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api-canary
  namespace: fitness-prod
spec:
  replicas: 1  # 10% æµé‡
  selector:
    matchLabels:
      app: fitness-api
      track: canary
  template:
    metadata:
      labels:
        app: fitness-api
        track: canary
        version: v2.0.0
    spec:
      containers:
      - name: fitness-api
        image: fitness-gym/api:v2.0.0
```

#### Istioæµé‡è·¯ç”±

```yaml
# Istio VirtualService for é‡‘ä¸é›€å‘å¸ƒ
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fitness-api-canary
  namespace: fitness-prod
spec:
  hosts:
  - api.fitness-gym.com
  http:
  - match:
    - headers:
        user-agent:
          regex: ".*Chrome.*"  # åŸºäºç”¨æˆ·ä»£ç†çš„é‡‘ä¸é›€
    route:
    - destination:
        host: fitness-api-service
        subset: canary
      weight: 10
    - destination:
        host: fitness-api-service
        subset: stable
      weight: 90
  - route:
    - destination:
        host: fitness-api-service
        subset: stable

---
# DestinationRule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: fitness-api-destinationrule
  namespace: fitness-prod
spec:
  host: fitness-api-service
  subsets:
  - name: stable
    labels:
      version: v1.0.0
  - name: canary
    labels:
      version: v2.0.0
      track: canary
```

### 5.3 æ··åˆè¿è¡Œç­–ç•¥

#### æœåŠ¡ç½‘æ ¼é…ç½®

```yaml
# Istio Gateway é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: fitness-gateway
  namespace: fitness-prod
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - api.fitness-gym.com

---
# VirtualService è·¯ç”±é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fitness-api-routing
  namespace: fitness-prod
spec:
  hosts:
  - api.fitness-gym.com
  http:
  - match:
    - uri:
        prefix: "/api/v2"  # æ–°APIç‰ˆæœ¬è·¯ç”±åˆ°Kubernetes
    route:
    - destination:
        host: fitness-api-service
        port:
          number: 8080
  - route:  # é»˜è®¤è·¯ç”±åˆ°Docker Compose
    - destination:
        host: docker-compose-service
        port:
          number: 8080
```

---

## 6. æ··åˆè¿è¡ŒæœŸç®¡ç†

### 6.1 åŒç¯å¢ƒç›‘æ§

#### ç»¼åˆç›‘æ§é…ç½®

```yaml
# Prometheus é…ç½®åŒæ—¶ç›‘æ§ä¸¤ä¸ªç¯å¢ƒ
scrape_configs:
  - job_name: 'docker-compose-apps'
    static_configs:
      - targets: ['docker-host:9090']  # Docker Composeç¯å¢ƒä¸­çš„åº”ç”¨
    metrics_path: '/springboot1ngh61a2/actuator/prometheus'
    
  - job_name: 'kubernetes-apps'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: keep
      regex: /actuator/prometheus

  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
      - role: service
    metrics_path: '/springboot1ngh61a2/actuator/prometheus'
```

#### æ•°æ®ä¸€è‡´æ€§ç›‘æ§

```bash
#!/bin/bash
# æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬

echo "æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§..."

# æ£€æŸ¥ç”¨æˆ·è¡¨
DOCKER_USER_COUNT=$(docker exec fitness-db psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM users;")
K8S_USER_COUNT=$(kubectl exec -n fitness-prod deployment/fitness-db -- psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM users;")

if [ "$DOCKER_USER_COUNT" -ne "$K8S_USER_COUNT" ]; then
    echo "è­¦å‘Š: ç”¨æˆ·è¡¨æ•°æ®ä¸ä¸€è‡´ (Docker: $DOCKER_USER_COUNT, K8s: $K8S_USER_COUNT)"
    # å‘é€å‘Šè­¦
else
    echo "ç”¨æˆ·è¡¨æ•°æ®ä¸€è‡´: $DOCKER_USER_COUNT è®°å½•"
fi

# æ£€æŸ¥é¢„è®¢è¡¨ï¼ˆå…³é”®ä¸šåŠ¡æ•°æ®ï¼‰
DOCKER_BOOKING_COUNT=$(docker exec fitness-db psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM bookings WHERE created_at >= CURRENT_DATE;")
K8S_BOOKING_COUNT=$(kubectl exec -n fitness-prod deployment/fitness-db -- psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM bookings WHERE created_at >= CURRENT_DATE;")

if [ "$DOCKER_BOOKING_COUNT" -ne "$K8S_BOOKING_COUNT" ]; then
    echo "é”™è¯¯: å½“æ—¥é¢„è®¢æ•°æ®ä¸ä¸€è‡´ (Docker: $DOCKER_BOOKING_COUNT, K8s: $K8S_BOOKING_COUNT)"
    # è§¦å‘åŒæ­¥æˆ–å‘Šè­¦
else
    echo "å½“æ—¥é¢„è®¢æ•°æ®ä¸€è‡´: $DOCKER_BOOKING_COUNT è®°å½•"
fi
```

### 6.2 æµé‡ç®¡ç†

#### åŸºäºæƒé‡çš„æµé‡åˆ†é…

```yaml
# Istio DestinationRule with æƒé‡
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fitness-api-traffic-split
  namespace: fitness-prod
spec:
  hosts:
  - api.fitness-gym.com
  http:
  - route:
    - destination:
        host: docker-compose-service
      weight: 70  # 70% æµé‡åˆ°æ—§ç¯å¢ƒ
    - destination:
        host: kubernetes-service
      weight: 30  # 30% æµé‡åˆ°æ–°ç¯å¢ƒ
```

#### åŸºäºå†…å®¹çš„è·¯ç”±

```yaml
# åŸºäºè¯·æ±‚å†…å®¹çš„è·¯ç”±
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fitness-api-content-routing
  namespace: fitness-prod
spec:
  hosts:
  - api.fitness-gym.com
  http:
  - match:
    - headers:
        x-api-version:
          exact: "v2"  # æ–°APIç‰ˆæœ¬è·¯ç”±åˆ°Kubernetes
    route:
    - destination:
        host: kubernetes-service
  - match:
    - uri:
        prefix: "/api/v2"  # v2 APIè·¯ç”±åˆ°Kubernetes
    route:
    - destination:
        host: kubernetes-service
  - route:  # é»˜è®¤è·¯ç”±åˆ°Docker Compose
    - destination:
        host: docker-compose-service
```

### 6.3 åŒæ­¥æœºåˆ¶

#### æ•°æ®åº“åŒå†™

```java
@Service
public class DualWriteBookingService {

    @Autowired
    private BookingService dockerComposeService;
    
    @Autowired
    private BookingService kubernetesService;

    @Transactional
    public Booking createBooking(CreateBookingRequest request) {
        Booking booking = null;
        
        try {
            // åŒæ—¶å†™å…¥ä¸¤ä¸ªç¯å¢ƒ
            booking = dockerComposeService.createBooking(request);
            
            // å¼‚æ­¥å†™å…¥Kubernetesç¯å¢ƒ
            CompletableFuture.runAsync(() -> {
                try {
                    kubernetesService.createBooking(request);
                } catch (Exception e) {
                    log.error("Failed to write to Kubernetes environment", e);
                    // è®°å½•é”™è¯¯ï¼Œç¨åé‡è¯•
                }
            });
            
        } catch (Exception e) {
            log.error("Failed to create booking", e);
            throw e;
        }
        
        return booking;
    }
}
```

#### ç¼“å­˜åŒæ­¥

```java
@Configuration
public class DualCacheConfig {

    @Bean
    public CacheManager dualCacheManager(
            @Qualifier("dockerRedisTemplate") RedisTemplate dockerRedis,
            @Qualifier("k8sRedisTemplate") RedisTemplate k8sRedis) {
        
        return new DualRedisCacheManager(dockerRedis, k8sRedis);
    }
}

public class DualRedisCacheManager implements CacheManager {

    @Override
    public Cache getCache(String name) {
        return new DualRedisCache(name, dockerRedis, k8sRedis);
    }
}

public class DualRedisCache implements Cache {

    @Override
    public void put(Object key, Object value) {
        // åŒæ—¶å†™å…¥ä¸¤ä¸ªRediså®ä¾‹
        dockerRedis.opsForValue().set(key, value);
        k8sRedis.opsForValue().set(key, value);
    }

    @Override
    public ValueWrapper get(Object key) {
        // ä»ä»»ä¸€å®ä¾‹è¯»å–
        ValueWrapper value = dockerRedis.opsForValue().get(key);
        if (value == null) {
            value = k8sRedis.opsForValue().get(key);
        }
        return value;
    }
}
```

---

## 7. å›æ»šç­–ç•¥

### 7.1 è‡ªåŠ¨å›æ»š

#### åŸºäºç›‘æ§çš„å›æ»š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: migration-rollback
    rules:
      - alert: MigrationErrorRateHigh
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High error rate after migration"
          description: "Error rate is {{ $value }}% after migration to Kubernetes"

      - alert: MigrationLatencyHigh
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High latency after migration"
          description: "95th percentile latency is {{ $value }}s after migration"
```

#### è‡ªåŠ¨å›æ»šè„šæœ¬

```bash
#!/bin/bash
# è‡ªåŠ¨å›æ»šè„šæœ¬

# æ£€æŸ¥å…³é”®æŒ‡æ ‡
ERROR_RATE=$(curl -s "http://prometheus:9090/api/v1/query?query=http_error_rate" | jq -r '.data.result[0].value[1]')
LATENCY=$(curl -s "http://prometheus:9090/api/v1/query?query=http_latency_95p" | jq -r '.data.result[0].value[1]')

ERROR_THRESHOLD=0.05
LATENCY_THRESHOLD=2.0

if (( $(echo "$ERROR_RATE > $ERROR_THRESHOLD" | bc -l) )) || (( $(echo "$LATENCY > $LATENCY_THRESHOLD" | bc -l) )); then
    echo "æ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜ï¼Œå¼€å§‹å›æ»š..."
    
    # åˆ‡æ¢å›Docker Composeç¯å¢ƒ
    kubectl patch service fitness-api-service -n fitness-prod --type='json' -p='[
      {
        "op": "replace",
        "path": "/spec/selector/color",
        "value": "blue"
      }
    ]'
    
    # é€šçŸ¥å›¢é˜Ÿ
    curl -X POST $SLACK_WEBHOOK \
      -H 'Content-type: application/json' \
      -d "{\"text\":\"ğŸš¨ è‡ªåŠ¨å›æ»šè§¦å‘ï¼é”™è¯¯ç‡: ${ERROR_RATE}, å»¶è¿Ÿ: ${LATENCY}s\"}"
    
    # è®°å½•å›æ»šäº‹ä»¶
    echo "$(date): Automatic rollback triggered - Error Rate: $ERROR_RATE, Latency: $LATENCY" >> /var/log/migration-rollback.log
    
else
    echo "ç³»ç»Ÿè¿è¡Œæ­£å¸¸"
fi
```

### 7.2 æ‰‹åŠ¨å›æ»š

#### å¿«é€Ÿå›æ»šè„šæœ¬

```bash
#!/bin/bash
# å¿«é€Ÿå›æ»šè„šæœ¬

echo "å¼€å§‹æ‰‹åŠ¨å›æ»šåˆ°Docker Composeç¯å¢ƒ..."

# 1. åˆ‡æ¢æµé‡å›Docker Compose
echo "åˆ‡æ¢æµé‡..."
kubectl patch service fitness-api-service -n fitness-prod --type='json' -p='[
  {
    "op": "replace",
    "path": "/spec/selector/color",
    "value": "blue"
  }
]'

# 2. åœæ­¢KubernetesæœåŠ¡ï¼ˆå¯é€‰ï¼‰
echo "åœæ­¢KubernetesæœåŠ¡..."
kubectl scale deployment fitness-api-green --replicas=0 -n fitness-prod

# 3. éªŒè¯Docker Composeç¯å¢ƒ
echo "éªŒè¯Docker Composeç¯å¢ƒ..."
docker-compose ps

# 4. æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
curl -f http://localhost:8080/health || echo "è­¦å‘Š: åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"

# 5. é€šçŸ¥ç›¸å…³äººå‘˜
echo "å‘é€å›æ»šé€šçŸ¥..."
curl -X POST $SLACK_WEBHOOK \
  -H 'Content-type: application/json' \
  -d "{\"text\":\"ğŸ”„ æ‰‹åŠ¨å›æ»šå®Œæˆï¼ç³»ç»Ÿå·²åˆ‡æ¢å›Docker Composeç¯å¢ƒ\"}"

echo "å›æ»šå®Œæˆ"
```

### 7.3 æ¸è¿›å¼å›æ»š

#### åˆ†é˜¶æ®µå›æ»š

```bash
#!/bin/bash
# æ¸è¿›å¼å›æ»šè„šæœ¬

TOTAL_REPLICAS=10
ROLLBACK_BATCH=2

echo "å¼€å§‹æ¸è¿›å¼å›æ»š..."

# é€æ­¥å¢åŠ Docker Composeå®ä¾‹
for ((i=ROLLBACK_BATCH; i<=TOTAL_REPLICAS; i+=ROLLBACK_BATCH)); do
    echo "å¢åŠ Docker Composeå®ä¾‹åˆ° $i..."
    
    # è°ƒæ•´Docker Composeå®ä¾‹æ•°
    sed -i "s/replicas: [0-9]*/replicas: $i/" docker-compose.yml
    
    # é‡æ–°éƒ¨ç½²
    docker-compose up -d --scale fitness-api=$i
    
    # å‡å°‘Kuberneteså®ä¾‹
    K8S_REPLICAS=$((TOTAL_REPLICAS - i))
    kubectl scale deployment fitness-api-green --replicas=$K8S_REPLICAS -n fitness-prod
    
    # ç­‰å¾…ç¨³å®š
    echo "ç­‰å¾…ç³»ç»Ÿç¨³å®š..."
    sleep 60
    
    # è¿è¡Œæµ‹è¯•
    if ! run_health_checks; then
        echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢å›æ»š"
        exit 1
    fi
done

echo "æ¸è¿›å¼å›æ»šå®Œæˆ"
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 è¿ç§»åæ€§èƒ½è°ƒä¼˜

#### èµ„æºé…ç½®ä¼˜åŒ–

```yaml
# ä¼˜åŒ–åçš„Kubernetesèµ„æºé…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api-optimized
  namespace: fitness-prod
spec:
  replicas: 5  # åŸºäºè´Ÿè½½æµ‹è¯•ç»“æœè°ƒæ•´
  template:
    spec:
      containers:
      - name: fitness-api
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        env:
        - name: JAVA_OPTS
          value: "-Xmx1536m -Xms768m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

#### æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

```yaml
# ä¼˜åŒ–åçš„æ•°æ®åº“é…ç½®
spring:
  datasource:
    hikari:
      maximum-pool-size: 30  # å¢åŠ è¿æ¥æ± å¤§å°
      minimum-idle: 10
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 30000
      leak-detection-threshold: 60000

# PostgreSQLé…ç½®ä¼˜åŒ–
postgresql:
  primary:
    persistence:
      size: 100Gi  # å¢åŠ å­˜å‚¨ç©ºé—´
    podSecurityContext:
      fsGroup: 1001
    containerSecurityContext:
      runAsUser: 1001
    initdb:
      scripts:
        init.sql: |
          ALTER SYSTEM SET max_connections = '200';
          ALTER SYSTEM SET shared_buffers = '256MB';
          ALTER SYSTEM SET effective_cache_size = '1GB';
          ALTER SYSTEM SET work_mem = '4MB';
```

### 8.2 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### å¤šçº§ç¼“å­˜é…ç½®

```yaml
# åº”ç”¨å±‚ç¼“å­˜
spring:
  cache:
    type: redis
    redis:
      cache-null-values: false
      time-to-live: 3600000  # 1å°æ—¶

# CDNé…ç½®
# åœ¨è¿ç§»å®Œæˆåé…ç½®CloudFrontæˆ–Cloudflare

# æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜
@Cacheable(value = "courses", key = "#courseId")
public Course getCourse(Long courseId) {
    return courseRepository.findById(courseId).orElse(null);
}

@Cacheable(value = "userBookings", key = "#userId")
public List<Booking> getUserBookings(Long userId) {
    return bookingRepository.findByUserIdOrderByCreatedAtDesc(userId);
}
```

### 8.3 ç½‘ç»œä¼˜åŒ–

#### æœåŠ¡ç½‘æ ¼ä¼˜åŒ–

```yaml
# Istioæ€§èƒ½ä¼˜åŒ–é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: fitness-api-optimization
  namespace: fitness-prod
spec:
  host: fitness-api-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 10
        maxRetries: 3
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 30s
```

---

## 9. ç›‘æ§å’ŒéªŒè¯

### 9.1 è¿ç§»ç›‘æ§

#### ç»¼åˆç›‘æ§ä»ªè¡¨æ¿

```yaml
# Grafanaä»ªè¡¨æ¿é…ç½®
dashboard:
  title: "Migration Monitoring Dashboard"
  panels:
    - title: "Request Rate Comparison"
      type: graph
      targets:
        - expr: 'rate(http_requests_total{environment="docker"}[5m])'
          legendFormat: "Docker Compose"
        - expr: 'rate(http_requests_total{environment="kubernetes"}[5m])'
          legendFormat: "Kubernetes"
    
    - title: "Error Rate Comparison"
      type: graph
      targets:
        - expr: 'rate(http_requests_total{status=~"5..",environment="docker"}[5m]) / rate(http_requests_total{environment="docker"}[5m]) * 100'
          legendFormat: "Docker Error Rate"
        - expr: 'rate(http_requests_total{status=~"5..",environment="kubernetes"}[5m]) / rate(http_requests_total{environment="kubernetes"}[5m]) * 100'
          legendFormat: "K8s Error Rate"
    
    - title: "Response Time Comparison"
      type: graph
      targets:
        - expr: 'histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{environment="docker"}[5m]))'
          legendFormat: "Docker P95"
        - expr: 'histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{environment="kubernetes"}[5m]))'
          legendFormat: "K8s P95"
```

#### è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# è¿ç§»éªŒè¯è„šæœ¬

echo "=== è¿ç§»éªŒè¯å¼€å§‹ ==="

# 1. åº”ç”¨å¥åº·æ£€æŸ¥
echo "1. æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
if ! curl -f --max-time 10 http://api.fitness-gym.com/health; then
    echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
    exit 1
fi
echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"

# 2. æ•°æ®åº“è¿æ¥æ£€æŸ¥
echo "2. æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
if ! kubectl exec -n fitness-prod deployment/fitness-db -- pg_isready -U fitness_user -d fitness_gym; then
    echo "âŒ æ•°æ®åº“è¿æ¥æ£€æŸ¥å¤±è´¥"
    exit 1
fi
echo "âœ… æ•°æ®åº“è¿æ¥æ£€æŸ¥é€šè¿‡"

# 3. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
echo "3. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§..."
SOURCE_COUNT=$(docker exec fitness-db psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM users;")
TARGET_COUNT=$(kubectl exec -n fitness-prod deployment/fitness-db -- psql -U fitness_user -d fitness_gym -t -c "SELECT COUNT(*) FROM users;")

if [ "$SOURCE_COUNT" -ne "$TARGET_COUNT" ]; then
    echo "âŒ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ (æº: $SOURCE_COUNT, ç›®æ ‡: $TARGET_COUNT)"
    exit 1
fi
echo "âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

# 4. æ€§èƒ½åŸºå‡†æµ‹è¯•
echo "4. æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
ab -n 1000 -c 10 http://api.fitness-gym.com/api/courses > perf_test.log

if grep -q "Failed requests:\s*[1-9]" perf_test.log; then
    echo "âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥"
    cat perf_test.log
    exit 1
fi
echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"

# 5. ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•
echo "5. æ‰§è¡Œä¸šåŠ¡åŠŸèƒ½æµ‹è¯•..."
# è¿™é‡Œå¯ä»¥é›†æˆæ›´å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•
if ! run_business_tests; then
    echo "âŒ ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•å¤±è´¥"
    exit 1
fi
echo "âœ… ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•é€šè¿‡"

echo "=== è¿ç§»éªŒè¯å®Œæˆ ==="
echo "ğŸ‰ æ‰€æœ‰éªŒè¯é¡¹ç›®é€šè¿‡ï¼"
```

### 9.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

#### è´Ÿè½½æµ‹è¯•é…ç½®

```bash
# ä½¿ç”¨k6è¿›è¡Œè´Ÿè½½æµ‹è¯•
cat > migration-load-test.js << 'EOF'
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 },  // é€æ­¥å¢åŠ åˆ°100ç”¨æˆ·
    { duration: '5m', target: 100 },  // ç¨³å®šè¿è¡Œ5åˆ†é’Ÿ
    { duration: '2m', target: 200 },  // å¢åŠ åˆ°200ç”¨æˆ·
    { duration: '5m', target: 200 },  // ç¨³å®šè¿è¡Œ5åˆ†é’Ÿ
    { duration: '2m', target: 0 },    // é€æ­¥å‡å°‘ç”¨æˆ·
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95%çš„è¯·æ±‚åœ¨500msä»¥å†…
    http_req_failed: ['rate<0.1'],    // é”™è¯¯ç‡å°äº10%
  },
};

export default function () {
  let response = http.get('http://api.fitness-gym.com/api/courses');
  
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}
EOF

# è¿è¡Œè´Ÿè½½æµ‹è¯•
k6 run migration-load-test.js
```

---

## 10. è¿ç§»åçš„è¿ç»´

### 10.1 å¤‡ä»½ç­–ç•¥æ›´æ–°

#### KubernetesåŸç”Ÿå¤‡ä»½

```yaml
# Veleroå¤‡ä»½é…ç½®
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: fitness-daily-backup
  namespace: velero
spec:
  includedNamespaces:
  - fitness-prod
  includedResources:
  - '*'
  excludedResources:
  - events
  - pods
  storageLocation: aws-s3-backup
  ttl: 720h0m0s
  schedule: "0 2 * * *"  # æ¯æ—¥å‡Œæ™¨2ç‚¹
```

#### æ•°æ®åº“å¤‡ä»½ä¼˜åŒ–

```yaml
# PostgreSQLå¤‡ä»½Job
apiVersion: batch/v1
kind: CronJob
metadata:
  name: fitness-db-backup
  namespace: fitness-prod
spec:
  schedule: "0 */6 * * *"  # æ¯6å°æ—¶å¤‡ä»½
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: postgres-backup
            image: postgres:14
            env:
            - name: PGHOST
              value: "fitness-db-service"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: fitness-secrets
                  key: db-user
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: fitness-secrets
                  key: db-password
            command:
            - /bin/bash
            - -c
            - |
              pg_dump -d fitness_gym > /backup/fitness-$(date +%Y%m%d-%H%M%S).sql
            volumeMounts:
            - name: backup-volume
              mountPath: /backup
          volumes:
          - name: backup-volume
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

### 10.2 ç›‘æ§ä½“ç³»å®Œå–„

#### å¯è§‚æµ‹æ€§æ ˆ

```yaml
# å®Œæ•´çš„å¯è§‚æµ‹æ€§é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitoring-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    
    rule_files:
      - /etc/prometheus/alert_rules.yml
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
        - role: endpoints
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https
      
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
      
      - job_name: 'fitness-services'
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
```

### 10.3 è‡ªåŠ¨åŒ–è¿ç»´

#### GitOpså·¥ä½œæµ

```yaml
# ArgoCDåº”ç”¨é…ç½®
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: fitness-prod
  namespace: argocd
spec:
  project: fitness
  source:
    repoURL: https://github.com/fitness-gym/fitness-gitops
    targetRevision: HEAD
    path: apps/production
  destination:
    server: https://kubernetes.default.svc
    namespace: fitness-prod
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    - PrunePropagationPolicy=foreground
```

#### è‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
# HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: fitness-api-hpa
  namespace: fitness-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: fitness-api
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
      - type: Pods
        value: 3
        periodSeconds: 60
```

é€šè¿‡å®æ–½è¿™äº›è¿ç§»ç­–ç•¥å’Œè¿ç»´ä¼˜åŒ–ï¼Œå¯ä»¥ç¡®ä¿å¥èº«æˆ¿ç»¼åˆç®¡ç†ç³»ç»Ÿå¹³ç¨³ã€å®‰å…¨ã€é«˜æ•ˆåœ°ä»ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼è¿ç§»åˆ°ç°ä»£åŒ–çš„äº‘åŸç”Ÿæ¶æ„ã€‚

---

*æœ€åæ›´æ–°: 2025-11-16*  
*ç‰ˆæœ¬: v1.0*  
*ç»´æŠ¤è€…: DevOpså›¢é˜Ÿ*
