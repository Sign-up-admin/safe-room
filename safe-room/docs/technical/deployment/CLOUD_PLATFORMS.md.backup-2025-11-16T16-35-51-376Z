# 云平台集成指南

> **版本**: v1.0
> **最后更新**: 2025-11-16
> **维护者**: DevOps团队

## 概述

本文档详细介绍健身房综合管理系统在各大云平台上的部署方案，包括AWS、Azure、阿里云、腾讯云等主流云平台的容器服务、数据库服务、存储服务等组件的配置和使用。

## 目录

- [1. AWS 部署方案](#1-aws-部署方案)
- [2. Azure 部署方案](#2-azure-部署方案)
- [3. 阿里云部署方案](#3-阿里云部署方案)
- [4. 腾讯云部署方案](#4-腾讯云部署方案)
- [5. 多云部署策略](#5-多云部署策略)
- [6. 成本优化建议](#6-成本优化建议)
- [7. 混合云架构](#7-混合云架构)

---

## 1. AWS 部署方案

### 1.1 架构概览

```mermaid
graph TB
    subgraph "AWS Cloud"
        RT[Route 53<br/>DNS]
        CF[CloudFront<br/>CDN]
        ALB[Application Load Balancer]
        EKS[Amazon EKS<br/>Kubernetes]
        ECR[Amazon ECR<br/>容器仓库]
        RDS[Amazon RDS<br/>PostgreSQL]
        ElastiCache[Amazon ElastiCache<br/>Redis]
        S3[Amazon S3<br/>对象存储]
        CloudWatch[Amazon CloudWatch<br/>监控]
        XRay[AWS X-Ray<br/>追踪]
    end

    subgraph "EKS 集群"
        IG[Ingress Controller<br/>AWS Load Balancer Controller]
        API[API Gateway<br/>Spring Cloud Gateway]
        US[User Service]
        CS[Course Service]
        BS[Booking Service]
        PS[Payment Service]
    end

    RT --> CF
    CF --> ALB
    ALB --> IG
    IG --> API
    API --> US
    API --> CS
    API --> BS
    API --> PS

    US --> RDS
    CS --> RDS
    BS --> RDS
    PS --> RDS

    BS --> ElastiCache
    CS --> ElastiCache

    US --> S3
    CS --> S3

    EKS --> CloudWatch
    EKS --> XRay
    API --> XRay
```

### 1.2 Amazon EKS 部署

#### EKS 集群创建

```bash
# 使用 eksctl 创建 EKS 集群
eksctl create cluster \
  --name fitness-gym-cluster \
  --region us-east-1 \
  --nodegroup-name standard-nodes \
  --node-type t3.medium \
  --nodes 3 \
  --nodes-min 1 \
  --nodes-max 10 \
  --managed

# 配置 kubectl
aws eks update-kubeconfig --region us-east-1 --name fitness-gym-cluster
```

#### EKS 集群配置

```yaml
# eksctl 配置文件
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: fitness-gym-cluster
  region: us-east-1
  version: "1.28"

vpc:
  id: vpc-12345678
  subnets:
    private:
      us-east-1a: { id: subnet-12345678 }
      us-east-1b: { id: subnet-87654321 }
      us-east-1c: { id: subnet-11223344 }

managedNodeGroups:
  - name: standard-nodes
    instanceType: t3.medium
    desiredCapacity: 3
    minSize: 1
    maxSize: 10
    volumeSize: 50
    volumeType: gp3
    labels:
      role: worker
    tags:
      Environment: production
      Team: fitness-gym
    iam:
      withAddonPolicies:
        imageBuilder: true
        autoScaler: true
        externalDNS: true
        certManager: true
        appMesh: true
        appMeshPreview: true
        xRay: true
        cloudWatch: true

addons:
  - name: vpc-cni
    version: latest
  - name: coredns
    version: latest
  - name: kube-proxy
    version: latest

cloudWatch:
  clusterLogging:
    enableTypes: ["*"]
```

#### AWS Load Balancer Controller

```bash
# 安装 AWS Load Balancer Controller
helm repo add eks https://aws.github.io/eks-charts
helm repo update

helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=fitness-gym-cluster \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller
```

#### Ingress 配置

```yaml
# AWS ALB Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fitness-gym-ingress
  namespace: fitness-prod
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
    alb.ingress.kubernetes.io/success-codes: '200'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
spec:
  rules:
  - host: api.fitness-gym.com
    http:
      paths:
      - path: /springboot1ngh61a2
        pathType: Prefix
        backend:
          service:
            name: fitness-api-service
            port:
              number: 8080
  - host: www.fitness-gym.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: fitness-frontend-service
            port:
              number: 80
```

### 1.3 Amazon RDS 配置

#### RDS PostgreSQL 实例

```bash
# 使用 AWS CLI 创建 RDS 实例
aws rds create-db-instance \
  --db-instance-identifier fitness-gym-db \
  --db-instance-class db.t3.micro \
  --engine postgres \
  --engine-version 16.1 \
  --master-username fitness_admin \
  --master-user-password "SecurePassword123!" \
  --allocated-storage 20 \
  --storage-type gp3 \
  --db-name fitness_gym \
  --vpc-security-group-ids sg-12345678 \
  --db-subnet-group-name fitness-gym-db-subnet \
  --backup-retention-period 7 \
  --multi-az \
  --tags Key=Environment,Value=production Key=Application,Value=fitness-gym
```

#### RDS 只读副本

```bash
# 创建只读副本
aws rds create-db-instance-read-replica \
  --db-instance-identifier fitness-gym-db-replica \
  --source-db-instance-identifier fitness-gym-db \
  --db-instance-class db.t3.micro \
  --vpc-security-group-ids sg-12345678 \
  --db-subnet-group-name fitness-gym-db-subnet
```

#### RDS Proxy 配置

```yaml
# RDS Proxy 配置
AWSTemplateFormatVersion: '2010-09-09'
Description: 'RDS Proxy for Fitness Gym'

Resources:
  RDSDBProxy:
    Type: AWS::RDS::DBProxy
    Properties:
      DBProxyName: fitness-gym-proxy
      EngineFamily: POSTGRESQL
      RoleArn: !GetAtt RDSProxyRole.Arn
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !Ref DBPasswordSecret
          IAMAuth: DISABLED
      RequireTLS: true
      VpcSubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  RDSProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    Properties:
      DBProxyName: !Ref RDSDBProxy
      ConnectionPoolConfig:
        MaxConnectionsPercent: 80
        MaxIdleConnectionsPercent: 50
        ConnectionBorrowTimeout: 120
      DBInstanceIdentifiers:
        - !Ref FitnessGymDB
```

### 1.4 Amazon ElastiCache 配置

#### Redis 集群配置

```bash
# 创建 ElastiCache Redis 集群
aws elasticache create-cache-cluster \
  --cache-cluster-id fitness-gym-redis \
  --cache-node-type cache.t3.micro \
  --engine redis \
  --engine-version 7.0 \
  --num-cache-nodes 1 \
  --cache-parameter-group default.redis7 \
  --cache-subnet-group-name fitness-gym-cache-subnet \
  --security-group-ids sg-87654321 \
  --tags Key=Environment,Value=production Key=Application,Value=fitness-gym
```

#### Redis 复制组

```bash
# 创建 Redis 复制组（主从）
aws elasticache create-replication-group \
  --replication-group-id fitness-gym-redis-cluster \
  --replication-group-description "Fitness Gym Redis Cluster" \
  --num-cache-clusters 2 \
  --cache-node-type cache.t3.micro \
  --engine redis \
  --engine-version 7.0 \
  --cache-parameter-group default.redis7.cluster.on \
  --cache-subnet-group-name fitness-gym-cache-subnet \
  --security-group-ids sg-87654321 \
  --automatic-failover-enabled \
  --multi-az-enabled
```

### 1.5 Amazon S3 配置

#### S3 存储桶配置

```bash
# 创建 S3 存储桶
aws s3 mb s3://fitness-gym-storage \
  --region us-east-1

# 配置存储桶版本控制
aws s3api put-bucket-versioning \
  --bucket fitness-gym-storage \
  --versioning-configuration Status=Enabled

# 配置存储桶加密
aws s3api put-bucket-encryption \
  --bucket fitness-gym-storage \
  --server-side-encryption-configuration '{
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        }
      }
    ]
  }'
```

#### CloudFront CDN 配置

```yaml
# CloudFront 分配配置
AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFront Distribution for Fitness Gym'

Resources:
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: Fitness Gym CDN
        DefaultCacheBehavior:
          TargetOriginId: fitness-gym-s3
          ViewerProtocolPolicy: redirect-to-https
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
        Origins:
          - DomainName: fitness-gym-storage.s3.amazonaws.com
            Id: fitness-gym-s3
            S3OriginConfig:
              OriginAccessIdentity: ""
        Enabled: true
        DefaultRootObject: index.html
        HttpVersion: http2
        PriceClass: PriceClass_100
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
```

### 1.6 监控和日志

#### CloudWatch 配置

```yaml
# CloudWatch Container Insights
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-info
  namespace: amazon-cloudwatch
data:
  cluster.name: fitness-gym-cluster
  logs.region: us-east-1
  http.server: "0.0.0.0"
  http.port: "2020"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cloudwatch-agent
  namespace: amazon-cloudwatch

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cloudwatch-agent
  namespace: amazon-cloudwatch
spec:
  selector:
    matchLabels:
      name: cloudwatch-agent
  template:
    metadata:
      labels:
        name: cloudwatch-agent
    spec:
      serviceAccountName: cloudwatch-agent
      containers:
        - name: cloudwatch-agent
          image: amazon/cloudwatch-agent:latest
          ports:
            - containerPort: 2020
```

#### X-Ray 分布式追踪

```yaml
# X-Ray Daemon
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: xray-daemon
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: xray-daemon
  template:
    metadata:
      labels:
        app: xray-daemon
    spec:
      containers:
      - name: xray-daemon
        image: amazon/aws-xray-daemon:latest
        ports:
        - name: xray
          containerPort: 2000
          protocol: UDP
        env:
        - name: AWS_REGION
          value: "us-east-1"
```

### 1.7 成本优化

#### EC2 实例优化

```bash
# 使用 Spot 实例
eksctl create nodegroup \
  --cluster fitness-gym-cluster \
  --name spot-nodes \
  --instance-types t3.medium,t3.large \
  --nodes-min 1 \
  --nodes-max 10 \
  --spot \
  --asg-access
```

#### RDS 成本优化

```bash
# 配置 RDS 自动暂停（开发环境）
aws rds modify-db-instance \
  --db-instance-identifier fitness-gym-db-dev \
  --auto-minor-version-upgrade \
  --backup-retention-period 1 \
  --enable-performance-insights false

# 使用 Reserved Instances（生产环境）
aws rds purchase-reserved-db-instances-offering \
  --reserved-db-instances-offering-id <offering-id> \
  --db-instance-count 1 \
  --reserved-db-instance-id fitness-gym-db-reserved
```

---

## 2. Azure 部署方案

### 2.1 架构概览

```mermaid
graph TB
    subgraph "Azure Cloud"
        AFD[Azure Front Door<br/>CDN]
        AGW[Application Gateway<br/>负载均衡]
        AKS[Azure Kubernetes Service<br/>AKS]
        ACR[Azure Container Registry<br/>容器仓库]
        ADB[Azure Database for PostgreSQL]
        ACA[Azure Cache for Redis]
        ABS[Azure Blob Storage<br/>对象存储]
        AM[Azure Monitor<br/>监控]
        AA[Azure Application Insights<br/>应用监控]
    end

    subgraph "AKS 集群"
        IG[Ingress Controller<br/>AGIC]
        API[API Gateway]
        US[User Service]
        CS[Course Service]
        BS[Booking Service]
        PS[Payment Service]
    end

    AFD --> AGW
    AGW --> IG
    IG --> API
    API --> US
    API --> CS
    API --> BS
    API --> PS

    US --> ADB
    CS --> ADB
    BS --> ADB
    PS --> ADB

    BS --> ACA
    CS --> ACA

    US --> ABS
    CS --> ABS

    AKS --> AM
    AKS --> AA
    API --> AA
```

### 2.2 Azure Kubernetes Service (AKS)

#### AKS 集群创建

```bash
# 使用 Azure CLI 创建 AKS 集群
az aks create \
  --resource-group fitness-gym-rg \
  --name fitness-gym-aks \
  --node-count 3 \
  --node-vm-size Standard_DS2_v2 \
  --enable-addons monitoring \
  --generate-ssh-keys \
  --network-plugin azure \
  --network-policy azure \
  --enable-managed-identity \
  --enable-oidc-issuer \
  --enable-workload-identity

# 配置 kubectl
az aks get-credentials --resource-group fitness-gym-rg --name fitness-gym-aks
```

#### AKS 集群配置

```bash
# 启用集群自动伸缩
az aks update \
  --resource-group fitness-gym-rg \
  --name fitness-gym-aks \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 10

# 配置节点池
az aks nodepool add \
  --resource-group fitness-gym-rg \
  --cluster-name fitness-gym-aks \
  --name spotpool \
  --priority Spot \
  --eviction-policy Delete \
  --spot-max-price -1 \
  --node-vm-size Standard_DS2_v2 \
  --node-count 1 \
  --min-count 1 \
  --max-count 5
```

### 2.3 Azure Database for PostgreSQL

#### PostgreSQL 服务器创建

```bash
# 创建 PostgreSQL 服务器
az postgres server create \
  --name fitness-gym-db \
  --resource-group fitness-gym-rg \
  --location eastus \
  --admin-user fitnessadmin \
  --admin-password "SecurePassword123!" \
  --sku-name GP_Gen5_2 \
  --storage-size 5120 \
  --backup-retention 7 \
  --geo-redundant-backup Disabled \
  --version 16 \
  --ssl-enforcement Enabled

# 配置防火墙
az postgres server firewall-rule create \
  --resource-group fitness-gym-rg \
  --server fitness-gym-db \
  --name AllowAllAzureIPs \
  --start-ip-address 0.0.0.0 \
  --end-ip-address 255.255.255.255

# 配置虚拟网络规则
az postgres server vnet-rule create \
  --resource-group fitness-gym-rg \
  --server fitness-gym-db \
  --name aks-vnet \
  --vnet-name fitness-gym-vnet \
  --subnet fitness-gym-subnet
```

#### 只读副本配置

```bash
# 创建只读副本
az postgres server replica create \
  --name fitness-gym-db-replica \
  --resource-group fitness-gym-rg \
  --source-server fitness-gym-db \
  --location eastus \
  --sku-name GP_Gen5_2
```

### 2.4 Azure Cache for Redis

```bash
# 创建 Redis 缓存
az redis create \
  --name fitness-gym-redis \
  --resource-group fitness-gym-rg \
  --location eastus \
  --sku Basic \
  --vm-size C1 \
  --enable-non-ssl-port false \
  --minimum-tls-version 1.2
```

### 2.5 Azure Blob Storage

```bash
# 创建存储账户
az storage account create \
  --name fitnessgymstorage \
  --resource-group fitness-gym-rg \
  --location eastus \
  --sku Standard_LRS \
  --kind StorageV2 \
  --access-tier Hot \
  --allow-blob-public-access false \
  --enable-hierarchical-namespace false

# 创建容器
az storage container create \
  --name fitness-gym-files \
  --account-name fitnessgymstorage \
  --public-access off
```

### 2.6 监控和日志

#### Azure Monitor 配置

```bash
# 启用 AKS 监控
az monitor diagnostic-settings create \
  --name fitness-gym-diagnostics \
  --resource /subscriptions/<subscription-id>/resourceGroups/fitness-gym-rg/providers/Microsoft.ContainerService/managedClusters/fitness-gym-aks \
  --logs '[{"category": "kube-apiserver", "enabled": true}, {"category": "kube-controller-manager", "enabled": true}, {"category": "kube-scheduler", "enabled": true}]' \
  --metrics '[{"category": "AllMetrics", "enabled": true}]' \
  --workspace /subscriptions/<subscription-id>/resourceGroups/DefaultResourceGroup/providers/Microsoft.OperationalInsights/workspaces/DefaultWorkspace
```

#### Application Insights

```yaml
# Application Insights 配置
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitness-api
  annotations:
    instrumentation.opentelemetry.io/inject-dotnet: "true"
spec:
  template:
    metadata:
      annotations:
        instrumentation.opentelemetry.io/inject-dotnet: "true"
    spec:
      containers:
      - name: fitness-api
        env:
        - name: APPLICATIONINSIGHTS_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: app-insights-secret
              key: connection-string
```

---

## 3. 阿里云部署方案

### 3.1 架构概览

```mermaid
graph TB
    subgraph "阿里云"
        CDN[阿里云CDN]
        SLB[Server Load Balancer<br/>负载均衡]
        ACK[容器服务Kubernetes版<br/>ACK]
        ACR[容器镜像服务<br/>ACR]
        RDS[云数据库RDS<br/>PostgreSQL]
        Redis[云数据库Redis版]
        OSS[对象存储OSS]
        ARMS[应用实时监控服务<br/>ARMS]
        SLS[日志服务SLS]
    end

    subgraph "ACK 集群"
        IG[Ingress Controller<br/>ALB Ingress Controller]
        API[API Gateway]
        US[User Service]
        CS[Course Service]
        BS[Booking Service]
        PS[Payment Service]
    end

    CDN --> SLB
    SLB --> IG
    IG --> API
    API --> US
    API --> CS
    API --> BS
    API --> PS

    US --> RDS
    CS --> RDS
    BS --> RDS
    PS --> RDS

    BS --> Redis
    CS --> Redis

    US --> OSS
    CS --> OSS

    ACK --> ARMS
    ACK --> SLS
    API --> ARMS
    API --> SLS
```

### 3.2 容器服务 ACK

#### ACK 集群创建

```bash
# 使用阿里云CLI创建ACK集群
aliyun cs CreateCluster \
  --name fitness-gym-ack \
  --region cn-hangzhou \
  --cluster_type ManagedKubernetes \
  --vpcid vpc-xxxxx \
  --vswitch_ids '["vsw-xxxxx"]' \
  --master_vswitch_ids '["vsw-xxxxx"]' \
  --master_instance_types '["ecs.g6.large"]' \
  --master_count 3 \
  --worker_instance_types '["ecs.g6.large"]' \
  --worker_count 3 \
  --login_password "SecurePassword123!" \
  --key_pair "fitness-gym-keypair"
```

#### ACK 集群配置

```yaml
# ACK 集群配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: ack-cluster-config
  namespace: kube-system
data:
  cluster-id: "c-xxxxx"
  region-id: "cn-hangzhou"
  vpc-id: "vpc-xxxxx"
  vswitch-ids: "vsw-xxxxx"
```

### 3.3 云数据库 RDS

```bash
# 创建 RDS PostgreSQL 实例
aliyun rds CreateDBInstance \
  --Engine PostgreSQL \
  --EngineVersion 16.0 \
  --DBInstanceClass pg.n2.small.1 \
  --DBInstanceStorage 20 \
  --DBInstanceNetType Intranet \
  --SecurityIPList "172.16.0.0/16" \
  --PayType Postpaid \
  --ZoneId cn-hangzhou-h \
  --DBInstanceDescription "Fitness Gym Database"
```

### 3.4 云数据库 Redis

```bash
# 创建 Redis 实例
aliyun r-kvstore CreateInstance \
  --InstanceName fitness-gym-redis \
  --Password "RedisPassword123!" \
  --InstanceClass redis.master.small.default \
  --Capacity 1024 \
  --ChargeType PostPaid \
  --NetworkType VPC \
  --VpcId vpc-xxxxx \
  --VSwitchId vsw-xxxxx
```

### 3.5 对象存储 OSS

```bash
# 创建 OSS 存储桶
aliyun oss mb oss://fitness-gym-storage \
  --acl private \
  --storage-class Standard

# 配置存储桶加密
aliyun oss bucket-encryption --method put oss://fitness-gym-storage \
  --encryption-type AES256
```

### 3.6 监控和日志

#### ARMS 应用监控

```yaml
# ARMS Prometheus 配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: arms-prometheus-config
  namespace: arms-prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'fitness-services'
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
```

#### 日志服务 SLS

```yaml
# SLS 配置
apiVersion: log.alibabacloud.com/v1alpha1
kind: LogtailConfig
metadata:
  name: fitness-gym-logs
spec:
  logstore: fitness-gym-logstore
  logstoreMode: standard
  configName: fitness-gym-config
  input:
    type: file
    logPath: /app/logs
    filePattern: "*.log"
    dockerFile: true
    dockerIncludeEnv: '["ALIYUN_LOGTAIL_USER_DEFINED_ID"]'
  output:
    type: cloudwatch
    region: cn-hangzhou
    logGroupName: fitness-gym-logs
```

---

## 4. 腾讯云部署方案

### 4.1 架构概览

```mermaid
graph TB
    subgraph "腾讯云"
        CDN[腾讯云CDN]
        CLB[Cloud Load Balancer<br/>负载均衡]
        TKE[腾讯Kubernetes引擎<br/>TKE]
        TCR[腾讯容器镜像服务<br/>TCR]
        TDSQL[腾讯云数据库TDSQL<br/>PostgreSQL]
        CRedis[云数据库Redis<br/>CRedis]
        COS[对象存储COS]
        TMP[腾讯云可观测平台<br/>TMP]
        CLS[云日志服务<br/>CLS]
    end

    subgraph "TKE 集群"
        IG[Ingress Controller<br/>CLB Ingress Controller]
        API[API Gateway]
        US[User Service]
        CS[Course Service]
        BS[Booking Service]
        PS[Payment Service]
    end

    CDN --> CLB
    CLB --> IG
    IG --> API
    API --> US
    API --> CS
    API --> BS
    API --> PS

    US --> TDSQL
    CS --> TDSQL
    BS --> TDSQL
    PS --> TDSQL

    BS --> CRedis
    CS --> CRedis

    US --> COS
    CS --> COS

    TKE --> TMP
    TKE --> CLS
    API --> TMP
    API --> CLS
```

### 4.2 腾讯 Kubernetes 引擎 (TKE)

#### TKE 集群创建

```bash
# 使用腾讯云CLI创建TKE集群
tccli tke CreateCluster \
  --ClusterName fitness-gym-tke \
  --Region ap-guangzhou \
  --ClusterType MANAGED_CLUSTER \
  --ClusterCIDR 10.244.0.0/16 \
  --VpcId vpc-xxxxx \
  --SubnetIds '["subnet-xxxxx"]' \
  --ClusterOS ubuntu18.04.1x86_64 \
  --ContainerRuntime docker \
  --ClusterVersion 1.28.0 \
  --ClusterDesc "Fitness Gym Kubernetes Cluster"
```

### 4.3 云数据库 TDSQL

```bash
# 创建 TDSQL PostgreSQL 实例
tccli postgres CreateDBInstances \
  --DBInstanceName fitness-gym-db \
  --Region ap-guangzhou \
  --Zone ap-guangzhou-3 \
  --DBVersion 16.0 \
  --DBCharset UTF8 \
  --DBInstanceClass TDSQL.PG.2C4G \
  --Storage 20 \
  --InstanceCount 1 \
  --Period 1 \
  --AutoRenewFlag 0 \
  --ProjectId 0
```

### 4.4 云数据库 Redis

```bash
# 创建 CRedis 实例
tccli redis CreateInstances \
  --TypeId 7 \
  --MemSize 1024 \
  --GoodsNum 1 \
  --Period 1 \
  --BillingMode 0 \
  --ZoneId 100003 \
  --Password "RedisPassword123!" \
  --VpcId vpc-xxxxx \
  --SubnetId subnet-xxxxx \
  --ProjectId 0 \
  --AutoRenewFlag 0
```

### 4.5 对象存储 COS

```bash
# 创建 COS 存储桶
tccli cos CreateBucket \
  --Bucket fitness-gym-storage \
  --Region ap-guangzhou \
  --ACL private \
  --EnableMAZ false
```

---

## 5. 多云部署策略

### 5.1 多云架构设计

```mermaid
graph TB
    subgraph "全球负载均衡"
        GSLB[Global Server Load Balancing]
    end

    subgraph "AWS us-east-1"
        EKS1[EKS Cluster 1]
        RDS1[RDS Primary]
        S31[S3 Primary]
    end

    subgraph "Azure eastus"
        AKS1[AKS Cluster 1]
        ADB1[Azure DB Replica]
        ABS1[Blob Storage Replica]
    end

    subgraph "阿里云 cn-hangzhou"
        ACK1[ACK Cluster 1]
        RDS2[RDS Replica]
        OSS1[OSS Replica]
    end

    subgraph "数据同步"
        DMS[Data Migration Service]
        SR[Storage Replication]
    end

    GSLB --> EKS1
    GSLB --> AKS1
    GSLB --> ACK1

    RDS1 --> DMS
    DMS --> ADB1
    DMS --> RDS2

    S31 --> SR
    SR --> ABS1
    SR --> OSS1
```

### 5.2 流量调度策略

#### 地理位置路由

```yaml
# Global DNS 配置示例 (Route 53)
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Global DNS for Multi-Cloud Fitness Gym'

Resources:
  GlobalHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: fitness-gym.com

  USRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref GlobalHostedZone
      Name: api.fitness-gym.com
      Type: CNAME
      SetIdentifier: us-east
      GeoLocation:
        CountryCode: US
      TTL: 60
      ResourceRecords:
        - api-us.fitness-gym.com

  EURecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref GlobalHostedZone
      Name: api.fitness-gym.com
      Type: CNAME
      SetIdentifier: eu-west
      GeoLocation:
        CountryCode: DE
      TTL: 60
      ResourceRecords:
        - api-eu.fitness-gym.com
```

#### 健康检查和故障转移

```yaml
# AWS Route 53 健康检查
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Health Checks for Multi-Cloud'

Resources:
  PrimaryHealthCheck:
    Type: AWS::Route53::HealthCheck
    Properties:
      HealthCheckConfig:
        Type: HTTP
        FullyQualifiedDomainName: api-us.fitness-gym.com
        Port: 80
        ResourcePath: /health
        RequestInterval: 30
        FailureThreshold: 3

  FailoverRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref GlobalHostedZone
      Name: api.fitness-gym.com
      Type: CNAME
      SetIdentifier: primary
      HealthCheckId: !Ref PrimaryHealthCheck
      TTL: 60
      ResourceRecords:
        - api-us.fitness-gym.com

  SecondaryRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref GlobalHostedZone
      Name: api.fitness-gym.com
      Type: CNAME
      SetIdentifier: secondary
      TTL: 60
      ResourceRecords:
        - api-eu.fitness-gym.com
```

### 5.3 数据同步策略

#### 跨云数据库复制

```sql
-- PostgreSQL 逻辑复制配置
-- 主库配置
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_replication_slots = 10;
ALTER SYSTEM SET max_wal_senders = 10;

-- 创建发布
CREATE PUBLICATION fitness_gym_pub FOR ALL TABLES;

-- 从库配置
CREATE SUBSCRIPTION fitness_gym_sub
    CONNECTION 'host=primary-db.amazonaws.com port=5432 user=replication password=repl_password dbname=fitness_gym'
    PUBLICATION fitness_gym_pub;
```

#### 对象存储复制

```json
// AWS S3 跨区域复制配置
{
  "Role": "arn:aws:iam::123456789012:role/s3-replication-role",
  "Rules": [
    {
      "Status": "Enabled",
      "Prefix": "",
      "Destination": {
        "Bucket": "arn:aws:s3:::fitness-gym-backup-us-west-2",
        "StorageClass": "STANDARD"
      },
      "DeleteMarkerReplication": {
        "Status": "Disabled"
      },
      "Filter": {},
      "Priority": 1
    }
  ]
}
```

### 5.4 多云部署工具

#### Terraform 多云配置

```hcl
# 多云基础设施即代码
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
    alicloud = {
      source  = "aliyun/alicloud"
      version = "~> 1.200"
    }
  }
}

# AWS 资源
module "aws_fitness_gym" {
  source = "./modules/aws"
  providers = {
    aws = aws
  }
  environment = var.environment
}

# Azure 资源
module "azure_fitness_gym" {
  source = "./modules/azure"
  providers = {
    azurerm = azurerm
  }
  environment = var.environment
}

# 阿里云资源
module "alicloud_fitness_gym" {
  source = "./modules/alicloud"
  providers = {
    alicloud = alicloud
  }
  environment = var.environment
}
```

---

## 6. 成本优化建议

### 6.1 计算资源优化

#### Spot/竞价实例策略

```bash
# AWS Spot 实例配置
eksctl create nodegroup \
  --cluster fitness-gym-cluster \
  --name spot-nodes \
  --instance-types t3.medium,t3.large,m5.large \
  --nodes-min 1 \
  --nodes-max 20 \
  --spot \
  --spot-allocation-strategy lowest-price \
  --asg-access
```

#### 自动扩缩容配置

```yaml
# Kubernetes HPA 配置
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: fitness-api-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: fitness-api
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 20
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
```

### 6.2 存储成本优化

#### 存储层级管理

```bash
# AWS S3 生命周期配置
aws s3api put-bucket-lifecycle-configuration \
  --bucket fitness-gym-storage \
  --lifecycle-configuration '{
    "Rules": [
      {
        "ID": "Move old files to IA",
        "Status": "Enabled",
        "Prefix": "uploads/",
        "Transitions": [
          {
            "Days": 30,
            "StorageClass": "STANDARD_IA"
          },
          {
            "Days": 90,
            "StorageClass": "GLACIER"
          }
        ]
      }
    ]
  }'
```

#### 数据库存储优化

```sql
-- PostgreSQL 表分区
CREATE TABLE bookings_y2024m01 PARTITION OF bookings
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- 自动清理旧数据
CREATE OR REPLACE FUNCTION cleanup_old_data() RETURNS void AS $$
BEGIN
    DELETE FROM audit_logs WHERE created_at < NOW() - INTERVAL '90 days';
    DELETE FROM session_logs WHERE created_at < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- 定时任务
SELECT cron.schedule('cleanup-old-data', '0 2 * * *', 'SELECT cleanup_old_data();');
```

### 6.3 监控成本控制

#### 日志保留策略

```yaml
# Elasticsearch ILM 策略
PUT _ilm/policy/fitness_gym_logs
{
  "policy": {
    "phases": {
      "hot": {
        "min_age": "0ms",
        "actions": {
          "rollover": {
            "max_age": "1d",
            "max_size": "50gb"
          }
        }
      },
      "warm": {
        "min_age": "30d",
        "actions": {
          "allocate": {
            "number_of_replicas": 0
          }
        }
      },
      "delete": {
        "min_age": "90d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

### 6.4 成本监控和告警

#### AWS Cost Allocation Tags

```bash
# 配置成本分配标签
aws ce create-cost-allocation-tag \
  --tag-key Environment \
  --type CUSTOM

aws ce create-cost-allocation-tag \
  --tag-key Application \
  --type CUSTOM

aws ce create-cost-allocation-tag \
  --tag-key Team \
  --type CUSTOM
```

#### 预算和告警

```json
// AWS Budget 配置
{
  "BudgetName": "Fitness-Gym-Monthly-Budget",
  "BudgetLimit": {
    "Amount": "1000",
    "Unit": "USD"
  },
  "CostFilters": {
    "TagKeyValue": [
      "user:Application$fitness-gym"
    ]
  },
  "CostTypes": {
    "IncludeTax": true,
    "IncludeSubscription": true,
    "UseBlended": false
  },
  "TimeUnit": "MONTHLY",
  "TimePeriod": {
    "Start": "2024-01-01T00:00:00Z",
    "End": "2024-12-31T23:59:59Z"
  },
  "BudgetType": "COST"
}
```

---

## 7. 混合云架构

### 7.1 混合云部署模式

```mermaid
graph TB
    subgraph "公有云"
        EKS[EKS Cluster]
        RDS[RDS Database]
        S3[S3 Storage]
    end

    subgraph "企业数据中心"
        VM[VMware VMs]
        SAN[SAN Storage]
        DC[Data Center DB]
    end

    subgraph "边缘节点"
        K3S[K3s Clusters]
        EDGE[Edge Gateways]
    end

    subgraph "混合云管理"
        MCM[Multi-Cloud Manager]
        VPN[Site-to-Site VPN]
        DX[AWS Direct Connect]
    end

    MCM --> EKS
    MCM --> VM
    MCM --> K3S

    VPN --> DC
    DX --> DC

    K3S --> EDGE
```

### 7.2 数据同步策略

#### 混合云数据复制

```yaml
# AWS DMS 配置
AWSTemplateFormatVersion: '2010-09-09'
Description: 'DMS for Hybrid Cloud Data Sync'

Resources:
  DMSSourceEndpoint:
    Type: AWS::DMS::Endpoint
    Properties:
      EndpointType: source
      EngineName: postgres
      ServerName: on-premise-db.company.com
      Port: 5432
      DatabaseName: fitness_gym
      Username: replication_user
      Password: !Ref ReplicationPassword

  DMSTargetEndpoint:
    Type: AWS::DMS::Endpoint
    Properties:
      EndpointType: target
      EngineName: postgres
      ServerName: !GetAtt RDSDB.Endpoint.Address
      Port: 5432
      DatabaseName: fitness_gym
      Username: !Ref DBUsername
      Password: !Ref DBPassword

  DMSReplicationTask:
    Type: AWS::DMS::ReplicationTask
    Properties:
      ReplicationTaskIdentifier: fitness-gym-sync
      SourceEndpointArn: !Ref DMSSourceEndpoint
      TargetEndpointArn: !Ref DMSTargetEndpoint
      ReplicationInstanceArn: !Ref DMSReplicationInstance
      MigrationType: full-load-and-cdc
      TableMappings: |
        {
          "rules": [
            {
              "rule-type": "selection",
              "rule-id": "1",
              "rule-name": "include-all-tables",
              "object-locator": {
                "schema-name": "public",
                "table-name": "%"
              },
              "rule-action": "include"
            }
          ]
        }
```

### 7.3 安全和合规

#### 混合云网络安全

```yaml
# AWS VPC 和企业网络连接
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Hybrid Cloud Network Security'

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16

  VPNGateway:
    Type: AWS::EC2::VPNGateway
    Properties:
      Type: ipsec.1

  CustomerGateway:
    Type: AWS::EC2::CustomerGateway
    Properties:
      BgpAsn: 65000
      IpAddress: 203.0.113.12  # 企业数据中心公网IP
      Type: ipsec.1

  VPNConnection:
    Type: AWS::EC2::VPNConnection
    Properties:
      Type: ipsec.1
      CustomerGatewayId: !Ref CustomerGateway
      VpnGatewayId: !Ref VPNGateway
      StaticRoutesOnly: true
```

#### 身份联合

```yaml
# AWS IAM Identity Provider 配置
AWSTemplateFormatVersion: '2010-09-09'
Description: 'IAM Federation for Hybrid Cloud'

Resources:
  SAMLProvider:
    Type: AWS::IAM::SAMLProvider
    Properties:
      Name: CompanyADFS
      SamlMetadataDocument: |
        # ADFS SAML 元数据

  IAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: HybridCloudAdmin
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref SAMLProvider
            Action: sts:AssumeRoleWithSAML
            Condition:
              StringEquals:
                SAML:aud: https://signin.aws.amazon.com/saml
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess
```

---

## 总结

本文档提供了健身房综合管理系统在各大云平台上的完整部署方案，包括：

1. **AWS 部署方案**：EKS、RDS、ElastiCache、S3、CloudWatch等服务配置
2. **Azure 部署方案**：AKS、Azure Database、Redis Cache、Blob Storage、Monitor等服务配置
3. **阿里云部署方案**：ACK、RDS、Redis、OSS、ARMS、SLS等服务配置
4. **腾讯云部署方案**：TKE、TDSQL、CRedis、COS、TMP、CLS等服务配置
5. **多云部署策略**：全局负载均衡、数据同步、流量调度等
6. **成本优化建议**：Spot实例、自动扩缩容、存储层级管理等
7. **混合云架构**：公有云+私有云的数据同步和安全配置

通过实施这些云平台集成方案，可以构建高可用、可扩展、成本优化的现代化健身房管理系统。

---

*最后更新: 2025-11-16*  
*版本: v1.0*  
*维护者: DevOps团队*
