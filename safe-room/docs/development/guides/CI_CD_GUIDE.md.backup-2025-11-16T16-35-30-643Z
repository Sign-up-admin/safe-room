# CI/CD æµæ°´çº¿æŒ‡å—

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-16
> **ç»´æŠ¤è€…**: DevOpså›¢é˜Ÿ

## æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¥èº«æˆ¿ç®¡ç†ç³»ç»ŸCI/CDæµæ°´çº¿çš„å®Œæ•´é…ç½®ï¼ŒåŒ…æ‹¬GitHub Actionså·¥ä½œæµã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€éƒ¨ç½²ç­–ç•¥ã€å®‰å…¨æ‰«æç­‰æ ¸å¿ƒç»„ä»¶ã€‚

## ç›®å½•

- [1. CI/CD æ¶æ„](#1-cicd-æ¶æ„)
- [2. GitHub Actions é…ç½®](#2-github-actions-é…ç½®)
- [3. æµæ°´çº¿é˜¶æ®µè¯¦è§£](#3-æµæ°´çº¿é˜¶æ®µè¯¦è§£)
- [4. ç¯å¢ƒç®¡ç†](#4-ç¯å¢ƒç®¡ç†)
- [5. éƒ¨ç½²ç­–ç•¥](#5-éƒ¨ç½²ç­–ç•¥)
- [6. ç›‘æ§ä¸å‘Šè­¦](#6-ç›‘æ§ä¸å‘Šè­¦)
- [7. æ•…éšœæ’æŸ¥](#7-æ•…éšœæ’æŸ¥)
- [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)

---

## 1. CI/CD æ¶æ„

### æµæ°´çº¿æ¶æ„å›¾

```mermaid
graph TD
    subgraph "å¼€å‘é˜¶æ®µ"
        A[ä»£ç æäº¤] --> B[Git Push]
        B --> C[Pull Request]
    end

    subgraph "CIé˜¶æ®µ"
        C --> D[ä»£ç è´¨é‡æ£€æŸ¥]
        D --> E[å•å…ƒæµ‹è¯•]
        E --> F[é›†æˆæµ‹è¯•]
        F --> G[å®‰å…¨æ‰«æ]
        G --> H[æ„å»ºé•œåƒ]
    end

    subgraph "CDé˜¶æ®µ"
        H --> I{ç¯å¢ƒé€‰æ‹©}
        I -->|å¼€å‘| J[éƒ¨ç½²åˆ°Dev]
        I -->|æµ‹è¯•| K[éƒ¨ç½²åˆ°Staging]
        I -->|ç”Ÿäº§| L[éƒ¨ç½²åˆ°Prod]
    end

    subgraph "éªŒè¯é˜¶æ®µ"
        J --> M[å†’çƒŸæµ‹è¯•]
        K --> N[å›å½’æµ‹è¯•]
        L --> O[ç«¯åˆ°ç«¯æµ‹è¯•]
        M --> P[ç›‘æ§å‘Šè­¦]
        N --> P
        O --> P
    end

    subgraph "åé¦ˆé˜¶æ®µ"
        P --> Q[é€šçŸ¥å›¢é˜Ÿ]
        Q --> R[ç”ŸæˆæŠ¥å‘Š]
        R --> S[æ›´æ–°çŠ¶æ€]
    end
```

### æµæ°´çº¿ç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ | å·¥å…· |
|------|------|------|
| **ç‰ˆæœ¬æ§åˆ¶** | ä»£ç æ‰˜ç®¡å’Œåˆ†æ”¯ç®¡ç† | Git + GitHub |
| **CIæœåŠ¡** | è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯• | GitHub Actions |
| **å®¹å™¨åŒ–** | åº”ç”¨æ‰“åŒ…å’Œè¿è¡Œæ—¶ | Docker + Docker Compose |
| **åˆ¶å“åº“** | æ„å»ºäº§ç‰©å­˜å‚¨ | GitHub Packages / Docker Hub |
| **éƒ¨ç½²å·¥å…·** | è‡ªåŠ¨åŒ–éƒ¨ç½² | Bash + PowerShell è„šæœ¬ |
| **ç›‘æ§ç³»ç»Ÿ** | è¿è¡Œæ—¶ç›‘æ§å’Œå‘Šè­¦ | Prometheus + Grafana |
| **å®‰å…¨å·¥å…·** | ä»£ç å’Œä¾èµ–å®‰å…¨æ‰«æ | Trivy, Snyk, CodeQL |

---

## 2. GitHub Actions é…ç½®

### 2.1 ä¸»è¦å·¥ä½œæµæ–‡ä»¶

é¡¹ç›®åŒ…å«ä»¥ä¸‹GitHub Actionså·¥ä½œæµï¼š

#### å®Œæ•´çš„CI/CDå·¥ä½œæµ (`.github/workflows/ci-cd.yml`)

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            src/main/resources/front/front/package-lock.json
            src/main/resources/admin/admin/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install frontend dependencies
        run: |
          cd src/main/resources/front/front
          npm ci
          cd ../admin
          npm ci

      - name: Run frontend linting
        run: |
          cd src/main/resources/front/front
          npm run lint
          cd ../admin
          npm run lint

      - name: Run backend compilation
        run: mvn compile -q

      - name: Check code formatting
        run: |
          cd src/main/resources/front/front
          npm run format:check
          cd ../admin
          npm run format:check

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality-check

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: fitness_gym_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Install frontend dependencies
        run: |
          cd src/main/resources/front/front
          npm ci
          cd ../admin
          npm ci

      - name: Run frontend unit tests
        run: |
          cd src/main/resources/front/front
          npm run test:unit -- --coverage --watchAll=false
          cd ../admin
          npm run test:unit -- --coverage --watchAll=false

      - name: Run backend unit tests
        run: mvn test -Dspring.profiles.active=test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: |
            src/main/resources/front/front/coverage/lcov.info
            src/main/resources/admin/admin/coverage/lcov.info
            target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run integration tests
        run: mvn verify -Dspring.profiles.active=integration-test

      - name: Generate test report
        run: mvn surefire-report:report

      - name: Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: |
            target/surefire-reports/
            target/site/

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: integration-tests
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Playwright
        run: |
          cd src/main/resources/front/front
          npx playwright install --with-deps

      - name: Run E2E tests
        run: |
          cd src/main/resources/front/front
          npm run test:e2e:ci

      - name: Upload test artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            src/main/resources/front/front/test-results/
            src/main/resources/front/front/playwright-report/

  # å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=package.json

      - name: Run Snyk on backend
        uses: snyk/actions/java@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --file=pom.xml

  # æ„å»ºå’Œæ¨é€é•œåƒ
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, integration-tests, e2e-tests, security-scan]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: ${{ steps.meta.outputs.tags }}-api
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./src/main/resources/front/front
          file: ./src/main/resources/front/front/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}-frontend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to development
        run: |
          echo "Deploying to development environment..."
          # è¿™é‡Œæ·»åŠ å…·ä½“çš„éƒ¨ç½²å‘½ä»¤
          # ä¾‹å¦‚ï¼šè°ƒç”¨éƒ¨ç½²è„šæœ¬æˆ–ä½¿ç”¨kubectl/helmç­‰

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # è¿™é‡Œæ·»åŠ å…·ä½“çš„éƒ¨ç½²å‘½ä»¤
```

#### æ–‡æ¡£å‘å¸ƒå·¥ä½œæµ (`.github/workflows/docs-publish.yml`)

```yaml
name: Publish Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'docker-compose.yml'
  workflow_dispatch:

jobs:
  docs-validation:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Validate documentation
        run: npm run validate-docs

  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: docs-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Generate API documentation
        run: npm run generate-api-docs

      - name: Generate deployment documentation
        run: npm run generate-deployment-docs

      - name: Update documentation index
        run: npm run update-doc-index

      - name: Build documentation site
        run: |
          cd docs
          npm install
          npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/build
          cname: docs.fitness-gym.com
```

### 2.2 ç¯å¢ƒé…ç½®

#### ç¯å¢ƒå˜é‡è®¾ç½®

åœ¨GitHubä»“åº“è®¾ç½®ä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

**Actions secrets and variables > Variables**

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `DOCKER_REGISTRY` | Dockeré•œåƒä»“åº“ | `ghcr.io` |
| `IMAGE_NAME` | é•œåƒåç§° | `your-org/fitness-gym` |
| `PROD_DEPLOY_HOST` | ç”Ÿäº§ç¯å¢ƒä¸»æœº | `prod-server.fitness-gym.com` |
| `STAGING_DEPLOY_HOST` | æµ‹è¯•ç¯å¢ƒä¸»æœº | `staging.fitness-gym.com` |

**Actions secrets and variables > Secrets**

| Secretå | è¯´æ˜ |
|----------|------|
| `DOCKER_PASSWORD` | Dockerä»“åº“å¯†ç  |
| `DEPLOY_KEY` | SSHéƒ¨ç½²å¯†é’¥ |
| `PROD_DB_PASSWORD` | ç”Ÿäº§æ•°æ®åº“å¯†ç  |
| `STAGING_DB_PASSWORD` | æµ‹è¯•æ•°æ®åº“å¯†ç  |
| `SLACK_WEBHOOK_URL` | Slacké€šçŸ¥Webhook |
| `SNYK_TOKEN` | Snykå®‰å…¨æ‰«æä»¤ç‰Œ |

#### ç¯å¢ƒä¿æŠ¤è§„åˆ™

```yaml
# .github/workflows/environments.yml
environments:
  development:
    deployment_branch_policy:
      protected_branches: false
      custom_branch_policies: true
    reviewers:
      - type: User
        id: devops-team
    required_reviewers: 1

  staging:
    deployment_branch_policy:
      protected_branches: false
      custom_branch_policies: true
    reviewers:
      - type: User
        id: qa-team
      - type: User
        id: devops-team
    required_reviewers: 2

  production:
    deployment_branch_policy:
      protected_branches: true
      custom_branch_policies: false
    reviewers:
      - type: User
        id: product-owner
      - type: Team
        id: engineering-lead
      - type: Team
        id: qa-team
    required_reviewers: 3
    wait_timer: 30  # ç­‰å¾…30åˆ†é’Ÿåè‡ªåŠ¨éƒ¨ç½²
```

---

## 3. æµæ°´çº¿é˜¶æ®µè¯¦è§£

### 3.1 ä»£ç è´¨é‡æ£€æŸ¥é˜¶æ®µ

#### Lintingå’Œæ ¼å¼åŒ–

```yaml
# å‰ç«¯ä»£ç æ£€æŸ¥
- name: Run ESLint
  run: |
    cd src/main/resources/front/front
    npx eslint src/ --ext .ts,.tsx,.js,.jsx

- name: Check Prettier formatting
  run: |
    cd src/main/resources/front/front
    npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"

# åç«¯ä»£ç æ£€æŸ¥
- name: Run Spotless (Java formatting)
  run: mvn spotless:check

- name: Run Checkstyle
  run: mvn checkstyle:check
```

#### é™æ€ç±»å‹æ£€æŸ¥

```yaml
# TypeScriptç±»å‹æ£€æŸ¥
- name: TypeScript check
  run: |
    cd src/main/resources/front/front
    npx tsc --noEmit

# Javaç¼–è¯‘æ£€æŸ¥
- name: Java compilation
  run: mvn compile -q
```

### 3.2 æµ‹è¯•é˜¶æ®µ

#### å•å…ƒæµ‹è¯•é…ç½®

```xml
<!-- pom.xml æµ‹è¯•é…ç½® -->
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-surefire-plugin</artifactId>
  <version>3.1.2</version>
  <configuration>
    <includes>
      <include>**/*Test.java</include>
      <include>**/*Tests.java</include>
    </includes>
    <excludes>
      <exclude>**/*IT.java</exclude>
      <exclude>**/*IntegrationTest.java</exclude>
    </excludes>
    <systemPropertyVariables>
      <spring.profiles.active>test</spring.profiles.active>
    </systemPropertyVariables>
  </configuration>
</plugin>
```

#### é›†æˆæµ‹è¯•é…ç½®

```xml
<!-- é›†æˆæµ‹è¯•æ’ä»¶ -->
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-failsafe-plugin</artifactId>
  <version>3.1.2</version>
  <configuration>
    <includes>
      <include>**/*IT.java</include>
      <include>**/*IntegrationTest.java</include>
    </includes>
    <systemPropertyVariables>
      <spring.profiles.active>integration-test</spring.profiles.active>
    </systemPropertyVariables>
  </configuration>
  <executions>
    <execution>
      <goals>
        <goal>integration-test</goal>
        <goal>verify</goal>
      </goals>
    </execution>
  </executions>
</plugin>
```

#### E2Eæµ‹è¯•é…ç½®

```javascript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: process.env.CI ? 'html' : 'list',

  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:8080',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
});
```

### 3.3 å®‰å…¨æ‰«æé˜¶æ®µ

#### å®¹å™¨é•œåƒæ‰«æ

```yaml
- name: Scan container images
  uses: aquasecurity/trivy-action@master
  with:
    scan-type: 'image'
    scan-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest'
    format: 'sarif'
    output: 'trivy-image-results.sarif'
    severity: 'CRITICAL,HIGH'
```

#### ä¾èµ–æ¼æ´æ‰«æ

```yaml
- name: Run Snyk dependency scan
  uses: snyk/actions/java@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  with:
    command: test
    args: --file=pom.xml --sarif-file-output=snyk-java.sarif

- name: Run Snyk on JavaScript
  uses: snyk/actions/node@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  with:
    args: --file=package.json --sarif-file-output=snyk-js.sarif
```

#### ä»£ç å®‰å…¨åˆ†æ

```yaml
- name: CodeQL Analysis
  uses: github/codeql-action/init@v2
  with:
    languages: javascript, java
    queries: security-and-quality

- name: Perform CodeQL Analysis
  uses: github/codeql-action/analyze@v2
```

### 3.4 æ„å»ºå’Œéƒ¨ç½²é˜¶æ®µ

#### å¤šæ¶æ„é•œåƒæ„å»º

```yaml
- name: Build multi-platform images
  uses: docker/build-push-action@v5
  with:
    context: .
    platforms: linux/amd64,linux/arm64
    push: true
    tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    cache-from: type=gha
    cache-to: type=gha,mode=max
    provenance: true
    sbom: true
```

#### éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

ENVIRONMENT=$1
TAG=$2

if [ -z "$ENVIRONMENT" ] || [ -z "$TAG" ]; then
    echo "Usage: $0 <environment> <tag>"
    exit 1
fi

echo "ğŸš€ Deploying $TAG to $ENVIRONMENT environment"

# åŠ è½½ç¯å¢ƒé…ç½®
source "config/environments/$ENVIRONMENT.env"

# æ‹‰å–æœ€æ–°é•œåƒ
docker pull $REGISTRY/$IMAGE_NAME:$TAG-api
docker pull $REGISTRY/$IMAGE_NAME:$TAG-frontend

# åœæ­¢æ—§æœåŠ¡
docker-compose -f docker-compose.$ENVIRONMENT.yml down

# æ›´æ–°é•œåƒæ ‡ç­¾
sed -i "s|image:.*api|image: $REGISTRY/$IMAGE_NAME:$TAG-api|" docker-compose.$ENVIRONMENT.yml
sed -i "s|image:.*frontend|image: $REGISTRY/$IMAGE_NAME:$TAG-frontend|" docker-compose.$ENVIRONMENT.yml

# å¯åŠ¨æ–°æœåŠ¡
docker-compose -f docker-compose.$ENVIRONMENT.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30

# è¿è¡Œå¥åº·æ£€æŸ¥
./scripts/health-check.sh

echo "âœ… Deployment completed successfully"
```

---

## 4. ç¯å¢ƒç®¡ç†

### 4.1 ç¯å¢ƒé…ç½®

#### ç¯å¢ƒå˜é‡æ–‡ä»¶

**config/environments/development.env**
```bash
# å¼€å‘ç¯å¢ƒé…ç½®
ENVIRONMENT=development
DOCKER_COMPOSE_FILE=docker-compose.dev.yml

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_NAME=fitness_gym_dev
DB_USER=fitness_user
DB_PASSWORD=dev_password

# åº”ç”¨é…ç½®
API_PORT=3000
FRONTEND_PORT=8080
NODE_ENV=development

# ç›‘æ§é…ç½®
PROMETHEUS_ENABLED=false
GRAFANA_ENABLED=false
```

**config/environments/production.env**
```bash
# ç”Ÿäº§ç¯å¢ƒé…ç½®
ENVIRONMENT=production
DOCKER_COMPOSE_FILE=docker-compose.prod.yml

# æ•°æ®åº“é…ç½®
DB_HOST=prod-db.fitness-gym.com
DB_PORT=5432
DB_NAME=fitness_gym_prod
DB_USER=fitness_user
DB_PASSWORD=${PROD_DB_PASSWORD}

# åº”ç”¨é…ç½®
API_PORT=80
FRONTEND_PORT=443
NODE_ENV=production

# ç›‘æ§é…ç½®
PROMETHEUS_ENABLED=true
GRAFANA_ENABLED=true
SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
```

### 4.2 Docker Composeé…ç½®

#### å¼€å‘ç¯å¢ƒé…ç½®

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  api:
    image: ${REGISTRY}/${IMAGE_NAME}:dev-api
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - DB_HOST=${DB_HOST}
      - DB_PASSWORD=${DB_PASSWORD}
    ports:
      - "${API_PORT}:3000"
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

  frontend:
    image: ${REGISTRY}/${IMAGE_NAME}:dev-frontend
    ports:
      - "${FRONTEND_PORT}:80"
    restart: unless-stopped

  database:
    image: postgres:14
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    restart: unless-stopped

volumes:
  postgres_dev_data:
```

#### ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  api:
    image: ${REGISTRY}/${IMAGE_NAME}:latest-api
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=${DB_HOST}
      - DB_PASSWORD=${DB_PASSWORD}
    ports:
      - "3000:3000"
    volumes:
      - ./logs:/app/logs
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    image: ${REGISTRY}/${IMAGE_NAME}:latest-frontend
    ports:
      - "80:80"
      - "443:443"
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  database:
    image: postgres:14
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    deploy:
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  postgres_prod_data:
    driver: local
```

---

## 5. éƒ¨ç½²ç­–ç•¥

### 5.1 è“ç»¿éƒ¨ç½²

#### è“ç»¿éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/blue-green-deploy.sh

ENVIRONMENT=$1
NEW_TAG=$2

if [ -z "$ENVIRONMENT" ] || [ -z "$NEW_TAG" ]; then
    echo "Usage: $0 <environment> <new_tag>"
    exit 1
fi

# è·å–å½“å‰æ´»è·ƒç¯å¢ƒ
CURRENT_COLOR=$(get_current_active_color $ENVIRONMENT)
if [ "$CURRENT_COLOR" = "blue" ]; then
    NEW_COLOR="green"
else
    NEW_COLOR="blue"
fi

echo "ğŸš€ å¼€å§‹è“ç»¿éƒ¨ç½²: $CURRENT_COLOR -> $NEW_COLOR"

# å¯åŠ¨æ–°ç¯å¢ƒ
echo "å¯åŠ¨ $NEW_COLOR ç¯å¢ƒ..."
docker-compose -f docker-compose.$ENVIRONMENT.$NEW_COLOR.yml pull
docker-compose -f docker-compose.$ENVIRONMENT.$NEW_COLOR.yml up -d

# ç­‰å¾…æ–°ç¯å¢ƒå¯åŠ¨
echo "ç­‰å¾…æ–°ç¯å¢ƒå¯åŠ¨..."
sleep 60

# è¿è¡Œå†’çƒŸæµ‹è¯•
echo "è¿è¡Œå†’çƒŸæµ‹è¯•..."
if run_smoke_tests $NEW_COLOR; then
    echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"

    # åˆ‡æ¢æµé‡
    echo "åˆ‡æ¢æµé‡åˆ° $NEW_COLOR ç¯å¢ƒ..."
    switch_traffic $ENVIRONMENT $NEW_COLOR

    # æ›´æ–°å½“å‰ç¯å¢ƒæ ‡è®°
    update_active_color $ENVIRONMENT $NEW_COLOR

    # åœæ­¢æ—§ç¯å¢ƒ
    echo "åœæ­¢ $CURRENT_COLOR ç¯å¢ƒ..."
    docker-compose -f docker-compose.$ENVIRONMENT.$CURRENT_COLOR.yml down

    echo "ğŸ‰ è“ç»¿éƒ¨ç½²æˆåŠŸå®Œæˆ"

else
    echo "âŒ å†’çƒŸæµ‹è¯•å¤±è´¥"

    # å›æ»šï¼šåœæ­¢æ–°ç¯å¢ƒ
    docker-compose -f docker-compose.$ENVIRONMENT.$NEW_COLOR.yml down

    echo "ğŸ”„ éƒ¨ç½²å·²å›æ»š"
    exit 1
fi
```

#### æµé‡åˆ‡æ¢é…ç½®

```bash
#!/bin/bash
# scripts/switch-traffic.sh

ENVIRONMENT=$1
TARGET_COLOR=$2

case $ENVIRONMENT in
    "production")
        # ä½¿ç”¨Nginx upstreamåˆ‡æ¢
        sed -i "s/server blue/api-$TARGET_COLOR/" /etc/nginx/sites-available/fitness-gym
        sed -i "s/server green/api-$TARGET_COLOR/" /etc/nginx/sites-available/fitness-gym
        systemctl reload nginx
        ;;
    "staging")
        # ä½¿ç”¨Docker serviceæ›´æ–°
        docker service update --image $REGISTRY/$IMAGE_NAME:$TAG api_$TARGET_COLOR
        ;;
    *)
        echo "ä¸æ”¯æŒçš„ç¯å¢ƒ: $ENVIRONMENT"
        exit 1
        ;;
esac

echo "âœ… æµé‡å·²åˆ‡æ¢åˆ° $TARGET_COLOR ç¯å¢ƒ"
```

### 5.2 é‡‘ä¸é›€éƒ¨ç½²

#### é‡‘ä¸é›€éƒ¨ç½²ç­–ç•¥

```bash
#!/bin/bash
# scripts/canary-deploy.sh

ENVIRONMENT=$1
NEW_TAG=$2
CANARY_PERCENTAGE=${3:-10}  # é»˜è®¤10%

echo "ğŸ¦ å¼€å§‹é‡‘ä¸é›€éƒ¨ç½²: $NEW_TAG ($CANARY_PERCENTAGE%)"

# å¯åŠ¨é‡‘ä¸é›€å®ä¾‹
echo "å¯åŠ¨é‡‘ä¸é›€å®ä¾‹..."
docker run -d --name api-canary \
  -e SPRING_PROFILES_ACTIVE=$ENVIRONMENT \
  -e DB_HOST=$DB_HOST \
  -e DB_PASSWORD=$DB_PASSWORD \
  $REGISTRY/$IMAGE_NAME:$NEW_TAG-api

# ç­‰å¾…é‡‘ä¸é›€å¯åŠ¨
sleep 30

# è¿è¡Œé‡‘ä¸é›€æµ‹è¯•
echo "è¿è¡Œé‡‘ä¸é›€æµ‹è¯•..."
if run_canary_tests; then
    echo "âœ… é‡‘ä¸é›€æµ‹è¯•é€šè¿‡"

    # é€æ¸å¢åŠ æµé‡
    echo "é€æ¸å¢åŠ æµé‡åˆ° $CANARY_PERCENTAGE%..."
    update_load_balancer_weights $CANARY_PERCENTAGE

    # ç›‘æ§é‡‘ä¸é›€è¡¨ç°
    echo "ç›‘æ§é‡‘ä¸é›€è¡¨ç° (5åˆ†é’Ÿ)..."
    monitor_canary_performance 300

    # å¦‚æœè¡¨ç°è‰¯å¥½ï¼Œå®Œå…¨åˆ‡æ¢
    echo "é‡‘ä¸é›€è¡¨ç°è‰¯å¥½ï¼Œå¼€å§‹å®Œå…¨éƒ¨ç½²..."
    full_rollout $NEW_TAG

else
    echo "âŒ é‡‘ä¸é›€æµ‹è¯•å¤±è´¥"

    # åœæ­¢é‡‘ä¸é›€å®ä¾‹
    docker stop api-canary
    docker rm api-canary

    echo "ğŸ”„ é‡‘ä¸é›€éƒ¨ç½²å·²ä¸­æ­¢"
    exit 1
fi
```

### 5.3 å›æ»šç­–ç•¥

#### è‡ªåŠ¨å›æ»šæœºåˆ¶

```bash
#!/bin/bash
# scripts/rollback.sh

ENVIRONMENT=$1
REASON=$2

echo "âª å¼€å§‹å›æ»šç¯å¢ƒ: $ENVIRONMENT"
echo "åŸå› : $REASON"

# è·å–ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
PREVIOUS_TAG=$(get_previous_stable_tag $ENVIRONMENT)

if [ -z "$PREVIOUS_TAG" ]; then
    echo "âŒ æœªæ‰¾åˆ°å¯å›æ»šçš„ç‰ˆæœ¬"
    exit 1
fi

echo "å›æ»šåˆ°ç‰ˆæœ¬: $PREVIOUS_TAG"

# æ‰§è¡Œå›æ»šéƒ¨ç½²
if [ "$DEPLOYMENT_STRATEGY" = "blue-green" ]; then
    blue_green_rollback $ENVIRONMENT $PREVIOUS_TAG
elif [ "$DEPLOYMENT_STRATEGY" = "rolling" ]; then
    rolling_rollback $ENVIRONMENT $PREVIOUS_TAG
else
    echo "âŒ ä¸æ”¯æŒçš„éƒ¨ç½²ç­–ç•¥: $DEPLOYMENT_STRATEGY"
    exit 1
fi

# éªŒè¯å›æ»šç»“æœ
if verify_rollback $ENVIRONMENT; then
    echo "âœ… å›æ»šæˆåŠŸå®Œæˆ"

    # å‘é€å›æ»šé€šçŸ¥
    send_rollback_notification "$ENVIRONMENT" "$PREVIOUS_TAG" "$REASON"

else
    echo "âŒ å›æ»šéªŒè¯å¤±è´¥"
    exit 1
fi
```

---

## 6. ç›‘æ§ä¸å‘Šè­¦

### 6.1 æµæ°´çº¿ç›‘æ§

#### æ„å»ºçŠ¶æ€ç›‘æ§

```yaml
- name: Notify build status
  uses: 8398a7/action-slack@v3
  if: always()
  with:
    status: ${{ job.status }}
    channel: '#builds'
    webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

#### æ€§èƒ½æŒ‡æ ‡æ”¶é›†

```yaml
- name: Collect deployment metrics
  run: |
    echo "DEPLOYMENT_DURATION=$(( $(date +%s) - $(cat .deploy_start) ))" >> $GITHUB_ENV
    echo "BUILD_SIZE=$(du -sh . | cut -f1)" >> $GITHUB_ENV

- name: Send metrics to monitoring
  run: |
    curl -X POST ${{ secrets.METRICS_ENDPOINT }} \
      -H "Content-Type: application/json" \
      -d "{
        \"build_id\": \"${{ github.run_id }}\",
        \"duration\": \"${{ env.DEPLOYMENT_DURATION }}\",
        \"size\": \"${{ env.BUILD_SIZE }}\",
        \"status\": \"${{ job.status }}\",
        \"environment\": \"${{ github.ref }}\"
      }"
```

### 6.2 å‘Šè­¦é…ç½®

#### å¤±è´¥é€šçŸ¥

```yaml
- name: Notify on failure
  if: failure()
  run: |
    curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
      -H 'Content-type: application/json' \
      --data "{
        \"channel\": \"#alerts\",
        \"attachments\": [
          {
            \"color\": \"danger\",
            \"title\": \"CI/CD Pipeline Failed\",
            \"text\": \"Workflow: ${{ github.workflow }}\\nBranch: ${{ github.ref }}\\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
            \"fields\": [
              {
                \"title\": \"Triggered by\",
                \"value\": \"${{ github.actor }}\",
                \"short\": true
              },
              {
                \"title\": \"Commit\",
                \"value\": \"${{ github.sha }}\",
                \"short\": true
              }
            ]
          }
        ]
      }"
```

#### æˆåŠŸéƒ¨ç½²é€šçŸ¥

```yaml
- name: Notify successful deployment
  if: success()
  run: |
    curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
      -H 'Content-type: application/json' \
      --data "{
        \"channel\": \"#deployments\",
        \"attachments\": [
          {
            \"color\": \"good\",
            \"title\": \"Deployment Successful\",
            \"text\": \"Environment: ${{ inputs.environment }}\\nVersion: ${{ github.sha }}\\nDuration: ${{ env.DEPLOYMENT_DURATION }}s\",
            \"fields\": [
              {
                \"title\": \"Deployed by\",
                \"value\": \"${{ github.actor }}\",
                \"short\": true
              },
              {
                \"title\": \"Build Size\",
                \"value\": \"${{ env.BUILD_SIZE }}\",
                \"short\": true
              }
            ]
          }
        ]
      }"
```

---

## 7. æ•…éšœæ’æŸ¥

### 7.1 å¸¸è§CI/CDé—®é¢˜

#### æ„å»ºå¤±è´¥æ’æŸ¥

```bash
# æ£€æŸ¥æ„å»ºæ—¥å¿—
gh run view <run-id> --log

# æ£€æŸ¥ç¼“å­˜é—®é¢˜
docker system df
docker system prune -f

# éªŒè¯ç¯å¢ƒå˜é‡
env | grep -E "(NODE|JAVA|MAVEN|DOCKER)_"

# æ£€æŸ¥ç½‘ç»œè¿æ¥
curl -I https://registry.npmjs.org/
curl -I https://repo.maven.apache.org/
```

#### éƒ¨ç½²å¤±è´¥æ’æŸ¥

```bash
# æ£€æŸ¥éƒ¨ç½²æ—¥å¿—
docker-compose logs <service-name>

# éªŒè¯é•œåƒæ‹‰å–
docker pull <image-name>

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker-compose exec <service> env

# éªŒè¯å¥åº·æ£€æŸ¥
curl http://localhost:<port>/health

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
```

#### æµ‹è¯•å¤±è´¥æ’æŸ¥

```bash
# é‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•
npm run test:unit -- --testNamePattern="<test-name>" --verbose

# æ£€æŸ¥æµ‹è¯•æ•°æ®åº“çŠ¶æ€
docker-compose exec database pg_isready

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
open target/site/jacoco/index.html

# è°ƒè¯•E2Eæµ‹è¯•
npx playwright test --headed --debug
```

### 7.2 è°ƒè¯•æŠ€å·§

#### æœ¬åœ°æµæ°´çº¿è°ƒè¯•

```bash
# ä½¿ç”¨actè¿è¡ŒGitHub Actionsæœ¬åœ°åŒ–
act -v --artifact-server-path /tmp/artifacts

# ç‰¹å®šå·¥ä½œæµè°ƒè¯•
act pull_request -v --artifact-server-path /tmp/artifacts

# ä½¿ç”¨ç‰¹å®šäº‹ä»¶
act push --artifact-server-path /tmp/artifacts
```

#### è¿œç¨‹è°ƒè¯•

```bash
# SSHåˆ°è¿è¡Œå™¨
ssh -i ~/.ssh/github_actions user@runner-host

# æŸ¥çœ‹è¿è¡Œå™¨çŠ¶æ€
docker ps
docker logs <container-id>

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h
du -sh /home/runner/work/
```

### 7.3 æ—¥å¿—åˆ†æ

#### æµæ°´çº¿æ—¥å¿—åˆ†æ

```bash
# æå–é”™è¯¯ä¿¡æ¯
gh run view <run-id> --log | grep -i error

# åˆ†ææ„å»ºæ—¶é—´
gh run view <run-id> --log | grep -E "(time|duration)"

# æ£€æŸ¥è­¦å‘Šä¿¡æ¯
gh run view <run-id> --log | grep -i warn
```

#### åº”ç”¨æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—
docker-compose logs --tail=100 api

# å®æ—¶æ—¥å¿—ç›‘æ§
docker-compose logs -f api

# æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤æ—¥å¿—
docker-compose logs --since "2024-01-01T00:00:00" --until "2024-01-01T23:59:59" api
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 æµæ°´çº¿ä¼˜åŒ–

#### å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–

```yaml
# ä¼˜åŒ–ä½œä¸šä¾èµ–å…³ç³»
jobs:
  test-frontend:
    runs-on: ubuntu-latest
  test-backend:
    runs-on: ubuntu-latest
  test-integration:
    needs: [test-frontend, test-backend]
    runs-on: ubuntu-latest

# ä½¿ç”¨çŸ©é˜µç­–ç•¥å¹¶è¡Œæµ‹è¯•
test-matrix:
  strategy:
    matrix:
      node-version: [16, 18, 20]
      os: [ubuntu-latest, windows-latest]
  runs-on: ${{ matrix.os }}
  steps:
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
```

#### ç¼“å­˜ç­–ç•¥

```yaml
# å¤šå±‚ç¼“å­˜ç­–ç•¥
- name: Cache multiple paths
  uses: actions/cache@v3
  with:
    path: |
      ~/.npm
      ~/.m2/repository
      ~/.cache/pip
      /tmp/.buildx-cache
    key: ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json', '**/pom.xml') }}
    restore-keys: |
      ${{ runner.os }}-build-
      ${{ runner.os }}-
```

#### æ¡ä»¶æ‰§è¡Œä¼˜åŒ–

```yaml
# åŸºäºæ–‡ä»¶å˜åŒ–çš„æ¡ä»¶æ‰§è¡Œ
on:
  push:
    paths:
      - 'src/main/resources/front/**'
      - '.github/workflows/frontend.yml'

# è·³è¿‡æœªæ›´æ”¹çš„ä½œä¸š
jobs:
  frontend-tests:
    if: contains(github.event.head_commit.modified, 'src/main/resources/front/')
    steps: [...]

  backend-tests:
    if: contains(github.event.head_commit.modified, 'src/main/java/')
    steps: [...]
```

### 8.2 å®‰å…¨æœ€ä½³å®è·µ

#### å¯†é’¥ç®¡ç†

```yaml
# ä½¿ç”¨ç¯å¢ƒç‰¹å®šçš„å¯†é’¥
- name: Deploy to production
  environment: production
  env:
    API_KEY: ${{ secrets.PROD_API_KEY }}
    DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}

# å¯†é’¥è½®æ¢
- name: Rotate secrets
  run: |
    # ç”Ÿæˆæ–°å¯†é’¥
    NEW_SECRET=$(openssl rand -hex 32)
    # æ›´æ–°å¯†é’¥å­˜å‚¨
    # é‡æ–°éƒ¨ç½²æœåŠ¡
```

#### é•œåƒå®‰å…¨

```yaml
# ä½¿ç”¨å®˜æ–¹åŸºç¡€é•œåƒ
FROM node:18-alpine
FROM openjdk:21-slim

# å¤šé˜¶æ®µæ„å»º
FROM node:18-alpine AS builder
# æ„å»ºé˜¶æ®µ

FROM nginx:alpine AS production
# ç”Ÿäº§é•œåƒ
```

### 8.3 å¯è§‚æµ‹æ€§

#### æµæ°´çº¿æŒ‡æ ‡

```yaml
- name: Collect pipeline metrics
  run: |
    echo "PIPELINE_METRICS={\"run_id\":\"${{ github.run_id }}\",\"duration\":$(( $(date +%s) - $(cat .pipeline_start) )),\"status\":\"${{ job.status }}\",\"jobs\":${{ toJSON(job.status) }}}" >> $GITHUB_OUTPUT

- name: Send to monitoring
  run: |
    curl -X POST ${{ secrets.METRICS_ENDPOINT }} \
      -H "Authorization: Bearer ${{ secrets.METRICS_TOKEN }}" \
      -H "Content-Type: application/json" \
      -d "${{ steps.metrics.outputs.PIPELINE_METRICS }}"
```

#### æ€§èƒ½ç›‘æ§

```yaml
# æµæ°´çº¿æ€§èƒ½ç›‘æ§
- name: Performance monitoring
  run: |
    # è®°å½•å…³é”®æ—¶é—´ç‚¹
    echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

- name: Report performance
  if: always()
  run: |
    BUILD_DURATION=$(( $(date +%s) - ${{ env.BUILD_START }} ))
    echo "Build duration: ${BUILD_DURATION}s"

    # å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    curl -X POST ${{ secrets.METRICS_ENDPOINT }}/performance \
      -H "Content-Type: application/json" \
      -d "{\"build_duration\":${BUILD_DURATION},\"job\":\"${{ github.job }}\"}"
```

### 8.4 ç»´æŠ¤ä¸æ›´æ–°

#### æµæ°´çº¿ç»´æŠ¤

```yaml
# å®šæœŸæ›´æ–°ä¾èµ–
- name: Update dependencies
  run: |
    npm update
    mvn versions:use-latest-releases

# æµæ°´çº¿å¥åº·æ£€æŸ¥
- name: Pipeline health check
  run: |
    # æ£€æŸ¥å·¥ä½œæµè¯­æ³•
    actionlint

    # éªŒè¯é…ç½®æ–‡ä»¶
    yamllint .github/workflows/*.yml
```

#### ç‰ˆæœ¬ç®¡ç†

```yaml
# è‡ªåŠ¨ç‰ˆæœ¬å·ç”Ÿæˆ
- name: Generate version
  run: |
    if [[ $GITHUB_REF == refs/tags/* ]]; then
        VERSION=${GITHUB_REF#refs/tags/}
    else
        VERSION="${GITHUB_SHA:0:8}"
    fi
    echo "VERSION=$VERSION" >> $GITHUB_ENV

# ç‰ˆæœ¬æ ‡ç­¾ç®¡ç†
- name: Create release tag
  if: github.ref == 'refs/heads/main'
  run: |
    git tag "v$(date +%Y%m%d.%H%M%S)"
    git push origin --tags
```

é€šè¿‡å®æ–½è¿™äº›CI/CDæœ€ä½³å®è·µï¼Œå¯ä»¥ç¡®ä¿ï¼š

- **é«˜è´¨é‡ä»£ç äº¤ä»˜**: è‡ªåŠ¨åŒ–æµ‹è¯•å’Œä»£ç æ£€æŸ¥
- **å¿«é€Ÿåé¦ˆ**: å¹¶è¡Œæ‰§è¡Œå’Œç¼“å­˜ä¼˜åŒ–
- **å®‰å…¨å¯é **: å®‰å…¨æ‰«æå’Œå¯†é’¥ç®¡ç†
- **å¯è§‚æµ‹æ€§**: å…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦
- **æŒç»­æ”¹è¿›**: æ€§èƒ½ç›‘æ§å’Œå®šæœŸç»´æŠ¤

è¿™å¥—CI/CDç³»ç»Ÿä¸ºå¥èº«æˆ¿ç®¡ç†ç³»ç»Ÿæä¾›äº†ä¼ä¸šçº§çš„DevOpsèƒ½åŠ›ï¼Œæ”¯æŒä»å¼€å‘åˆ°ç”Ÿäº§çš„å®Œæ•´è½¯ä»¶äº¤ä»˜æµç¨‹ã€‚

---

*æœ€åæ›´æ–°: 2025-11-16*  
*ç‰ˆæœ¬: v1.0*  
*ç»´æŠ¤è€…: DevOpså›¢é˜Ÿ*
