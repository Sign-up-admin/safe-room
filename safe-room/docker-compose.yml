# Docker Compose configuration
# Note: To use BuildKit for building, set environment variables:
#   Windows PowerShell: $env:DOCKER_BUILDKIT = "1"; $env:COMPOSE_DOCKER_CLI_BUILD = "1"
#   Linux/Mac: export DOCKER_BUILDKIT=1; export COMPOSE_DOCKER_CLI_BUILD=1
# Or use the provided build scripts: .\docker-build.ps1 or ./docker-build.sh

services:
  backend:
    build:
      context: ./springboot1ngh61a2
      dockerfile: Dockerfile
      # BuildKit cache mounts are configured in Dockerfile
      # When using BuildKit, Maven and NPM dependencies will be cached, significantly speeding up builds
    image: fitness_gym_backend:latest
    container_name: fitness_gym_backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: ${SERVER_PORT:-8080}
      DB_HOST: postgres
      DB_PORT: ${POSTGRES_PORT:-5432}
      DB_NAME: ${POSTGRES_DB:-fitness_gym}
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DB_POOL_MIN_IDLE: ${DB_POOL_MIN_IDLE:-10}
      DB_POOL_MAX_SIZE: ${DB_POOL_MAX_SIZE:-50}
      MINIO_ENABLED: ${MINIO_ENABLED:-false}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-fitness-gym}
      MINIO_SECURE: ${MINIO_SECURE:-false}
      MINIO_PRESIGNED_URL_EXPIRY: ${MINIO_PRESIGNED_URL_EXPIRY:-3600}
      LOG_PATH: /app/logs
      JAVA_OPTS: ${JAVA_OPTS:--Xmx512m -Xms256m}
      TZ: ${TZ:-Asia/Shanghai}
    ports:
      - "${SERVER_PORT:-8080}:8080"
    volumes:
      - backend_logs:/app/logs
      - upload_data:/app/static/upload
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/springboot1ngh61a2/user/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - fitness_gym_network

  postgres:
    image: postgres:16-alpine
    container_name: fitness_gym_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-fitness_gym}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      TZ: ${TZ:-Asia/Shanghai}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./springboot1ngh61a2/src/main/resources/schema-postgresql.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./springboot1ngh61a2/src/main/resources/data.sql:/docker-entrypoint-initdb.d/02-data.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-fitness_gym}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - fitness_gym_network

  minio:
    image: minio/minio:latest
    container_name: fitness_gym_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
      TZ: ${TZ:-Asia/Shanghai}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - fitness_gym_network

  # 前端E2E测试服务 - 用户端
  front-e2e:
    build:
      context: ./springboot1ngh61a2/src/main/resources/front/front
      dockerfile: Dockerfile.e2e
    container_name: fitness_gym_front_e2e
    profiles:
      - e2e
    environment:
      # 后端API地址（由用户控制，默认连接到宿主机）
      BACKEND_URL: ${BACKEND_URL:-http://host.docker.internal:8080}
      # 前端地址（如果前端也在宿主机运行）
      E2E_BASE_URL: ${FRONT_E2E_BASE_URL:-http://host.docker.internal:8082}
      E2E_NO_SERVER: "true"
      CI: "true"
    volumes:
      # 挂载测试报告目录
      - ./test-reports/front:/app/playwright-report
    extra_hosts:
      # 支持Linux/Mac/Windows Docker Desktop访问宿主机
      - "host.docker.internal:host-gateway"
    networks:
      - fitness_gym_network
    # 不自动重启，测试完成后退出
    restart: "no"

  # 前端E2E测试服务 - 管理端
  admin-e2e:
    build:
      context: ./springboot1ngh61a2/src/main/resources/admin/admin
      dockerfile: Dockerfile.e2e
    container_name: fitness_gym_admin_e2e
    profiles:
      - e2e
    environment:
      # 后端API地址（由用户控制，默认连接到宿主机）
      BACKEND_URL: ${BACKEND_URL:-http://host.docker.internal:8080}
      # 管理端前端地址（如果前端也在宿主机运行）
      FRONTEND_URL: ${ADMIN_E2E_BASE_URL:-http://host.docker.internal:5173}
      CI: "true"
    volumes:
      # 挂载测试报告目录
      - ./test-reports/admin:/app/playwright-report
    extra_hosts:
      # 支持Linux/Mac/Windows Docker Desktop访问宿主机
      - "host.docker.internal:host-gateway"
    networks:
      - fitness_gym_network
    # 不自动重启，测试完成后退出
    restart: "no"

volumes:
  postgres_data:
    driver: local
  backend_logs:
    driver: local
  upload_data:
    driver: local
  minio_data:
    driver: local

networks:
  fitness_gym_network:
    driver: bridge
