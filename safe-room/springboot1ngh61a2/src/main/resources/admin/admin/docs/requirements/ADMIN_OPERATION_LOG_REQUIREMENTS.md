# 操作日志模块需求文档（Operation Log v1.0）

> 版本：v1.0
> 更新日期：2025-11-15（计划日期）
> 适用路由：`/operation-log`
> 关联组件：`src/views/modules/operation-log/list.vue`
> 继承组件：`ModuleCrudPage.vue`

---

## 0. 设计关键词

审计追踪 · 操作记录 · 安全监控 · 日志分析 · 行为分析

---

## 1. 模块概述

操作日志模块是系统安全审计的核心模块，负责记录所有管理员和用户的关键操作，为系统安全监控、问题排查和合规审计提供数据支撑。

### 1.1 业务价值

- **安全审计**：追踪所有敏感操作，防止数据泄露
- **问题排查**：通过操作日志快速定位问题原因
- **行为分析**：分析用户操作习惯和系统使用情况
- **合规要求**：满足监管部门的审计要求
- **风险控制**：及时发现和阻止异常操作

---

## 2. 功能需求

### 2.1 基础功能（继承 ModuleCrudPage）

- ✅ **日志列表**：分页展示操作日志
- ✅ **日志搜索**：支持多条件组合搜索
- ✅ **日志详情**：查看完整的操作详情
- ✅ **日志导出**：支持日志数据导出
- ⛔ **日志编辑**：日志记录不允许修改
- ⛔ **日志删除**：重要日志不允许删除（可设置保留策略）

### 2.2 日志记录范围

| 操作类型 | 记录范围 | 敏感等级 |
| --- | --- | --- |
| 用户管理 | 新增/编辑/删除用户 | 高 |
| 课程管理 | 课程安排、价格调整 | 中 |
| 预约管理 | 预约确认、取消操作 | 中 |
| 财务操作 | 退款、价格修改 | 高 |
| 系统配置 | 配置参数修改 | 高 |
| 权限管理 | 角色权限变更 | 高 |
| 登录操作 | 登录成功/失败记录 | 中 |

### 2.3 日志分析功能

| 功能 | 说明 | 应用场景 |
| --- | --- | --- |
| 操作统计 | 统计各类操作的数量和频率 | 识别异常操作模式 |
| 用户行为分析 | 分析特定用户的操作习惯 | 识别内部威胁 |
| 时间趋势分析 | 显示操作数量的时间趋势 | 识别业务高峰期 |
| 错误操作统计 | 统计失败操作和错误类型 | 优化系统稳定性 |
| 地理位置分析 | 基于IP分析操作地理分布 | 识别异常登录 |

---

## 3. 数据字段定义

### 3.1 核心字段

| 字段名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `id` | number | 系统生成 | 日志记录唯一标识 |
| `username` | text | ✅ | 操作用户名 |
| `operation` | text | ✅ | 操作类型（如：LOGIN, CREATE_USER） |
| `method` | text | ✅ | 请求方法（GET/POST/PUT/DELETE） |
| `url` | text | ✅ | 请求URL路径 |
| `ip` | text | ✅ | 操作者IP地址 |
| `location` | text | - | IP地理位置（城市） |
| `status` | number | ✅ | 操作结果状态码 |
| `error_message` | textarea | - | 错误信息（失败时填写） |
| `params` | text | - | 请求参数（脱敏处理） |
| `result` | text | - | 操作结果摘要 |
| `create_time` | datetime | 系统生成 | 操作时间 |
| `duration` | number | - | 操作耗时（毫秒） |

### 3.2 扩展字段

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| `user_agent` | text | 浏览器User-Agent |
| `session_id` | text | 会话ID |
| `business_id` | text | 关联业务ID（如用户ID、课程ID） |
| `business_type` | text | 业务类型（如user, course, booking） |
| `old_value` | text | 修改前的值 |
| `new_value` | text | 修改后的值 |
| `risk_level` | select | 风险等级（low/medium/high） |

---

## 4. 日志记录策略

### 4.1 记录触发点

| 触发场景 | 记录策略 | 保留原因 |
| --- | --- | --- |
| 用户登录 | 每次登录都记录 | 安全审计要求 |
| 数据修改 | 重要数据变更记录 | 数据完整性保障 |
| 权限操作 | 权限变更记录 | 权限安全控制 |
| 批量操作 | 批量操作记录总数和结果 | 操作可追溯性 |
| 敏感操作 | 密码修改、删除操作等 | 安全合规要求 |
| 系统异常 | 错误操作和异常情况 | 问题排查需要 |

### 4.2 数据脱敏策略

| 数据类型 | 脱敏规则 | 示例 |
| --- | --- | --- |
| 密码字段 | 完全脱敏 | `password: "***"` |
| 身份证号 | 显示前6后4位 | `110101********1234` |
| 手机号 | 显示前3后4位 | `138****0000` |
| 邮箱地址 | 隐藏用户名部分 | `a****@example.com` |
| 银行卡号 | 显示前6后4位 | `622588********1234` |

### 4.3 日志保留策略

| 日志类型 | 保留期限 | 存储策略 |
| --- | --- | --- |
| 普通操作日志 | 1年 | 数据库存储 |
| 安全敏感日志 | 3年 | 数据库存储 + 归档 |
| 系统异常日志 | 6个月 | 数据库存储 |
| 审计合规日志 | 5年 | 专用审计数据库 |
| 临时调试日志 | 7天 | 可自动清理 |

---

## 5. 用户界面设计

### 5.1 日志列表页面

```
筛选条件区域：
├── 时间范围：[日期选择器] 至 [日期选择器]
├── 操作类型：[下拉选择] 全部/登录/修改/删除
├── 操作用户：[输入框] 用户名搜索
├── IP地址：[输入框] IP搜索
└── 操作结果：[选择] 全部/成功/失败

日志列表：
├── 时间 | 用户 | 操作类型 | IP | 状态 | 详情
├── 2025-01-15 10:30:25 | admin | LOGIN | 192.168.1.100 | 成功 | 查看
├── 2025-01-15 10:31:10 | admin | UPDATE_USER | 192.168.1.100 | 成功 | 查看
└── 2025-01-15 10:32:05 | admin | DELETE_COURSE | 192.168.1.100 | 失败 | 查看
```

### 5.2 日志详情弹窗

```
操作详情：
├── 基本信息
│   ├── 操作ID: 12345
│   ├── 操作时间: 2025-01-15 10:30:25
│   ├── 操作用户: admin
│   ├── 用户IP: 192.168.1.100
│   └── 地理位置: 北京
├── 操作信息
│   ├── 请求方法: POST
│   ├── 请求路径: /user/update
│   ├── 操作类型: UPDATE_USER
│   └── 耗时: 150ms
├── 请求参数
│   └── {
│       "id": 1001,
│       "name": "张三",
│       "phone": "138****0000"
│     }
└── 操作结果
    └── 修改成功，用户ID: 1001
```

### 5.3 日志统计图表

```
统计图表区域：
├── 操作类型分布饼图
├── 每日操作数量趋势图
├── 操作结果统计柱状图
└── 活跃用户排行榜
```

---

## 6. 权限控制

| 权限 | 说明 | 适用角色 |
| --- | --- | --- |
| `operation-log:list` | 查看操作日志 | 管理员 |
| `operation-log:view` | 查看日志详情 | 管理员 |
| `operation-log:export` | 导出日志数据 | 管理员 |
| `operation-log:delete` | 删除日志记录 | 超级管理员（谨慎权限） |
| `operation-log:statistics` | 查看日志统计 | 管理员 |
| `operation-log:audit` | 审计日志分析 | 审计员 |

---

## 7. 接口定义

### 7.1 基础查询接口

```typescript
GET    /operation-log/page          // 分页查询日志
GET    /operation-log/info/{id}     // 日志详情
POST   /operation-log/export        // 导出日志
```

### 7.2 统计分析接口

```typescript
GET    /operation-log/statistics/operation-type    // 操作类型统计
GET    /operation-log/statistics/daily-trend       // 每日趋势统计
GET    /operation-log/statistics/user-activity     // 用户活跃度统计
GET    /operation-log/statistics/risk-analysis     // 风险分析统计
```

### 7.3 审计接口

```typescript
POST   /operation-log/audit-report               // 生成审计报告
GET    /operation-log/suspicious-activities      // 可疑活动检测
POST   /operation-log/archive                     // 日志归档
```

---

## 8. 安全监控功能

### 8.1 实时监控

| 监控类型 | 触发条件 | 响应措施 |
| --- | --- | --- |
| 异常登录 | 异地登录、异常时间登录 | 发送告警通知 |
| 批量操作 | 短时间内大量相同操作 | 临时限制操作权限 |
| 敏感操作 | 删除重要数据、修改权限 | 要求二次确认 |
| 高频失败 | 连续多次操作失败 | 临时锁定账号 |

### 8.2 告警规则

| 告警类型 | 阈值设置 | 通知方式 |
| --- | --- | --- |
| 登录失败 | 5次/小时 | 邮件+短信 |
| 异常操作 | 自定义规则 | 邮件+系统消息 |
| 系统异常 | 错误率>5% | 邮件+电话 |
| 数据异常 | 数据完整性检查失败 | 邮件+系统告警 |

---

## 9. 性能优化策略

### 9.1 存储优化

- **分表存储**：按月分表存储历史日志
- **索引优化**：为常用查询字段建立索引
- **压缩存储**：对历史日志进行压缩存储
- **归档策略**：定期将旧日志归档到专用存储

### 9.2 查询优化

- **分页查询**：强制分页，限制单次查询数量
- **缓存策略**：对统计数据进行缓存
- **异步处理**：日志写入采用异步方式
- **读写分离**：日志查询和写入分离

---

## 10. 验收标准

### 10.1 功能验收

| 验收项 | 标准 | 优先级 |
| --- | --- | --- |
| 日志记录 | 所有关键操作都被正确记录 | 高 |
| 日志查询 | 支持多条件组合查询和分页 | 高 |
| 数据脱敏 | 敏感信息正确脱敏处理 | 高 |
| 统计分析 | 提供准确的统计图表和分析 | 中 |
| 安全监控 | 异常操作能够被及时发现 | 高 |
| 性能表现 | 大数据量下的查询性能满足要求 | 中 |

### 10.2 性能验收

- **日志写入**：≤ 100ms（异步写入）
- **日志查询**：≤ 2秒（10万条数据分页查询）
- **统计计算**：≤ 5秒（复杂统计分析）
- **导出性能**：≤ 30秒（1万条数据导出）

### 10.3 安全验收

- **数据完整性**：日志记录不可篡改
- **访问控制**：只有授权用户能查看日志
- **审计追溯**：所有操作都有完整记录
- **合规性**：满足相关法规要求

---

## 11. 后续扩展

- [ ] **AI异常检测**：使用AI识别异常操作模式
- [ ] **实时告警**：支持实时监控和即时告警
- [ ] **日志关联分析**：分析操作间的关联关系
- [ ] **用户行为画像**：基于日志建立用户行为模型
- [ ] **区块链存证**：重要操作上链存证
- [ ] **多租户隔离**：支持多租户环境的日志隔离

---

## 12. 相关文档

- [安全需求文档](./ADMIN_SECURITY_REQUIREMENTS.md)
- [权限管理文档](./ADMIN_PERMISSION_MANAGEMENT.md)
- [系统监控文档](./ADMIN_SYSTEM_MONITORING.md)

---***
